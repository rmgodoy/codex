"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4580],{4580:(e,s,t)=>{t.r(s),t.d(s,{default:()=>X});var n=t(95155),l=t(12115),a=t(6195),r=t(20031),i=t(34239),c=t(62523),o=t(30285),d=t(66424),u=t(22346),m=t(87481),x=t(34301),h=t(75074),j=t(9572),p=t(20203),g=t(73926),f=t(85057),v=t(59409),N=t(90648),b=t(8643);function y(e){let{onSelectEncounter:s,onNewEncounter:t,selectedEncounterId:a,dataVersion:r,filters:y,setFilters:w,onClearFilters:T}=e,[C,R]=(0,l.useState)([]),[S,I]=(0,l.useState)([]),[E,M]=(0,l.useState)(!0),{toast:k}=(0,m.dj)();(0,l.useEffect)(()=>{(async()=>{M(!0);try{let[e,s]=await Promise.all([(0,i.eS)(),(0,i.MY)()]);R(e),I(s)}catch(e){console.error("Error fetching encounters:",e),k({variant:"destructive",title:"Error",description:"Could not fetch encounters from database."})}finally{M(!1)}})()},[r,k]);let z=(0,l.useMemo)(()=>{let e=C.map(e=>{if(e.encounterTableId){let s=S.find(s=>s.id===e.encounterTableId);return{...e,totalTR:(null==s?void 0:s.totalTR)||e.totalTR||0}}return{...e,totalTR:e.totalTR||0}}).filter(e=>{let s=e.name.toLowerCase().includes(y.searchTerm.toLowerCase()),t=!0,n=y.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);n.length>0&&(t=!!e.tags&&n.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))));let l=!0;return y.minTR&&!isNaN(parseInt(y.minTR))&&(l=l&&e.totalTR>=parseInt(y.minTR,10)),y.maxTR&&!isNaN(parseInt(y.maxTR))&&(l=l&&e.totalTR<=parseInt(y.maxTR,10)),s&&t&&l}).sort((e,s)=>{if("TR"===y.sortBy){var t,n;let l=(null!=(t=e.totalTR)?t:0)-(null!=(n=s.totalTR)?n:0);if(0!==l)return l}return e.name.localeCompare(s.name)});return"desc"===y.sortOrder&&e.reverse(),e},[C,S,y]);return(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsxs)("div",{className:"p-4 space-y-4",children:[(0,n.jsxs)(o.$,{onClick:t,className:"w-full",children:[(0,n.jsx)(x.A,{})," New Encounter"]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(h.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,n.jsx)(c.p,{placeholder:"Search encounters...",value:y.searchTerm,onChange:e=>w.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,n.jsxs)(b.Nt,{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)(b.R6,{asChild:!0,children:(0,n.jsxs)(o.$,{variant:"ghost",className:"-ml-2",children:[(0,n.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"Filters"]})}),(0,n.jsx)(o.$,{variant:"ghost",size:"sm",onClick:T,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,n.jsxs)(b.Ke,{className:"space-y-2 pt-2",children:[(0,n.jsx)(N.F,{value:y.tagFilter?y.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>w.setTagFilter(e.join(",")),placeholder:"Tags (e.g. boss-fight)",tagSource:"encounter"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min TR",type:"number",value:y.minTR,onChange:e=>w.setMinTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),(0,n.jsx)(c.p,{placeholder:"Max TR",type:"number",value:y.maxTR,onChange:e=>w.setMaxTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)(f.J,{children:"Sort by"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)(v.l6,{value:y.sortBy,onValueChange:e=>w.setSortBy(e),children:[(0,n.jsx)(v.bq,{children:(0,n.jsx)(v.yv,{placeholder:"Sort by"})}),(0,n.jsxs)(v.gC,{children:[(0,n.jsx)(v.eb,{value:"name",children:"Name"}),(0,n.jsx)(v.eb,{value:"TR",children:"TR"})]})]}),(0,n.jsxs)(o.$,{variant:"ghost",size:"icon",onClick:()=>w.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===y.sortOrder?(0,n.jsx)(p.A,{className:"h-4 w-4"}):(0,n.jsx)(g.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,n.jsx)(u.w,{}),(0,n.jsx)(d.F,{className:"flex-1",children:(0,n.jsx)("div",{className:"p-4",children:E?(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading encounters..."}):z.length>0?(0,n.jsx)("ul",{className:"space-y-1",children:z.map(e=>(0,n.jsx)("li",{children:(0,n.jsxs)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(a===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.totalTR,")"]})]})},e.id))}):(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"No encounters found."})})})]})}var w=t(62177),T=t(90221),C=t(55594),R=t(76762),S=t(38914),I=t(66695),E=t(88539),M=t(90010),k=t(17759),z=t(73503),A=t(12543),F=t(21816),B=t(18763),$=t(91721),L=t(77223),G=t(25318),V=t(53054),q=t(13896),J=t(68856),O=t(54165),D=t(26126),P=t(47906);let Z=C.z.object({id:C.z.string(),name:C.z.string().min(1,"Player name is required")}),U=C.z.object({monsterId:C.z.string(),quantity:C.z.coerce.number().min(1,"Quantity must be at least 1")}),W=C.z.object({name:C.z.string().min(1,"Encounter name is required"),sceneDescription:C.z.string().optional(),gmNotes:C.z.string().optional(),players:C.z.array(Z),monsterGroups:C.z.array(U),tags:C.z.array(C.z.string()).optional(),totalTR:C.z.coerce.number().optional(),encounterTableId:C.z.string().optional()}),_=["Normal","Underling","Paragon","Tyrant"],Y=e=>{let{onAddCreatures:s}=e,[t,a]=(0,l.useState)(!1),[r,u]=(0,l.useState)([]),[m,x]=(0,l.useState)(new Map),[h,j]=(0,l.useState)(""),[p,g]=(0,l.useState)(""),[f,b]=(0,l.useState)(""),[y,w]=(0,l.useState)(""),[T,C]=(0,l.useState)(""),[S,I]=(0,l.useState)("all"),[E,M]=(0,l.useState)("all"),[k,A]=(0,l.useState)("");(0,l.useEffect)(()=>{t&&(0,i.OG)().then(u)},[t]);let F=(0,l.useMemo)(()=>r.filter(e=>{let s=e.name.toLowerCase().includes(h.toLowerCase()),t="all"===S||e.role===S,n="all"===E||e.template===E,l=!0;p&&!isNaN(parseInt(p))&&(l=l&&e.TR>=parseInt(p,10)),f&&!isNaN(parseInt(f))&&(l=l&&e.TR<=parseInt(f,10));let a=!0;y&&!isNaN(parseInt(y))&&(a=a&&e.level>=parseInt(y,10)),T&&!isNaN(parseInt(T))&&(a=a&&e.level<=parseInt(T,10));let r=!0;if(k){let s=k.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);s.length>0&&(r=!!e.tags&&e.tags.length>0&&s.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))))}return s&&t&&n&&l&&a&&r}),[r,h,p,f,y,T,S,E,k]),B=(e,s)=>{s>=1?x(t=>{let n=new Map(t);return n.set(e,s),n}):x(s=>{let t=new Map(s);return t.delete(e),t})},$=async()=>{let e=Array.from(m.entries()).map(e=>{let[s,t]=e,n=r.find(e=>e.id===s);return{id:s,name:n.name,quantity:t}});e.length>0&&s(e),a(!1),x(new Map),j(""),w(""),C(""),g(""),b(""),I("all"),M("all"),A("")};return(0,n.jsxs)(O.lG,{open:t,onOpenChange:a,children:[(0,n.jsx)(O.zM,{asChild:!0,children:(0,n.jsxs)(o.$,{type:"button",size:"sm",variant:"outline",children:[(0,n.jsx)(z.A,{className:"h-4 w-4 mr-2"})," Add Monster"]})}),(0,n.jsxs)(O.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,n.jsx)(O.c7,{children:(0,n.jsx)(O.L3,{children:"Select Monsters from Bestiary"})}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(c.p,{placeholder:"Search monsters...",value:h,onChange:e=>j(e.target.value),className:"shrink-0"}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsxs)(v.l6,{value:S,onValueChange:I,children:[(0,n.jsx)(v.bq,{children:(0,n.jsx)(v.yv,{placeholder:"Filter by role"})}),(0,n.jsxs)(v.gC,{children:[(0,n.jsx)(v.eb,{value:"all",children:"All Roles"}),R.gg.map(e=>(0,n.jsx)(v.eb,{value:e,children:e},e))]})]}),(0,n.jsxs)(v.l6,{value:E,onValueChange:M,children:[(0,n.jsx)(v.bq,{children:(0,n.jsx)(v.yv,{placeholder:"Filter by template"})}),(0,n.jsxs)(v.gC,{children:[(0,n.jsx)(v.eb,{value:"all",children:"All Templates"}),_.map(e=>(0,n.jsx)(v.eb,{value:e,children:e},e))]})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min Lvl",type:"number",value:y,onChange:e=>w(e.target.value)}),(0,n.jsx)(c.p,{placeholder:"Max Lvl",type:"number",value:T,onChange:e=>C(e.target.value)})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min TR",type:"number",value:p,onChange:e=>g(e.target.value)}),(0,n.jsx)(c.p,{placeholder:"Max TR",type:"number",value:f,onChange:e=>b(e.target.value)})]}),(0,n.jsx)(N.F,{value:k?k.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>A(e.join(",")),placeholder:"Filter by tags...",tagSource:"creature"})]}),(0,n.jsx)(d.F,{className:"flex-1 border rounded-md p-2 mt-2",children:(0,n.jsx)("div",{className:"space-y-1",children:F.length>0?F.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,n.jsx)(c.p,{type:"number",min:"0",value:m.get(e.id)||0,onChange:s=>B(e.id,parseInt(s.target.value)||0),className:"w-20 h-8"}),(0,n.jsx)("label",{htmlFor:"creature-".concat(e.id),className:"flex-1",children:(0,n.jsxs)("p",{className:"font-semibold",children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(Lvl ",e.level,", TR ",e.TR,")"]})]})})]},e.id)):(0,n.jsx)("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No monsters found."})})}),(0,n.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,n.jsx)(o.$,{variant:"ghost",onClick:()=>a(!1),children:"Cancel"}),(0,n.jsx)(o.$,{onClick:$,disabled:0===m.size,children:"Add Selected"})]})]})]})},K={name:"",sceneDescription:"",gmNotes:"",players:[],monsterGroups:[],tags:[],totalTR:0,encounterTableId:"none"};function Q(e){let{encounterId:s,isCreatingNew:t,onEncounterSaveSuccess:a,onEncounterDeleteSuccess:r,onEditCancel:d,onRunEncounter:x,onFilterByClick:h,onBack:j,dataVersion:p}=e,{toast:g}=(0,m.dj)(),[b,y]=(0,l.useState)(t),[C,R]=(0,l.useState)(!t&&!!s),[O,Z]=(0,l.useState)(null),U=(0,P.a)(),{worldSlug:_}=(0,S.q)(),[Q,H]=(0,l.useState)({monsters:new Map}),[X,ee]=(0,l.useState)([]),[es,et]=(0,l.useState)([]),en=(0,w.mN)({resolver:(0,T.u)(W),defaultValues:K}),{fields:el,append:ea,remove:er}=(0,w.jz)({control:en.control,name:"players"}),{fields:ei,append:ec,remove:eo,update:ed,replace:eu}=(0,w.jz)({control:en.control,name:"monsterGroups"}),em=(0,l.useMemo)(()=>new Map(X.map(e=>[e.id,e.TR])),[X]),ex=en.watch("encounterTableId"),eh=JSON.stringify(en.watch("monsterGroups"));(0,l.useEffect)(()=>{if(ex&&"none"!==ex){let e=es.find(e=>e.id===ex);e&&e.totalTR!==en.getValues("totalTR")&&en.setValue("totalTR",e.totalTR),en.getValues("monsterGroups").length>0&&eu([])}else{let e=JSON.parse(eh).reduce((e,s)=>e+(em.get(s.monsterId)||0)*s.quantity,0);e!==en.getValues("totalTR")&&en.setValue("totalTR",e)}},[eh,ex,es,em,en,eu]);let ej=(0,l.useCallback)(async()=>{if(t){en.reset(K),Z(null),y(!0),R(!1);let[e,s]=await Promise.all([(0,i.MY)(),(0,i.OG)()]);et(e),ee(s);return}if(!s){y(!1),R(!1),Z(null);return}R(!0),y(!1);try{let[e,t,n]=await Promise.all([(0,i.eq)(s),(0,i.MY)(),(0,i.OG)()]);if(et(t),ee(n),e){let s,l=e.totalTR||0;e.encounterTableId&&(s=t.find(s=>s.id===e.encounterTableId))&&(l=s.totalTR);let a={...e,totalTR:l};Z(a);let r={...e,tags:e.tags||[],encounterTableId:e.encounterTableId||"none",totalTR:l};en.reset(r);let i=(e.monsterGroups||[]).map(e=>e.monsterId),c=n.filter(e=>i.includes(e.id)),o=new Map(c.map(e=>[e.id,e]));H({monsters:o,table:s})}else Z(null)}catch(e){g({variant:"destructive",title:"Error",description:"Could not load encounter data."})}finally{R(!1)}},[s,t,en,g]);(0,l.useEffect)(()=>(ej(),window.addEventListener("focus",ej),()=>window.removeEventListener("focus",ej)),[ej,p]);let ep=(0,l.useMemo)(()=>new Map(X.map(e=>[e.id,e])),[X]),eg=()=>{if(t)d();else if(O){let e={...O,tags:O.tags||[],encounterTableId:O.encounterTableId||"none"};en.reset(e),y(!1)}},ef=async e=>{try{let n,l="none"===e.encounterTableId?void 0:e.encounterTableId,r={...e,tags:e.tags||[],totalTR:e.totalTR,encounterTableId:l,monsterGroups:l?[]:e.monsterGroups},c=e.tags||[];if(c.length>0&&await (0,i.JE)(c,"encounter"),t)n=await (0,i.Fs)(r),g({title:"Encounter Created!",description:"".concat(e.name," has been saved.")});else{if(!s)return;n=s,await (0,i.H$)({...r,id:s}),g({title:"Save Successful",description:"".concat(e.name," has been updated.")})}a(n),y(!1)}catch(e){g({variant:"destructive",title:"Save Failed",description:"Could not save changes."})}},ev=async()=>{if(s)try{await (0,i.ZJ)(s),g({title:"Encounter Deleted",description:"The encounter has been removed."}),r()}catch(e){g({variant:"destructive",title:"Deletion Failed",description:"Could not delete the encounter."})}};if(C)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(I.Zp,{children:[(0,n.jsx)(I.aR,{children:(0,n.jsx)(J.E,{className:"h-8 w-48"})}),(0,n.jsx)(I.Wu,{children:(0,n.jsx)(J.E,{className:"h-40 w-full"})})]})});if(!s&&!t)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(I.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,n.jsxs)(I.Wu,{className:"text-center pt-6",children:[(0,n.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select an encounter to view"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"or create a new one."})]})})});if(!b&&O){var eN;return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(I.Zp,{children:[(0,n.jsx)(I.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[U&&j&&(0,n.jsx)(o.$,{variant:"ghost",size:"icon",onClick:j,className:"shrink-0 -ml-2 -mt-1",children:(0,n.jsx)(A.A,{className:"h-5 w-5"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(I.ZB,{className:"text-3xl font-bold",children:O.name}),(0,n.jsx)(I.BT,{children:(0,n.jsxs)("button",{onClick:e=>h({minTR:O.totalTR||0,maxTR:O.totalTR||0},e),className:"hover:underline p-0 bg-transparent text-inherit text-sm",children:[(0,n.jsx)("span",{className:"hidden sm:inline",children:"Total Threat Rating (TR): "}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"TR: "}),O.totalTR||0]})})]})]}),(0,n.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,n.jsxs)(o.$,{variant:"default",size:"sm",onClick:()=>x(O.id),children:[(0,n.jsx)(F.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Run Encounter"}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"Run"})]}),(0,n.jsxs)(o.$,{variant:"outline",size:"sm",onClick:()=>y(!0),children:[(0,n.jsx)(B.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Edit"})]})]})]})}),(0,n.jsx)(I.Wu,{children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Scene"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:O.sceneDescription||"No scene description."})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"GM Notes"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:O.gmNotes||"No GM notes."})]}),(0,n.jsx)(u.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Combatants"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("h4",{className:"font-semibold text-muted-foreground",children:["Players (",(O.players||[]).length,")"]}),(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(O.players||[]).map(e=>(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)($.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("span",{className:"font-semibold flex-1",children:e.name})]},e.id))}),(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),O.encounterTableId?(0,n.jsxs)("div",{className:"p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsxs)("p",{className:"font-semibold",children:["From Encounter Table: ",(0,n.jsx)("span",{className:"text-accent",children:(null==(eN=Q.table)?void 0:eN.name)||"..."})]}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Monsters will be rolled at the start of combat."})]}):(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(O.monsterGroups||[]).map(e=>{let s=Q.monsters.get(e.monsterId);return(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)(z.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("a",{href:"#/".concat(_,"/bestiary/").concat(e.monsterId),className:"font-semibold flex-1 hover:underline",children:(null==s?void 0:s.name)||"Unknown Monster"}),(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["x ",e.quantity]}),s&&(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Lvl ",s.level," ",s.role]})]},e.monsterId)})})]})]}),O.tags&&O.tags.length>0&&(0,n.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:O.tags.map(e=>(0,n.jsx)("button",{onClick:s=>h({tagFilter:e},s),className:"bg-transparent border-none p-0 m-0",children:(0,n.jsx)(D.E,{variant:"secondary",className:"cursor-pointer hover:bg-secondary/80",children:e})},e))})})]})}),(0,n.jsx)(I.wL,{children:(0,n.jsxs)(M.Lt,{children:[(0,n.jsx)(M.tv,{asChild:!0,children:(0,n.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(M.EO,{children:[(0,n.jsxs)(M.wd,{children:[(0,n.jsx)(M.r7,{children:"Are you sure?"}),(0,n.jsxs)(M.$v,{children:['This will permanently delete "',O.name,'". This action cannot be undone.']})]}),(0,n.jsxs)(M.ck,{children:[(0,n.jsx)(M.Zr,{children:"Cancel"}),(0,n.jsx)(M.Rx,{onClick:ev,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})})}return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(I.Zp,{children:(0,n.jsx)(k.lV,{...en,children:(0,n.jsxs)("form",{onSubmit:en.handleSubmit(ef),className:"space-y-6",children:[(0,n.jsx)(I.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[U&&j&&(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:d,className:"shrink-0 -ml-2",children:(0,n.jsx)(A.A,{className:"h-5 w-5"})}),(0,n.jsx)("div",{children:(0,n.jsx)(I.ZB,{children:t?U?"New Encounter":"Create a New Encounter":"Editing: ".concat(en.getValues("name")||"...")})})]}),!U&&(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:eg,className:"text-muted-foreground hover:text-foreground",children:(0,n.jsx)(G.A,{className:"h-5 w-5"})})]})}),(0,n.jsxs)(I.Wu,{className:"space-y-6",children:[(0,n.jsx)(k.zB,{name:"name",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{children:[(0,n.jsx)(k.lR,{children:"Encounter Name"}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(c.p,{...s})}),(0,n.jsx)(k.C5,{})]})}}),(0,n.jsx)(k.zB,{name:"tags",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{children:[(0,n.jsxs)(k.lR,{className:"flex items-center gap-2",children:[(0,n.jsx)(V.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(N.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"encounter"})}),(0,n.jsx)(k.C5,{})]})}}),(0,n.jsx)(k.zB,{name:"sceneDescription",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{children:[(0,n.jsx)(k.lR,{children:"Scene Description"}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(E.T,{...s,rows:4})})]})}}),(0,n.jsx)(k.zB,{name:"gmNotes",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{children:[(0,n.jsx)(k.lR,{children:"GM Notes (Private)"}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(E.T,{...s,rows:4})})]})}}),(0,n.jsx)(u.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-4",children:"Combatants"}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Players"}),(0,n.jsxs)(o.$,{type:"button",size:"sm",variant:"outline",onClick:()=>{ea({id:crypto.randomUUID(),name:"Player ".concat(el.length+1)})},children:[(0,n.jsx)(q.A,{className:"h-4 w-4 mr-2"})," Add Player"]})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[el.map((e,s)=>(0,n.jsxs)("div",{className:"flex items-center gap-2 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)(k.zB,{name:"players.".concat(s,".name"),control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{className:"flex-1",children:[(0,n.jsx)(k.MJ,{children:(0,n.jsx)(c.p,{...s})}),(0,n.jsx)(k.C5,{})]})}}),(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>er(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})]},e.id)),0===el.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No players added."})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),(0,n.jsx)(k.zB,{name:"totalTR",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(k.lR,{children:"Total TR:"}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(c.p,{type:"number",...s,readOnly:!0,className:"w-20 bg-muted border-none"})})]})}})]}),(0,n.jsx)(k.zB,{name:"encounterTableId",control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{children:[(0,n.jsx)(k.lR,{children:"Encounter Table (Optional)"}),(0,n.jsxs)(v.l6,{onValueChange:e=>s.onChange(e),value:s.value||"none",children:[(0,n.jsx)(k.MJ,{children:(0,n.jsx)(v.bq,{children:(0,n.jsx)(v.yv,{placeholder:"Select a table to roll from"})})}),(0,n.jsxs)(v.gC,{children:[(0,n.jsx)(v.eb,{value:"none",children:"None (Manual Selection)"}),es.map(e=>(0,n.jsx)(v.eb,{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)(k.C5,{})]})}}),(!ex||"none"===ex)&&(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("div",{className:"flex justify-end items-center mb-2",children:(0,n.jsx)(Y,{onAddCreatures:e=>{e.forEach(e=>{let{id:s,quantity:t}=e,n=ei.findIndex(e=>e.monsterId===s);if(n>-1){let e=ei[n];ed(n,{...e,quantity:e.quantity+t})}else ec({monsterId:s,quantity:t})})}})}),(0,n.jsxs)("div",{className:"space-y-2",children:[ei.map((e,s)=>{let t=ep.get(e.monsterId);return(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)("p",{className:"flex-1 font-semibold",children:(null==t?void 0:t.name)||"Unknown Monster"}),(0,n.jsx)(k.zB,{name:"monsterGroups.".concat(s,".quantity"),control:en.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(k.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(f.J,{children:"Qty"}),(0,n.jsx)(k.MJ,{children:(0,n.jsx)(c.p,{type:"number",min:"1",...s,className:"w-20 h-8"})})]})}}),(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>eo(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})]},e.id)}),0===ei.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No monsters added."})]})]})]})]})]}),(0,n.jsxs)(I.wL,{className:"flex items-center gap-2",children:[!t&&(0,n.jsxs)(M.Lt,{children:[(0,n.jsx)(M.tv,{asChild:!0,children:(0,n.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(M.EO,{children:[(0,n.jsxs)(M.wd,{children:[(0,n.jsx)(M.r7,{children:"Are you sure?"}),(0,n.jsxs)(M.$v,{children:['This will permanently delete "',en.getValues("name"),'".']})]}),(0,n.jsxs)(M.ck,{children:[(0,n.jsx)(M.Zr,{children:"Cancel"}),(0,n.jsx)(M.Rx,{onClick:ev,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,n.jsx)("div",{className:"flex-grow"}),!U&&(0,n.jsx)(o.$,{type:"button",variant:"outline",onClick:eg,children:"Cancel"}),(0,n.jsx)(o.$,{type:"submit",children:t?"Create Encounter":"Save Changes"})]})]})})})})}var H=t(73336);function X(e){let{selectedId:s}=e,[t,c]=(0,l.useState)("preparation"),[o,d]=(0,l.useState)(s||null),[u,x]=(0,l.useState)(null),[h,j]=(0,l.useState)(!1),[p,g]=(0,l.useState)(0),[f,v]=(0,l.useState)(""),[N,b]=(0,l.useState)(""),[w,T]=(0,l.useState)(""),[C,R]=(0,l.useState)(""),[S,I]=(0,l.useState)("name"),[E,M]=(0,l.useState)("asc"),[k,z]=(0,l.useState)(!1),A=(0,P.a)(),[F,B]=(0,l.useState)("list");(0,l.useEffect)(()=>{z(!0),s&&(d(s),A&&B("editor"))},[s,A]);let $={searchTerm:f,tagFilter:N,minTR:w,maxTR:C,sortBy:S,sortOrder:E},L={setSearchTerm:v,setTagFilter:b,setMinTR:T,setMaxTR:R,setSortBy:I,setSortOrder:M},G=(e,s)=>{s.shiftKey?(void 0!==e.minTR&&T(String(e.minTR)),void 0!==e.maxTR&&R(String(e.maxTR)),e.tagFilter&&b(s=>s?s.split(",").map(e=>e.trim()).includes(e.tagFilter)?s:"".concat(s,", ").concat(e.tagFilter):e.tagFilter)):(T(void 0!==e.minTR?String(e.minTR):""),R(void 0!==e.maxTR?String(e.maxTR):""),b(e.tagFilter||""))},V=()=>{v(""),b(""),T(""),R(""),I("name"),M("asc")},q=()=>g(e=>e+1),J=e=>{d(e),j(!1),A&&B("editor")},O=()=>{d(null),j(!0),A&&B("editor")},D=e=>{q(),d(e),j(!1),A&&B("editor")},Z=()=>{q(),d(null),j(!1),A&&B("list")},U=()=>{h&&(j(!1),d(null),A&&B("list"))},{toast:W}=(0,m.dj)(),_=async e=>{try{let s=await (0,i.eq)(e);s?(x(s),c("live")):W({variant:"destructive",title:"Error",description:"Could not find encounter to run."})}catch(e){W({variant:"destructive",title:"Error",description:"Failed to load encounter data."})}};return"live"===t&&u?(0,n.jsx)(H.A,{encounter:u,onEndEncounter:()=>{x(null),c("preparation")}}):k?A?(0,n.jsx)(a.A,{children:(0,n.jsx)("div",{className:"h-full w-full",children:"list"===F?(0,n.jsx)(y,{onSelectEncounter:J,onNewEncounter:O,selectedEncounterId:o,dataVersion:p,filters:$,setFilters:L,onClearFilters:V}):(0,n.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,n.jsx)("div",{className:"p-4 sm:p-6",children:(0,n.jsx)(Q,{encounterId:o,isCreatingNew:h,onEncounterSaveSuccess:D,onEncounterDeleteSuccess:Z,onEditCancel:U,onRunEncounter:_,onFilterByClick:G,onBack:()=>{B("list"),d(null),j(!1)},dataVersion:p},null!=o?o:h?"new":"placeholder")})})})}):(0,n.jsx)(r.SidebarProvider,{children:(0,n.jsx)(a.A,{children:(0,n.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,n.jsx)(r.Bx,{style:{"--sidebar-width":"380px"},children:(0,n.jsx)(y,{onSelectEncounter:J,onNewEncounter:O,selectedEncounterId:o,dataVersion:p,filters:$,setFilters:L,onClearFilters:V})}),(0,n.jsx)(r.sF,{className:"flex-1 overflow-y-auto",children:(0,n.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,n.jsx)(Q,{encounterId:o,isCreatingNew:h,onEncounterSaveSuccess:D,onEncounterDeleteSuccess:Z,onEditCancel:U,onRunEncounter:_,onFilterByClick:G,dataVersion:p},null!=o?o:h?"new":"placeholder")})})]})})}):null}}}]);