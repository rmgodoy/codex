"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4605],{54605:(e,s,t)=>{t.r(s),t.d(s,{default:()=>W});var l=t(95155),a=t(12115),n=t(6195),i=t(20031),r=t(47906),c=t(34239),d=t(62523),o=t(30285),x=t(66424),h=t(22346),m=t(87481),u=t(34301),j=t(75074),p=t(9572),f=t(20203),v=t(73926),N=t(85057),g=t(59409),w=t(90648),y=t(8643);function C(e){let{onSelectCity:s,onNewCity:t,selectedCityId:n,dataVersion:i,filters:r,setFilters:C,onClearFilters:b}=e,[S,I]=(0,a.useState)([]),[z,k]=(0,a.useState)(!0),{toast:A}=(0,m.dj)();(0,a.useEffect)(()=>{(async()=>{k(!0);try{I(await (0,c.HV)())}catch(e){A({variant:"destructive",title:"Error",description:"Could not fetch cities from database."})}finally{k(!1)}})()},[i,A]);let E=(0,a.useMemo)(()=>{let e=S.filter(e=>{let s=e.name.toLowerCase().includes(r.searchTerm.toLowerCase()),t=!0,l=r.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);return l.length>0&&(t=!!e.tags&&l.every(s=>e.tags.some(e=>e.toLowerCase().includes(s)))),s&&t}).sort((e,s)=>e.name.localeCompare(s.name));return"desc"===r.sortOrder&&e.reverse(),e},[S,r]);return(0,l.jsxs)("div",{className:"flex flex-col h-full",children:[(0,l.jsxs)("div",{className:"p-4 space-y-4",children:[(0,l.jsxs)(o.$,{onClick:t,className:"w-full",children:[(0,l.jsx)(u.A,{})," New City"]}),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)(j.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,l.jsx)(d.p,{placeholder:"Search cities...",value:r.searchTerm,onChange:e=>C.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,l.jsxs)(y.Nt,{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)(y.R6,{asChild:!0,children:(0,l.jsxs)(o.$,{variant:"ghost",className:"-ml-2",children:[(0,l.jsx)(p.A,{className:"h-4 w-4 mr-2"}),"Filters"]})}),(0,l.jsx)(o.$,{variant:"ghost",size:"sm",onClick:b,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,l.jsx)(y.Ke,{className:"space-y-2 pt-2",children:(0,l.jsx)(w.F,{value:r.tagFilter?r.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>C.setTagFilter(e.join(",")),placeholder:"Tags...",tagSource:"city"})})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)(N.J,{children:"Sort by"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)(g.l6,{value:r.sortBy,onValueChange:e=>C.setSortBy(e),children:[(0,l.jsx)(g.bq,{children:(0,l.jsx)(g.yv,{placeholder:"Sort by"})}),(0,l.jsx)(g.gC,{children:(0,l.jsx)(g.eb,{value:"name",children:"Name"})})]}),(0,l.jsxs)(o.$,{variant:"ghost",size:"icon",onClick:()=>C.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===r.sortOrder?(0,l.jsx)(f.A,{className:"h-4 w-4"}):(0,l.jsx)(v.A,{className:"h-4 w-4"}),(0,l.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,l.jsx)(h.w,{}),(0,l.jsx)(x.F,{className:"flex-1",children:(0,l.jsx)("div",{className:"p-4",children:z?(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading cities..."}):E.length>0?(0,l.jsx)("ul",{className:"space-y-1",children:E.map(e=>(0,l.jsx)("li",{children:(0,l.jsx)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(n===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:e.name})},e.id))}):(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"No cities found."})})})]})}var b=t(62177),S=t(90221),I=t(55594),z=t(38914),k=t(66695),A=t(88539),E=t(90010),L=t(17759),$=t(12543),F=t(18763),q=t(77223),T=t(25318),B=t(53054),R=t(83662),M=t(50286),V=t(68856),D=t(26126),P=t(69253),Z=t(31841);let U=I.z.object({name:I.z.string().min(1,"City name is required"),description:I.z.string().optional(),tags:I.z.array(I.z.string()).optional(),npcIds:I.z.array(I.z.string()).optional(),location:I.z.object({mapId:I.z.string(),hex:I.z.object({q:I.z.number(),r:I.z.number(),s:I.z.number()})}).optional()}),J={name:"",description:"",tags:[],npcIds:[],location:void 0};function O(e){let{cityId:s,isCreatingNew:t,onSaveSuccess:n,onDeleteSuccess:i,onEditCancel:x,onBack:u,dataVersion:j}=e,{toast:p}=(0,m.dj)(),[f,v]=(0,a.useState)(t),[N,g]=(0,a.useState)(!t&&!!s),[y,C]=(0,a.useState)(null),[I,O]=(0,a.useState)([]),[W,_]=(0,a.useState)([]),Q=(0,r.a)(),{worldSlug:G}=(0,z.q)(),H=(0,a.useMemo)(()=>new Map(I.map(e=>[e.id,e.name])),[I]),K=(0,a.useMemo)(()=>new Map(W.map(e=>[e.id,e.name])),[W]),X=(0,b.mN)({resolver:(0,S.u)(U),defaultValues:J});(0,a.useEffect)(()=>{Promise.all([(0,c.Qg)(),(0,c.xW)()]).then(e=>{let[s,t]=e;O(s),_(t)})},[j]);let Y=(0,a.useCallback)(async()=>{if(t){X.reset(J),C(null),v(!0),g(!1);return}if(!s){v(!1),g(!1),C(null);return}g(!0),v(!1);try{let e=await (0,c.iS)(s);e?(X.reset(e),C(e)):C(null)}catch(e){p({variant:"destructive",title:"Error",description:"Could not load city data."})}finally{g(!1)}},[s,t,X,p]);(0,a.useEffect)(()=>{Y()},[Y,j]);let ee=()=>{t?x():y&&(X.reset(y),v(!1))},es=async e=>{try{let l,a={...e,tags:e.tags||[],npcIds:e.npcIds||[]},i=e.tags||[];if(i.length>0&&await (0,c.JE)(i,"city"),t)l=await (0,c.xN)(a);else{if(!s)return;l=s,await (0,c.b4)({...a,id:s})}let r=null==y?void 0:y.location,d=e.location;if(r&&(!d||r.mapId!==d.mapId||r.hex.q!==d.hex.q||r.hex.r!==d.hex.r)){let e=await (0,c.zU)(r.mapId);if(e){let s=e.tiles.map(e=>e.hex.q===r.hex.q&&e.hex.r===r.hex.r?{...e,data:{...e.data,cityIds:(e.data.cityIds||[]).filter(e=>e!==l)}}:e);await (0,c.cA)({...e,tiles:s})}}if(d){let e=await (0,c.zU)(d.mapId);if(e){let s=e.tiles.map(e=>{if(e.hex.q===d.hex.q&&e.hex.r===d.hex.r){let s=new Set(e.data.cityIds||[]);return s.add(l),{...e,data:{...e.data,cityIds:Array.from(s)}}}return e});await (0,c.cA)({...e,tiles:s})}}p({title:t?"City Created!":"Save Successful",description:"".concat(e.name," has been saved.")}),n(l),v(!1)}catch(e){console.error(e),p({variant:"destructive",title:"Save Failed",description:"Could not save changes."})}},et=async()=>{if(s)try{if(null==y?void 0:y.location){let e=await (0,c.zU)(y.location.mapId);if(e){let t=e.tiles.map(e=>e.hex.q===y.location.hex.q&&e.hex.r===y.location.hex.r?{...e,data:{...e.data,cityIds:(e.data.cityIds||[]).filter(e=>e!==s)}}:e);await (0,c.cA)({...e,tiles:t})}}await (0,c.$t)(s),p({title:"City Deleted",description:"The city has been removed."}),i()}catch(e){p({variant:"destructive",title:"Deletion Failed",description:"Could not delete the city."})}};return N?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(k.Zp,{children:[(0,l.jsx)(k.aR,{children:(0,l.jsx)(V.E,{className:"h-8 w-48"})}),(0,l.jsx)(k.Wu,{children:(0,l.jsx)(V.E,{className:"h-40 w-full"})})]})}):s||t?!f&&y?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(k.Zp,{children:[(0,l.jsx)(k.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[Q&&u&&(0,l.jsx)(o.$,{variant:"ghost",size:"icon",onClick:u,className:"shrink-0 -ml-2 -mt-1",children:(0,l.jsx)($.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{children:(0,l.jsx)(k.ZB,{className:"text-3xl font-bold",children:y.name})})]}),(0,l.jsxs)(o.$,{variant:"outline",size:"sm",onClick:()=>v(!0),children:[(0,l.jsx)(F.A,{className:"h-4 w-4"}),(0,l.jsx)("span",{className:"hidden sm:inline ml-2",children:"Edit"})]})]})}),(0,l.jsx)(k.Wu,{children:(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Description"}),(0,l.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:y.description||"No description provided."})]}),(0,l.jsx)(h.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Location"}),y.location?(0,l.jsxs)("p",{className:"text-sm",children:["Located on map ",(0,l.jsx)("span",{className:"font-semibold text-accent",children:K.get(y.location.mapId)||"Unknown Map"})," at (Q: ",y.location.hex.q,", R: ",y.location.hex.r,")."]}):(0,l.jsx)("p",{className:"text-sm text-muted-foreground",children:"No location set."})]}),(0,l.jsx)(h.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Notable NPCs"}),y.npcIds&&y.npcIds.length>0?(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:y.npcIds.map(e=>(0,l.jsx)("a",{href:"#/".concat(G,"/npcs/").concat(e),children:(0,l.jsx)(D.E,{variant:"secondary",className:"cursor-pointer hover:bg-secondary/80",children:H.get(e)||"Unknown NPC"})},e))}):(0,l.jsx)("p",{className:"text-sm text-muted-foreground",children:"No NPCs linked."})]}),y.tags&&y.tags.length>0&&(0,l.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:y.tags.map(e=>(0,l.jsx)(D.E,{variant:"secondary",children:e},e))})})]})}),(0,l.jsx)(k.wL,{children:(0,l.jsxs)(E.Lt,{children:[(0,l.jsx)(E.tv,{asChild:!0,children:(0,l.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(q.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(E.EO,{children:[(0,l.jsxs)(E.wd,{children:[(0,l.jsx)(E.r7,{children:"Are you sure?"}),(0,l.jsxs)(E.$v,{children:['This will permanently delete "',y.name,'". This action cannot be undone.']})]}),(0,l.jsxs)(E.ck,{children:[(0,l.jsx)(E.Zr,{children:"Cancel"}),(0,l.jsx)(E.Rx,{onClick:et,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(k.Zp,{children:(0,l.jsx)(L.lV,{...X,children:(0,l.jsxs)("form",{onSubmit:X.handleSubmit(es),className:"space-y-6",children:[(0,l.jsx)(k.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[Q&&u&&(0,l.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:x,className:"shrink-0 -ml-2",children:(0,l.jsx)($.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{children:(0,l.jsx)(k.ZB,{children:t?Q?"New City":"Create New City":"Editing: ".concat(X.getValues("name")||"...")})})]}),!Q&&(0,l.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:ee,className:"text-muted-foreground hover:text-foreground",children:(0,l.jsx)(T.A,{className:"h-5 w-5"})})]})}),(0,l.jsxs)(k.Wu,{className:"space-y-6",children:[(0,l.jsx)(L.zB,{name:"name",control:X.control,render:e=>{let{field:s}=e;return(0,l.jsxs)(L.eI,{children:[(0,l.jsx)(L.lR,{children:"Name"}),(0,l.jsx)(L.MJ,{children:(0,l.jsx)(d.p,{...s})}),(0,l.jsx)(L.C5,{})]})}}),(0,l.jsx)(L.zB,{name:"description",control:X.control,render:e=>{let{field:s}=e;return(0,l.jsxs)(L.eI,{children:[(0,l.jsx)(L.lR,{children:"Description"}),(0,l.jsx)(L.MJ,{children:(0,l.jsx)(A.T,{...s,rows:4})})]})}}),(0,l.jsx)(L.zB,{name:"tags",control:X.control,render:e=>{let{field:s}=e;return(0,l.jsxs)(L.eI,{children:[(0,l.jsxs)(L.lR,{className:"flex items-center gap-2",children:[(0,l.jsx)(B.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,l.jsx)(L.MJ,{children:(0,l.jsx)(w.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"city"})})]})}}),(0,l.jsx)(h.w,{}),(0,l.jsx)(L.zB,{name:"location",control:X.control,render:e=>{let{field:s}=e;return(0,l.jsxs)(L.eI,{children:[(0,l.jsx)(L.lR,{children:"Location"}),s.value?(0,l.jsxs)("div",{className:"flex items-center justify-between p-2 mt-2 border rounded-md",children:[(0,l.jsxs)("p",{className:"font-semibold text-sm",children:[(0,l.jsx)("span",{className:"text-muted-foreground",children:"Map:"})," ",K.get(s.value.mapId)||"...",(0,l.jsx)("span",{className:"text-muted-foreground ml-2",children:"Tile:"})," Q:",s.value.hex.q,", R:",s.value.hex.r]}),(0,l.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>s.onChange(void 0),children:(0,l.jsx)(T.A,{className:"h-4 w-4"})})]}):(0,l.jsx)(P.G,{onLocationSelect:s.onChange,children:(0,l.jsxs)(o.$,{type:"button",variant:"outline",className:"w-full mt-2",children:[(0,l.jsx)(R.A,{className:"h-4 w-4 mr-2"})," Select Location on Map"]})})]})}}),(0,l.jsx)(h.w,{}),(0,l.jsx)(L.zB,{name:"npcIds",control:X.control,render:e=>{let{field:s}=e;return(0,l.jsxs)(L.eI,{children:[(0,l.jsx)(L.lR,{children:"Notable NPCs"}),(0,l.jsx)(Z.V,{items:I,initialSelectedIds:s.value||[],onConfirm:s.onChange,title:"Link NPCs to City",trigger:(0,l.jsxs)(o.$,{type:"button",variant:"outline",className:"w-full",children:[(0,l.jsx)(M.A,{className:"h-4 w-4 mr-2"}),"Link NPCs"]})}),(0,l.jsx)("div",{className:"flex flex-wrap gap-1 pt-2",children:(s.value||[]).map(e=>(0,l.jsx)(D.E,{variant:"secondary",children:H.get(e)||"Unknown"},e))})]})}})]}),(0,l.jsxs)(k.wL,{className:"flex items-center gap-2",children:[!t&&(0,l.jsxs)(E.Lt,{children:[(0,l.jsx)(E.tv,{asChild:!0,children:(0,l.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(q.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(E.EO,{children:[(0,l.jsxs)(E.wd,{children:[(0,l.jsx)(E.r7,{children:"Are you sure?"}),(0,l.jsxs)(E.$v,{children:['This will permanently delete "',X.getValues("name"),'".']})]}),(0,l.jsxs)(E.ck,{children:[(0,l.jsx)(E.Zr,{children:"Cancel"}),(0,l.jsx)(E.Rx,{onClick:et,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,l.jsx)("div",{className:"flex-grow"}),!Q&&(0,l.jsx)(o.$,{type:"button",variant:"outline",onClick:ee,children:"Cancel"}),(0,l.jsx)(o.$,{type:"submit",children:t?"Create City":"Save Changes"})]})]})})})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(k.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,l.jsxs)(k.Wu,{className:"text-center pt-6",children:[(0,l.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select a city to view"}),(0,l.jsx)("p",{className:"text-muted-foreground",children:"or create a new one."})]})})})}function W(e){let{selectedId:s}=e,[t,c]=(0,a.useState)(s||null),[d,o]=(0,a.useState)(!1),[x,h]=(0,a.useState)(0),[m,u]=(0,a.useState)(""),[j,p]=(0,a.useState)(""),[f,v]=(0,a.useState)("name"),[N,g]=(0,a.useState)("asc"),[w,y]=(0,a.useState)(!1),b=(0,r.a)(),[S,I]=(0,a.useState)("list"),z=()=>h(e=>e+1);(0,a.useEffect)(()=>{y(!0),s&&(c(s),b&&I("editor"))},[s,b]),(0,a.useEffect)(()=>{let e=()=>{z()};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[]);let k={searchTerm:m,tagFilter:j,sortBy:f,sortOrder:N},A={setSearchTerm:u,setTagFilter:p,setSortBy:v,setSortOrder:g},E=()=>{u(""),p(""),v("name"),g("asc")},L=e=>{c(e),o(!1),b&&I("editor")},$=()=>{c(null),o(!0),b&&I("editor")},F=e=>{z(),c(e),o(!1),b&&I("editor")},q=()=>{z(),c(null),o(!1),b&&I("list")},T=()=>{d&&(o(!1),c(null),b&&I("list"))};return w?b?(0,l.jsx)(n.A,{showSidebarTrigger:!1,children:(0,l.jsx)("div",{className:"h-full w-full",children:"list"===S?(0,l.jsx)(C,{onSelectCity:L,onNewCity:$,selectedCityId:t,dataVersion:x,filters:k,setFilters:A,onClearFilters:E}):(0,l.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,l.jsx)("div",{className:"p-4 sm:p-6",children:(0,l.jsx)(O,{cityId:t,isCreatingNew:d,onSaveSuccess:F,onDeleteSuccess:q,onEditCancel:T,onBack:()=>{I("list"),c(null),o(!1)},dataVersion:x},null!=t?t:d?"new":"placeholder")})})})}):(0,l.jsx)(i.SidebarProvider,{children:(0,l.jsx)(n.A,{children:(0,l.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,l.jsx)(i.Bx,{style:{"--sidebar-width":"380px"},children:(0,l.jsx)(C,{onSelectCity:L,onNewCity:$,selectedCityId:t,dataVersion:x,filters:k,setFilters:A,onClearFilters:E})}),(0,l.jsx)(i.sF,{className:"flex-1 overflow-y-auto",children:(0,l.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,l.jsx)(O,{cityId:t,isCreatingNew:d,onSaveSuccess:F,onDeleteSuccess:q,onEditCancel:T,dataVersion:x},null!=t?t:d?"new":"placeholder")})})]})})}):null}}}]);