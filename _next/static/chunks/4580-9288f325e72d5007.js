"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4580],{4580:(e,s,t)=>{t.r(s),t.d(s,{default:()=>Q});var n=t(95155),l=t(12115),a=t(99982),r=t(20031),i=t(37661),c=t(62523),o=t(30285),d=t(66424),u=t(22346),m=t(87481),x=t(34301),h=t(75074),j=t(20203),p=t(73926),g=t(85057),f=t(59409),v=t(90648);function N(e){let{onSelectEncounter:s,onNewEncounter:t,selectedEncounterId:a,dataVersion:r,filters:N,setFilters:b,onClearFilters:y}=e,[w,T]=(0,l.useState)([]),[C,R]=(0,l.useState)([]),[S,E]=(0,l.useState)(!0),{toast:I}=(0,m.dj)();(0,l.useEffect)(()=>{(async()=>{E(!0);try{let[e,s]=await Promise.all([(0,i.eS)(),(0,i.MY)()]);T(e),R(s)}catch(e){console.error("Error fetching encounters:",e),I({variant:"destructive",title:"Error",description:"Could not fetch encounters from database."})}finally{E(!1)}})()},[r,I]);let M=(0,l.useMemo)(()=>{let e=w.map(e=>{if(e.encounterTableId){let s=C.find(s=>s.id===e.encounterTableId);return{...e,totalTR:(null==s?void 0:s.totalTR)||e.totalTR||0}}return{...e,totalTR:e.totalTR||0}}).filter(e=>{let s=e.name.toLowerCase().includes(N.searchTerm.toLowerCase()),t=!0,n=N.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);n.length>0&&(t=!!e.tags&&n.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))));let l=!0;return N.minTR&&!isNaN(parseInt(N.minTR))&&(l=l&&e.totalTR>=parseInt(N.minTR,10)),N.maxTR&&!isNaN(parseInt(N.maxTR))&&(l=l&&e.totalTR<=parseInt(N.maxTR,10)),s&&t&&l}).sort((e,s)=>{if("TR"===N.sortBy){var t,n;let l=(null!=(t=e.totalTR)?t:0)-(null!=(n=s.totalTR)?n:0);if(0!==l)return l}return e.name.localeCompare(s.name)});return"desc"===N.sortOrder&&e.reverse(),e},[w,C,N]);return(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsxs)("div",{className:"p-4 space-y-4",children:[(0,n.jsxs)(o.$,{onClick:t,className:"w-full",children:[(0,n.jsx)(x.A,{})," New Encounter"]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(h.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,n.jsx)(c.p,{placeholder:"Search encounters...",value:N.searchTerm,onChange:e=>b.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)(g.J,{children:"Filter"}),(0,n.jsx)(o.$,{variant:"ghost",size:"sm",onClick:y,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,n.jsx)(v.F,{value:N.tagFilter?N.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>b.setTagFilter(e.join(",")),placeholder:"Tags (e.g. boss-fight)",tagSource:"encounter"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min TR",type:"number",value:N.minTR,onChange:e=>b.setMinTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),(0,n.jsx)(c.p,{placeholder:"Max TR",type:"number",value:N.maxTR,onChange:e=>b.setMaxTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)(g.J,{children:"Sort by"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)(f.l6,{value:N.sortBy,onValueChange:e=>b.setSortBy(e),children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Sort by"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"name",children:"Name"}),(0,n.jsx)(f.eb,{value:"TR",children:"TR"})]})]}),(0,n.jsxs)(o.$,{variant:"ghost",size:"icon",onClick:()=>b.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===N.sortOrder?(0,n.jsx)(j.A,{className:"h-4 w-4"}):(0,n.jsx)(p.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,n.jsx)(u.w,{}),(0,n.jsx)(d.F,{className:"flex-1",children:(0,n.jsx)("div",{className:"p-4",children:S?(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading encounters..."}):M.length>0?(0,n.jsx)("ul",{className:"space-y-1",children:M.map(e=>(0,n.jsx)("li",{children:(0,n.jsxs)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(a===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.totalTR,")"]})]})},e.id))}):(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"No encounters found."})})})]})}var b=t(62177),y=t(90221),w=t(55594),T=t(76762),C=t(66695),R=t(88539),S=t(90010),E=t(17759),I=t(73503),M=t(12543),k=t(21816),z=t(18763),F=t(91721),A=t(77223),B=t(25318),$=t(53054),L=t(13896),G=t(68856),V=t(54165),J=t(26126),q=t(47906);let O=w.z.object({id:w.z.string(),name:w.z.string().min(1,"Player name is required")}),D=w.z.object({monsterId:w.z.string(),quantity:w.z.coerce.number().min(1,"Quantity must be at least 1")}),P=w.z.object({name:w.z.string().min(1,"Encounter name is required"),sceneDescription:w.z.string().optional(),gmNotes:w.z.string().optional(),players:w.z.array(O),monsterGroups:w.z.array(D),tags:w.z.array(w.z.string()).optional(),totalTR:w.z.coerce.number().optional(),encounterTableId:w.z.string().optional()}),Z=["Normal","Underling","Paragon","Tyrant"],U=e=>{let{onAddCreatures:s}=e,[t,a]=(0,l.useState)(!1),[r,u]=(0,l.useState)([]),[m,x]=(0,l.useState)(new Map),[h,j]=(0,l.useState)(""),[p,g]=(0,l.useState)(""),[N,b]=(0,l.useState)(""),[y,w]=(0,l.useState)(""),[C,R]=(0,l.useState)(""),[S,E]=(0,l.useState)("all"),[M,k]=(0,l.useState)("all"),[z,F]=(0,l.useState)("");(0,l.useEffect)(()=>{t&&(0,i.OG)().then(u)},[t]);let A=(0,l.useMemo)(()=>r.filter(e=>{let s=e.name.toLowerCase().includes(h.toLowerCase()),t="all"===S||e.role===S,n="all"===M||e.template===M,l=!0;p&&!isNaN(parseInt(p))&&(l=l&&e.TR>=parseInt(p,10)),N&&!isNaN(parseInt(N))&&(l=l&&e.TR<=parseInt(N,10));let a=!0;y&&!isNaN(parseInt(y))&&(a=a&&e.level>=parseInt(y,10)),C&&!isNaN(parseInt(C))&&(a=a&&e.level<=parseInt(C,10));let r=!0;if(z){let s=z.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);s.length>0&&(r=!!e.tags&&e.tags.length>0&&s.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))))}return s&&t&&n&&l&&a&&r}),[r,h,p,N,y,C,S,M,z]),B=(e,s)=>{s>=1?x(t=>{let n=new Map(t);return n.set(e,s),n}):x(s=>{let t=new Map(s);return t.delete(e),t})},$=async()=>{let e=Array.from(m.entries()).map(e=>{let[s,t]=e,n=r.find(e=>e.id===s);return{id:s,name:n.name,quantity:t}});e.length>0&&s(e),a(!1),x(new Map),j(""),w(""),R(""),g(""),b(""),E("all"),k("all"),F("")};return(0,n.jsxs)(V.lG,{open:t,onOpenChange:a,children:[(0,n.jsx)(V.zM,{asChild:!0,children:(0,n.jsxs)(o.$,{type:"button",size:"sm",variant:"outline",children:[(0,n.jsx)(I.A,{className:"h-4 w-4 mr-2"})," Add Monster"]})}),(0,n.jsxs)(V.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,n.jsx)(V.c7,{children:(0,n.jsx)(V.L3,{children:"Select Monsters from Bestiary"})}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(c.p,{placeholder:"Search monsters...",value:h,onChange:e=>j(e.target.value),className:"shrink-0"}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsxs)(f.l6,{value:S,onValueChange:E,children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Filter by role"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"all",children:"All Roles"}),T.gg.map(e=>(0,n.jsx)(f.eb,{value:e,children:e},e))]})]}),(0,n.jsxs)(f.l6,{value:M,onValueChange:k,children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Filter by template"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"all",children:"All Templates"}),Z.map(e=>(0,n.jsx)(f.eb,{value:e,children:e},e))]})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min Lvl",type:"number",value:y,onChange:e=>w(e.target.value)}),(0,n.jsx)(c.p,{placeholder:"Max Lvl",type:"number",value:C,onChange:e=>R(e.target.value)})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(c.p,{placeholder:"Min TR",type:"number",value:p,onChange:e=>g(e.target.value)}),(0,n.jsx)(c.p,{placeholder:"Max TR",type:"number",value:N,onChange:e=>b(e.target.value)})]}),(0,n.jsx)(v.F,{value:z?z.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>F(e.join(",")),placeholder:"Filter by tags...",tagSource:"creature"})]}),(0,n.jsx)(d.F,{className:"flex-1 border rounded-md p-2 mt-2",children:(0,n.jsx)("div",{className:"space-y-1",children:A.length>0?A.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,n.jsx)(c.p,{type:"number",min:"0",value:m.get(e.id)||0,onChange:s=>B(e.id,parseInt(s.target.value)||0),className:"w-20 h-8"}),(0,n.jsx)("label",{htmlFor:"creature-".concat(e.id),className:"flex-1",children:(0,n.jsxs)("p",{className:"font-semibold",children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(Lvl ",e.level,", TR ",e.TR,")"]})]})})]},e.id)):(0,n.jsx)("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No monsters found."})})}),(0,n.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,n.jsx)(o.$,{variant:"ghost",onClick:()=>a(!1),children:"Cancel"}),(0,n.jsx)(o.$,{onClick:$,disabled:0===m.size,children:"Add Selected"})]})]})]})},W={name:"",sceneDescription:"",gmNotes:"",players:[],monsterGroups:[],tags:[],totalTR:0,encounterTableId:"none"};function _(e){let{encounterId:s,isCreatingNew:t,onEncounterSaveSuccess:a,onEncounterDeleteSuccess:r,onEditCancel:d,onRunEncounter:x,onFilterByClick:h,onBack:j,dataVersion:p}=e,{toast:N}=(0,m.dj)(),[w,T]=(0,l.useState)(t),[V,O]=(0,l.useState)(!t&&!!s),[D,Z]=(0,l.useState)(null),_=(0,q.a)(),[Y,Q]=(0,l.useState)({monsters:new Map}),[H,K]=(0,l.useState)([]),[X,ee]=(0,l.useState)([]),es=(0,b.mN)({resolver:(0,y.u)(P),defaultValues:W}),{fields:et,append:en,remove:el}=(0,b.jz)({control:es.control,name:"players"}),{fields:ea,append:er,remove:ei,update:ec,replace:eo}=(0,b.jz)({control:es.control,name:"monsterGroups"}),ed=(0,l.useMemo)(()=>new Map(H.map(e=>[e.id,e.TR])),[H]),eu=es.watch("encounterTableId"),em=JSON.stringify(es.watch("monsterGroups"));(0,l.useEffect)(()=>{if(eu&&"none"!==eu){let e=X.find(e=>e.id===eu);e&&e.totalTR!==es.getValues("totalTR")&&es.setValue("totalTR",e.totalTR),es.getValues("monsterGroups").length>0&&eo([])}else{let e=JSON.parse(em).reduce((e,s)=>e+(ed.get(s.monsterId)||0)*s.quantity,0);e!==es.getValues("totalTR")&&es.setValue("totalTR",e)}},[em,eu,X,ed,es,eo]);let ex=(0,l.useCallback)(async()=>{if(t){es.reset(W),Z(null),T(!0),O(!1);let[e,s]=await Promise.all([(0,i.MY)(),(0,i.OG)()]);ee(e),K(s);return}if(!s){T(!1),O(!1),Z(null);return}O(!0),T(!1);try{let[e,t,n]=await Promise.all([(0,i.eq)(s),(0,i.MY)(),(0,i.OG)()]);if(ee(t),K(n),e){let s,l=e.totalTR||0;e.encounterTableId&&(s=t.find(s=>s.id===e.encounterTableId))&&(l=s.totalTR);let a={...e,totalTR:l};Z(a);let r={...e,tags:e.tags||[],encounterTableId:e.encounterTableId||"none",totalTR:l};es.reset(r);let i=(e.monsterGroups||[]).map(e=>e.monsterId),c=n.filter(e=>i.includes(e.id)),o=new Map(c.map(e=>[e.id,e]));Q({monsters:o,table:s})}else Z(null)}catch(e){N({variant:"destructive",title:"Error",description:"Could not load encounter data."})}finally{O(!1)}},[s,t,es,N]);(0,l.useEffect)(()=>(ex(),window.addEventListener("focus",ex),()=>window.removeEventListener("focus",ex)),[ex,p]);let eh=(0,l.useMemo)(()=>new Map(H.map(e=>[e.id,e])),[H]),ej=()=>{if(t)d();else if(D){let e={...D,tags:D.tags||[],encounterTableId:D.encounterTableId||"none"};es.reset(e),T(!1)}},ep=async e=>{try{let n,l="none"===e.encounterTableId?void 0:e.encounterTableId,r={...e,tags:e.tags||[],totalTR:e.totalTR,encounterTableId:l,monsterGroups:l?[]:e.monsterGroups},c=e.tags||[];if(c.length>0&&await (0,i.JE)(c,"encounter"),t)n=await (0,i.Fs)(r),N({title:"Encounter Created!",description:"".concat(e.name," has been saved.")});else{if(!s)return;n=s,await (0,i.H$)({...r,id:s}),N({title:"Save Successful",description:"".concat(e.name," has been updated.")})}a(n),T(!1)}catch(e){N({variant:"destructive",title:"Save Failed",description:"Could not save changes."})}},eg=async()=>{if(s)try{await (0,i.ZJ)(s),N({title:"Encounter Deleted",description:"The encounter has been removed."}),r()}catch(e){N({variant:"destructive",title:"Deletion Failed",description:"Could not delete the encounter."})}};if(V)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(C.Zp,{children:[(0,n.jsx)(C.aR,{children:(0,n.jsx)(G.E,{className:"h-8 w-48"})}),(0,n.jsx)(C.Wu,{children:(0,n.jsx)(G.E,{className:"h-40 w-full"})})]})});if(!s&&!t)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(C.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,n.jsxs)(C.Wu,{className:"text-center pt-6",children:[(0,n.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select an encounter to view"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"or create a new one."})]})})});if(!w&&D){var ef;return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(C.Zp,{children:[(0,n.jsx)(C.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[_&&j&&(0,n.jsx)(o.$,{variant:"ghost",size:"icon",onClick:j,className:"shrink-0 -ml-2 -mt-1",children:(0,n.jsx)(M.A,{className:"h-5 w-5"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(C.ZB,{className:"text-3xl font-bold",children:D.name}),(0,n.jsx)(C.BT,{children:(0,n.jsxs)("button",{onClick:e=>h({minTR:D.totalTR||0,maxTR:D.totalTR||0},e),className:"hover:underline p-0 bg-transparent text-inherit text-sm",children:[(0,n.jsx)("span",{className:"hidden sm:inline",children:"Total Threat Rating (TR): "}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"TR: "}),D.totalTR||0]})})]})]}),(0,n.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,n.jsxs)(o.$,{variant:"default",size:"sm",onClick:()=>x(D.id),children:[(0,n.jsx)(k.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Run Encounter"}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"Run"})]}),(0,n.jsxs)(o.$,{variant:"outline",size:"sm",onClick:()=>T(!0),children:[(0,n.jsx)(z.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Edit"})]})]})]})}),(0,n.jsx)(C.Wu,{children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Scene"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:D.sceneDescription||"No scene description."})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"GM Notes"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:D.gmNotes||"No GM notes."})]}),(0,n.jsx)(u.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Combatants"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("h4",{className:"font-semibold text-muted-foreground",children:["Players (",(D.players||[]).length,")"]}),(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(D.players||[]).map(e=>(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)(F.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("span",{className:"font-semibold flex-1",children:e.name})]},e.id))}),(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),D.encounterTableId?(0,n.jsxs)("div",{className:"p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsxs)("p",{className:"font-semibold",children:["From Encounter Table: ",(0,n.jsx)("span",{className:"text-accent",children:(null==(ef=Y.table)?void 0:ef.name)||"..."})]}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Monsters will be rolled at the start of combat."})]}):(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(D.monsterGroups||[]).map(e=>{let s=Y.monsters.get(e.monsterId);return(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)(I.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("span",{className:"font-semibold flex-1",children:(null==s?void 0:s.name)||"Unknown Monster"}),(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["x ",e.quantity]}),s&&(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Lvl ",s.level," ",s.role]})]},e.monsterId)})})]})]}),D.tags&&D.tags.length>0&&(0,n.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:D.tags.map(e=>(0,n.jsx)("button",{onClick:s=>h({tagFilter:e},s),className:"bg-transparent border-none p-0 m-0",children:(0,n.jsx)(J.E,{variant:"secondary",className:"cursor-pointer hover:bg-secondary/80",children:e})},e))})})]})}),(0,n.jsx)(C.wL,{children:(0,n.jsxs)(S.Lt,{children:[(0,n.jsx)(S.tv,{asChild:!0,children:(0,n.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(A.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(S.EO,{children:[(0,n.jsxs)(S.wd,{children:[(0,n.jsx)(S.r7,{children:"Are you sure?"}),(0,n.jsxs)(S.$v,{children:['This will permanently delete "',D.name,'". This action cannot be undone.']})]}),(0,n.jsxs)(S.ck,{children:[(0,n.jsx)(S.Zr,{children:"Cancel"}),(0,n.jsx)(S.Rx,{onClick:eg,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})})}return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(C.Zp,{children:(0,n.jsx)(E.lV,{...es,children:(0,n.jsxs)("form",{onSubmit:es.handleSubmit(ep),className:"space-y-6",children:[(0,n.jsx)(C.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[_&&j&&(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:d,className:"shrink-0 -ml-2",children:(0,n.jsx)(M.A,{className:"h-5 w-5"})}),(0,n.jsx)("div",{children:(0,n.jsx)(C.ZB,{children:t?_?"New Encounter":"Create a New Encounter":"Editing: ".concat(es.getValues("name")||"...")})})]}),!_&&(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:ej,className:"text-muted-foreground hover:text-foreground",children:(0,n.jsx)(B.A,{className:"h-5 w-5"})})]})}),(0,n.jsxs)(C.Wu,{className:"space-y-6",children:[(0,n.jsx)(E.zB,{name:"name",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Encounter Name"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(c.p,{...s})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(E.zB,{name:"tags",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsxs)(E.lR,{className:"flex items-center gap-2",children:[(0,n.jsx)($.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(v.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"encounter"})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(E.zB,{name:"sceneDescription",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Scene Description"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(R.T,{...s,rows:4})})]})}}),(0,n.jsx)(E.zB,{name:"gmNotes",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"GM Notes (Private)"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(R.T,{...s,rows:4})})]})}}),(0,n.jsx)(u.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-4",children:"Combatants"}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Players"}),(0,n.jsxs)(o.$,{type:"button",size:"sm",variant:"outline",onClick:()=>{en({id:crypto.randomUUID(),name:"Player ".concat(et.length+1)})},children:[(0,n.jsx)(L.A,{className:"h-4 w-4 mr-2"})," Add Player"]})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[et.map((e,s)=>(0,n.jsxs)("div",{className:"flex items-center gap-2 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)(E.zB,{name:"players.".concat(s,".name"),control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex-1",children:[(0,n.jsx)(E.MJ,{children:(0,n.jsx)(c.p,{...s})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>el(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(A.A,{className:"h-4 w-4"})})]},e.id)),0===et.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No players added."})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),(0,n.jsx)(E.zB,{name:"totalTR",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(E.lR,{children:"Total TR:"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(c.p,{type:"number",...s,readOnly:!0,className:"w-20 bg-muted border-none"})})]})}})]}),(0,n.jsx)(E.zB,{name:"encounterTableId",control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Encounter Table (Optional)"}),(0,n.jsxs)(f.l6,{onValueChange:e=>s.onChange(e),value:s.value||"none",children:[(0,n.jsx)(E.MJ,{children:(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Select a table to roll from"})})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"none",children:"None (Manual Selection)"}),X.map(e=>(0,n.jsx)(f.eb,{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)(E.C5,{})]})}}),(!eu||"none"===eu)&&(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("div",{className:"flex justify-end items-center mb-2",children:(0,n.jsx)(U,{onAddCreatures:e=>{e.forEach(e=>{let{id:s,quantity:t}=e,n=ea.findIndex(e=>e.monsterId===s);if(n>-1){let e=ea[n];ec(n,{...e,quantity:e.quantity+t})}else er({monsterId:s,quantity:t})})}})}),(0,n.jsxs)("div",{className:"space-y-2",children:[ea.map((e,s)=>{let t=eh.get(e.monsterId);return(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)("p",{className:"flex-1 font-semibold",children:(null==t?void 0:t.name)||"Unknown Monster"}),(0,n.jsx)(E.zB,{name:"monsterGroups.".concat(s,".quantity"),control:es.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(g.J,{children:"Qty"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(c.p,{type:"number",min:"1",...s,className:"w-20 h-8"})})]})}}),(0,n.jsx)(o.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>ei(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(A.A,{className:"h-4 w-4"})})]},e.id)}),0===ea.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No monsters added."})]})]})]})]})]}),(0,n.jsxs)(C.wL,{className:"flex items-center gap-2",children:[!t&&(0,n.jsxs)(S.Lt,{children:[(0,n.jsx)(S.tv,{asChild:!0,children:(0,n.jsx)(o.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(A.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(S.EO,{children:[(0,n.jsxs)(S.wd,{children:[(0,n.jsx)(S.r7,{children:"Are you sure?"}),(0,n.jsxs)(S.$v,{children:['This will permanently delete "',es.getValues("name"),'".']})]}),(0,n.jsxs)(S.ck,{children:[(0,n.jsx)(S.Zr,{children:"Cancel"}),(0,n.jsx)(S.Rx,{onClick:eg,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,n.jsx)("div",{className:"flex-grow"}),!_&&(0,n.jsx)(o.$,{type:"button",variant:"outline",onClick:ej,children:"Cancel"}),(0,n.jsx)(o.$,{type:"submit",children:t?"Create Encounter":"Save Changes"})]})]})})})})}var Y=t(73336);function Q(){let[e,s]=(0,l.useState)("preparation"),[t,c]=(0,l.useState)(null),[o,d]=(0,l.useState)(null),[u,x]=(0,l.useState)(!1),[h,j]=(0,l.useState)(0),[p,g]=(0,l.useState)(""),[f,v]=(0,l.useState)(""),[b,y]=(0,l.useState)(""),[w,T]=(0,l.useState)(""),[C,R]=(0,l.useState)("name"),[S,E]=(0,l.useState)("asc"),[I,M]=(0,l.useState)(!1),k=(0,q.a)(),[z,F]=(0,l.useState)("list");(0,l.useEffect)(()=>{M(!0)},[]);let A={searchTerm:p,tagFilter:f,minTR:b,maxTR:w,sortBy:C,sortOrder:S},B={setSearchTerm:g,setTagFilter:v,setMinTR:y,setMaxTR:T,setSortBy:R,setSortOrder:E},$=(e,s)=>{s.shiftKey?(void 0!==e.minTR&&y(String(e.minTR)),void 0!==e.maxTR&&T(String(e.maxTR)),e.tagFilter&&v(s=>s?s.split(",").map(e=>e.trim()).includes(e.tagFilter)?s:"".concat(s,", ").concat(e.tagFilter):e.tagFilter)):(y(void 0!==e.minTR?String(e.minTR):""),T(void 0!==e.maxTR?String(e.maxTR):""),v(e.tagFilter||""))},L=()=>{g(""),v(""),y(""),T(""),R("name"),E("asc")},G=()=>j(e=>e+1),V=e=>{c(e),x(!1),k&&F("editor")},J=()=>{c(null),x(!0),k&&F("editor")},O=e=>{G(),c(e),x(!1),k&&F("editor")},D=()=>{G(),c(null),x(!1),k&&F("list")},P=()=>{u&&(x(!1),c(null),k&&F("list"))},{toast:Z}=(0,m.dj)(),U=async e=>{try{let t=await (0,i.eq)(e);t?(d(t),s("live")):Z({variant:"destructive",title:"Error",description:"Could not find encounter to run."})}catch(e){Z({variant:"destructive",title:"Error",description:"Failed to load encounter data."})}};return"live"===e&&o?(0,n.jsx)(Y.A,{encounter:o,onEndEncounter:()=>{d(null),s("preparation")}}):I?k?(0,n.jsx)(a.A,{children:(0,n.jsx)("div",{className:"h-full w-full",children:"list"===z?(0,n.jsx)(N,{onSelectEncounter:V,onNewEncounter:J,selectedEncounterId:t,dataVersion:h,filters:A,setFilters:B,onClearFilters:L}):(0,n.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,n.jsx)("div",{className:"p-4 sm:p-6",children:(0,n.jsx)(_,{encounterId:t,isCreatingNew:u,onEncounterSaveSuccess:O,onEncounterDeleteSuccess:D,onEditCancel:P,onRunEncounter:U,onFilterByClick:$,onBack:()=>{F("list"),c(null),x(!1)},dataVersion:h},null!=t?t:u?"new":"placeholder")})})})}):(0,n.jsx)(r.SidebarProvider,{children:(0,n.jsx)(a.A,{children:(0,n.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,n.jsx)(r.Bx,{style:{"--sidebar-width":"380px"},children:(0,n.jsx)(N,{onSelectEncounter:V,onNewEncounter:J,selectedEncounterId:t,dataVersion:h,filters:A,setFilters:B,onClearFilters:L})}),(0,n.jsx)(r.sF,{className:"flex-1 overflow-y-auto",children:(0,n.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,n.jsx)(_,{encounterId:t,isCreatingNew:u,onEncounterSaveSuccess:O,onEncounterDeleteSuccess:D,onEditCancel:P,onRunEncounter:U,onFilterByClick:$,dataVersion:h},null!=t?t:u?"new":"placeholder")})})]})})}):null}}}]);