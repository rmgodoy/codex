"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1],{1933:(e,t,a)=>{a.d(t,{A:()=>J});var s=a(5155),r=a(2115),n=a(3585),i=a(6535),l=a(3930),o=a(6424),d=a(285),c=a(9556),m=a(7381),u=a(1949),p=a(3896),f=a(1721),x=a(3503),h=a(2523),y=a(7262),g=a(5057),j=a(2346),b=a(8082),v=a(9434);let N=b.Kq,w=b.bL,k=b.l9,C=r.forwardRef((e,t)=>{let{className:a,sideOffset:r=4,...n}=e;return(0,s.jsx)(b.UC,{ref:t,sideOffset:r,className:(0,v.cn)("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...n})});C.displayName=b.UC.displayName;var S=a(4165);function I(e){let{combatantsInTurnOrder:t,untrackedPlayers:a,activeTurnId:n,round:i,onNextTurn:l,onPrevTurn:b,onCombatantUpdate:v,perilRoll:I,perilText:P,allPlayersReady:A,turnIndex:M,onAddPlayer:R}=e,[L,T]=(0,r.useState)({}),[E,B]=(0,r.useState)(""),[U,Y]=(0,r.useState)(!1),H=(0,r.useMemo)(()=>[...a,...t.filter(e=>"player"===e.type)],[a,t]);(0,r.useEffect)(()=>{let e={};H.forEach(t=>{void 0!==t.initiative&&null!==t.initiative&&(e[t.id]=t.initiative>0?String(t.initiative):"")}),T(e)},[H,i]);let q=(e,t)=>{T(a=>({...a,[e]:t}))},F=e=>{let t=H.find(t=>t.id===e);if(!t)return;let a=parseInt(L[e],10)||0;t&&(void 0===t.initiative||t.initiative!==a)&&v({...t,initiative:a})},D=(e,t)=>{v({...e,nat20:t})},$=()=>{R&&E.trim()&&(R(E.trim()),B(""),Y(!1))};return(0,s.jsxs)("div",{className:"flex flex-col h-full p-4 bg-card",children:[(0,s.jsxs)("div",{className:"text-center mb-4",children:[(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Round"}),(0,s.jsx)("p",{className:"text-4xl font-bold",children:i})]}),(0,s.jsx)(j.w,{className:"my-2"}),(0,s.jsxs)("div",{className:"text-center mb-4",children:[(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Peril"}),(0,s.jsx)("p",{className:"text-4xl font-bold",children:I}),(0,s.jsx)("div",{className:"flex justify-center gap-6 mt-2 text-sm",children:(0,s.jsx)("p",{className:"font-bold text-lg",children:P})})]}),(0,s.jsx)(j.w,{className:"my-2"}),(0,s.jsx)(N,{delayDuration:100,children:(0,s.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,s.jsxs)(d.$,{onClick:b,variant:"outline",className:"w-full",disabled:0===M&&1===i,children:[(0,s.jsx)(m.A,{className:"h-4 w-4 mr-2"})," Prev"]}),(()=>{let e=!A,t=(0,s.jsxs)(d.$,{onClick:l,variant:"default",className:"w-full",disabled:e,children:["Next ",(0,s.jsx)(c.A,{className:"h-4 w-4 ml-2"})]});return e?(0,s.jsxs)(w,{children:[(0,s.jsx)(k,{asChild:!0,children:(0,s.jsx)("div",{className:"w-full",children:t})}),(0,s.jsx)(C,{children:(0,s.jsx)("p",{children:"Set initiative for all players to proceed."})})]}):t})()]})}),a.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold mb-2 text-destructive",children:"Set Initiative"}),(0,s.jsx)("ul",{className:"space-y-2 pr-4",children:a.map(e=>(0,s.jsxs)("li",{className:"p-3 rounded-lg border-l-4 border-destructive bg-destructive/10",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(u.A,{className:"h-5 w-5 text-destructive"}),(0,s.jsx)("span",{className:"font-semibold",children:e.name})]}),(0,s.jsx)(h.p,{type:"number",value:L[e.id]||"",onChange:t=>q(e.id,t.target.value),onBlur:()=>F(e.id),className:"w-20 h-8",min:"0"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-2 pl-8",children:[(0,s.jsx)(y.S,{id:"nat20-untracked-".concat(e.id),checked:e.nat20,onCheckedChange:t=>D(e,!!t)}),(0,s.jsx)(g.J,{htmlFor:"nat20-untracked-".concat(e.id),children:"Nat 20"})]})]},e.id))})]}),(0,s.jsx)(j.w,{className:"my-2"})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground",children:"Initiative Order"}),R&&(0,s.jsxs)(S.lG,{open:U,onOpenChange:Y,children:[(0,s.jsx)(S.zM,{asChild:!0,children:(0,s.jsxs)(d.$,{variant:"outline",size:"sm",children:[(0,s.jsx)(p.A,{className:"h-4 w-4 mr-2"})," Add Player"]})}),(0,s.jsxs)(S.Cf,{className:"sm:max-w-[425px]",children:[(0,s.jsx)(S.c7,{children:(0,s.jsx)(S.L3,{children:"Add New Player"})}),(0,s.jsx)("div",{className:"grid gap-4 py-4",children:(0,s.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,s.jsx)(g.J,{htmlFor:"name",className:"text-right",children:"Name"}),(0,s.jsx)(h.p,{id:"name",value:E,onChange:e=>B(e.target.value),className:"col-span-3",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),$())},autoFocus:!0})]})}),(0,s.jsx)(S.Es,{children:(0,s.jsx)(d.$,{onClick:$,children:"Add Player"})})]})]})]}),(0,s.jsx)(o.F,{className:"flex-1",children:t.length>0?(0,s.jsx)("ul",{className:"space-y-2 pr-4",children:t.map(e=>(0,s.jsxs)("li",{className:"p-3 rounded-lg border-l-4 transition-all ".concat(n&&e.turnId===n?"bg-primary/20 border-primary shadow-md":"bg-background border-transparent"),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:["player"===e.type?(0,s.jsx)(f.A,{className:"h-5 w-5 text-accent"}):(0,s.jsx)(x.A,{className:"h-5 w-5 text-accent"}),(0,s.jsx)("span",{className:"font-semibold",children:e.name})]}),"player"===e.type?(0,s.jsx)(h.p,{type:"number",value:L[e.id]||"",onChange:t=>q(e.id,t.target.value),onBlur:()=>F(e.id),className:"w-20 h-8",min:"0"}):(0,s.jsx)("span",{className:"font-bold text-lg",children:e.initiative})]}),"player"===e.type&&(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-2 pl-8",children:[(0,s.jsx)(y.S,{id:"nat20-".concat(e.id),checked:e.nat20,onCheckedChange:t=>D(e,!!t)}),(0,s.jsx)(g.J,{htmlFor:"nat20-".concat(e.id),children:"Nat 20"})]})]},e.turnId))}):(0,s.jsx)("p",{className:"text-muted-foreground text-center pt-4",children:"Waiting for players..."})})]})}var P=a(6695),A=a(8098),M=a(1887),R=a(518),L=a(7223),T=a(8911);let E=[{name:"Accurate",description:"You take an intensity bonus to accuracy checks. Cancels out inaccurate.",effects:[{attribute:"Accuracy",modifier:"bonus"}]},{name:"Inaccurate",description:"You take an intensity penalty to accuracy checks. Cancels out accurate.",effects:[{attribute:"Accuracy",modifier:"penalty"}]},{name:"Bleeding",description:"You suffer intensity damage when you move, jump, teleport, or are forced to move. You only take this damage once per instance of movement, even if you move multiple squares as part of that movement."},{name:"Burning",description:"You suffer (intensity)d6 damage at the start of your turn, up to a maximum of three dice. Then the intensity increases by +1."},{name:"Delirious",description:"At the start of your turn, roll (intensity)d6, up to a maximum of three dice. For each result, perform the listed action, spending the required action point: 1: fling something at the nearest creature (damage) 2: hurt yourself and suffer damage 3: stumble half your speed in a random direction 4: stare blankly and do nothing 5 or 6: no effect"},{name:"Fortified",description:"Damage you take from attacks is reduced by intensity. Cancels out frail."},{name:"Frail",description:"Damage you take from attacks is increased by intensity. Cancels out fortified."},{name:"Guarded",description:"You gain an intensity bonus to guard checks. Cancels out unguarded.",effects:[{attribute:"Guard",modifier:"bonus"}]},{name:"Unguarded",description:"You take an intensity penalty to guard checks. Cancels out guarded.",effects:[{attribute:"Guard",modifier:"penalty"}]},{name:"Hastened",description:"You gain an intensity bonus to initiative checks. Cancels out hindered.",effects:[{attribute:"Initiative",modifier:"bonus"}]},{name:"Hindered",description:"You take an intensity penalty to initiative checks. Cancels out hastened.",effects:[{attribute:"Initiative",modifier:"penalty"}]},{name:"Mending",description:"You regain intensity hit points at the start of your turn. Cancels out poisoned."},{name:"Poisoned",description:"You suffer intensity damage at the start of your turn. Cancels out mending."},{name:"Provoked",description:"You take an intensity penalty to attacks that do not include the provoking creature as a target. If a different creature confers this state on you, it becomes the provoking creature."},{name:"Sleeping",description:"You also gain toppled when you gain this condition. You take no turn, but you make one free prevail against this state at the end of each round. After waking, you cannot take a turn until the following round. This state ends immediately if you suffer damage."},{name:"Slow",description:"You take an intensity penalty to speed. Cancels out swift.",effects:[{attribute:"Speed",modifier:"penalty"}]},{name:"Swift",description:"You gain an intensity bonus to speed. Cancels out slow.",effects:[{attribute:"Speed",modifier:"bonus"}]},{name:"Toppled",description:"You have -2 accuracy and guard, and you move at half speed. You can end this state by spending an action to stand up. If this state has an intensity, you must prevail to stand up instead.",effects:[{attribute:"Accuracy",modifier:"fixed",value:-2},{attribute:"Guard",modifier:"fixed",value:-2},{attribute:"Speed",modifier:"halve"}]},{name:"Strong",description:"You gain an intensity bonus to damage rolls on attacks. Cancels out weak.",effects:[{attribute:"rollBonus",modifier:"bonus"}]},{name:"Weak",description:"You take an intensity penalty to damage rolls on attacks. Cancels out strong.",effects:[{attribute:"rollBonus",modifier:"penalty"}]},{name:"Weary",description:"You take an intensity penalty to resist checks. Cancels out willful.",effects:[{attribute:"Resist",modifier:"penalty"}]},{name:"Willful",description:"You take an intensity bonus to resist checks. Cancels out weary.",effects:[{attribute:"Resist",modifier:"bonus"}]}];var B=a(4636);let U=e=>{let{label:t,modified:a,original:r,isBonus:n}=e,i=a!==r,l="number"==typeof a&&"number"==typeof r?a-r:0,o="";return i&&(o=n&&l>0||!n&&l<0?"text-green-400":"text-red-400"),(0,s.jsxs)("div",{children:[(0,s.jsx)(g.J,{children:t}),i?(0,s.jsxs)("p",{className:"text-lg font-bold",children:[(0,s.jsx)("span",{className:o,children:a}),(0,s.jsx)("span",{className:"text-muted-foreground text-sm ml-2 line-through",children:r})]}):(0,s.jsx)("p",{className:"text-lg font-bold",children:r})]})};function Y(e){let{combatant:t,onUpdate:a}=e,[n,i]=(0,r.useState)(""),[l,c]=(0,r.useState)(""),[m,u]=(0,r.useState)(""),[p,f]=(0,r.useState)(!1),{modifiedAttributes:x,originalAttributes:y}=(0,r.useMemo)(()=>{if("player"===t.type||!t.states)return{modifiedAttributes:null,originalAttributes:null};let e={...t.attributes},a={...t.attributes};return t.states.forEach(e=>{e.effects&&e.effects.forEach(t=>{switch(t.modifier){case"bonus":case"penalty":{let s=e.intensity*("bonus"===t.modifier?1:-1);"number"==typeof a[t.attribute]&&(a[t.attribute]+=s);break}case"fixed":"number"==typeof a[t.attribute]&&(a[t.attribute]+=t.value);break;case"halve":"Speed"===t.attribute&&(a.Speed=Math.floor(a.Speed/2))}})}),{modifiedAttributes:a,originalAttributes:e}},[t]),b=(0,r.useMemo)(()=>E.filter(e=>e.name.toLowerCase().includes(m.toLowerCase())),[m]);if("player"===t.type)return(0,s.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,s.jsxs)(P.Zp,{children:[(0,s.jsxs)(P.aR,{children:[(0,s.jsx)(P.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),(0,s.jsx)(P.BT,{children:"Player Character"})]}),(0,s.jsx)(P.Wu,{children:(0,s.jsx)("p",{className:"text-muted-foreground text-center py-8",children:"Player turn. No stats to display."})})]})});let N=()=>{if(!n)return;let e=0;if(!isNaN(e=n.startsWith("+")||n.startsWith("-")?parseInt(n,10):parseInt(n,10)-t.currentHp)){let s=t.currentHp+e;"Underling"===t.template&&(s=Math.min(1,Math.max(0,s))),a({...t,currentHp:s})}i("")},w=(e,s,r)=>{let n=t.states.map(t=>t.id===e?{...t,[s]:r}:t);a({...t,states:n})},k=e=>{a({...t,states:t.states.filter(t=>t.id!==e)})},C=(e,s)=>{let r=t.states.map(t=>t.id===e?{...t,...s}:t);a({...t,states:r})};return(0,s.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,s.jsxs)(P.Zp,{children:[(0,s.jsxs)(P.aR,{children:[(0,s.jsx)("div",{className:"flex justify-between items-start",children:(0,s.jsxs)("div",{children:[(0,s.jsx)(P.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),"monster"===t.type&&(0,s.jsxs)(P.BT,{children:["Lvl ",t.level," ",t.template," ",t.role," • TR ",t.TR]})]})}),("Paragon"===t.template||"Tyrant"===t.template)&&(0,s.jsxs)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Extra Turn:"})," This creature takes an additional turn at the end of the round."]}),(0,s.jsx)("p",{children:"Immune to effects that delay its turn (loses an action point on its next turn instead)."})]}),"Tyrant"===t.template&&(0,s.jsx)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Unstoppable:"})," Can make a free prevail check against one state at the end of each round."]})})]}),(0,s.jsxs)(P.Wu,{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(g.J,{htmlFor:"hp",className:"flex items-center gap-2 text-lg shrink-0",children:[(0,s.jsx)(A.A,{className:"h-6 w-6 text-red-500"})," HP"]}),(0,s.jsx)(h.p,{id:"hp",type:"number",value:t.currentHp,onChange:e=>{let s=parseInt(e.target.value,10)||0;"Underling"===t.template&&(s=Math.min(1,Math.max(0,s))),a({...t,currentHp:s})},className:"w-24 text-lg font-bold"}),"monster"===t.type&&(0,s.jsxs)("span",{className:"text-muted-foreground text-lg",children:["/ ",t.maxHp]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[180px]",children:[(0,s.jsx)(h.p,{placeholder:"+5 or -10",value:n,onChange:e=>i(e.target.value),onKeyDown:e=>"Enter"===e.key&&N(),className:"flex-1"}),(0,s.jsx)(d.$,{onClick:N,size:"sm",children:"Apply"})]})]}),"monster"===t.type&&x&&y&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(j.w,{}),(0,s.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 text-center my-6",children:[(0,s.jsx)(U,{label:"Speed",modified:x.Speed,original:y.Speed}),(0,s.jsx)(U,{label:"Accuracy",modified:x.Accuracy,original:y.Accuracy,isBonus:!0}),(0,s.jsx)(U,{label:"Guard",modified:x.Guard,original:y.Guard,isBonus:!0}),(0,s.jsx)(U,{label:"Resist",modified:x.Resist,original:y.Resist,isBonus:!0}),(0,s.jsx)(U,{label:"Roll Bonus",modified:x.rollBonus>0?"+".concat(x.rollBonus):x.rollBonus,original:y.rollBonus>0?"+".concat(y.rollBonus):y.rollBonus,isBonus:!0}),(0,s.jsx)(U,{label:"DMG",modified:t.attributes.DMG,original:t.attributes.DMG}),(0,s.jsx)(U,{label:"Initiative",modified:x.Initiative,original:y.Initiative,isBonus:!0})]})]}),(0,s.jsx)(j.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"flex justify-between items-center mb-4",children:(0,s.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground",children:"States"})}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[(0,s.jsxs)(B.AM,{open:p,onOpenChange:f,children:[(0,s.jsx)(B.Wv,{asChild:!0,children:(0,s.jsxs)(d.$,{variant:"outline",role:"combobox","aria-expanded":p,className:"flex-1 min-w-[180px] justify-between",children:[l||"Select a common state...",(0,s.jsx)(M.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,s.jsxs)(B.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:[(0,s.jsx)("div",{className:"p-2 border-b",children:(0,s.jsx)(h.p,{placeholder:"Search states...",value:m,onChange:e=>u(e.target.value),className:"h-9",autoFocus:!0})}),(0,s.jsx)(o.F,{className:"h-[200px]",children:(0,s.jsx)("div",{className:"p-1",children:b.length>0?b.map(e=>(0,s.jsxs)(d.$,{variant:"ghost",className:(0,v.cn)("w-full justify-start font-normal h-auto py-2",l===e.name&&"bg-accent"),onClick:()=>{c(e.name),f(!1),u("")},children:[(0,s.jsx)(R.A,{className:(0,v.cn)("mr-2 h-4 w-4",l===e.name?"opacity-100":"opacity-0")}),e.name]},e.name)):(0,s.jsx)("p",{className:"text-center text-sm text-muted-foreground p-4",children:"No state found."})})})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(d.$,{onClick:()=>{let e=E.find(e=>e.name===l);if(!e)return;let s={id:crypto.randomUUID(),name:e.name,intensity:1,description:e.description,effects:e.effects};a({...t,states:[...t.states,s]}),c("")},disabled:!l,children:[(0,s.jsx)("span",{className:"sm:hidden",children:"Add"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Add State"})]}),(0,s.jsx)(j.w,{orientation:"vertical",className:"h-6"}),(0,s.jsxs)(d.$,{variant:"outline",onClick:()=>{let e={id:crypto.randomUUID(),name:"New State",intensity:1};a({...t,states:[...t.states,e]})},children:[(0,s.jsx)("span",{className:"sm:hidden",children:"Custom"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Add Custom"})]})]})]}),(0,s.jsx)("div",{className:"space-y-3",children:t.states.length>0?t.states.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-card-foreground/5 rounded-lg",children:[(0,s.jsx)(h.p,{value:e.name,onChange:t=>C(e.id,{name:t.target.value,effects:void 0,description:void 0}),className:"flex-1 font-semibold min-w-0",disabled:!!E.find(t=>t.name===e.name)}),(0,s.jsx)(g.J,{htmlFor:"intensity-".concat(e.id),className:"hidden sm:inline shrink-0",children:"Intensity"}),(0,s.jsx)(h.p,{id:"intensity-".concat(e.id),type:"number",min:"0",value:e.intensity,onChange:t=>w(e.id,"intensity",Math.max(0,parseInt(t.target.value,10)||0)),className:"w-20 shrink-0"}),(0,s.jsx)(d.$,{variant:"ghost",size:"icon",onClick:()=>k(e.id),className:"shrink-0",children:(0,s.jsx)(L.A,{className:"h-4 w-4 text-destructive"})})]},e.id)):(0,s.jsx)("p",{className:"text-muted-foreground text-center",children:"No active states."})})]}),"monster"===t.type&&t.abilities&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(j.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground my-4",children:"Abilities"}),(0,s.jsx)("p",{className:"text-foreground/90 whitespace-pre-wrap",children:t.abilities})]})]}),"monster"===t.type&&t.deeds.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(j.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground mb-4",children:"Deeds"}),t.deeds.map((e,a)=>(0,s.jsx)(T.P,{deed:e,dmgReplacement:t.attributes.DMG},a))]})]})]})]})})}var H=a(31),q=a(1816),F=a(8856),D=a(7906),$=a(7481);let G=e=>{if(!e)return 1;let t=e.toLowerCase().trim(),a=t.match(/(\d*)d(\d+)/);if(a){let e=a[1]?parseInt(a[1],10):1,t=parseInt(a[2],10);if(!isNaN(e)&&!isNaN(t)&&t>0){let a=0;for(let s=0;s<e;s++)a+=Math.floor(Math.random()*t)+1;return a}}let s=parseInt(t,10);return!isNaN(s)&&s>0?s:1};function J(e){let{encounter:t,onEndEncounter:a}=e,[o,c]=(0,r.useState)({}),[m,u]=(0,r.useState)(!0),[p,f]=(0,r.useState)(0),[x,h]=(0,r.useState)(1),[y,g]=(0,r.useState)({}),j=(0,D.a)(),{toast:b}=(0,$.dj)(),v=(0,r.useMemo)(()=>o[x]||[],[o,x]),N=(0,r.useCallback)(e=>{e&&c(t=>{let a={id:crypto.randomUUID(),type:"player",name:e,initiative:0,nat20:!1},s={...t};for(let e in s[x]||(s[x]=[]),s)parseInt(e)>=x&&(s[e]=[...s[e],a]);return s})},[x]),w=(0,r.useCallback)((e,t)=>{g(a=>{if(a[e])return a;let s=Math.floor(6*Math.random())+1+(Math.floor(6*Math.random())+1),r="";r=t.some(e=>"monster"===e.type&&"Tyrant"===e.template)?s<=6?"1 Heavy, 1 Light deed":s<=9?"1 Mighty & 1 Light, or 2 Heavy deeds":"1 Mighty, 1 Heavy deed":s<=6?"1 Heavy deed":s<=9?"1 Heavy, 1 Mighty deed":"2 Heavy, 1 Mighty deed";let n={...a};return n[e]={roll:s,text:r},n})},[]),k=(0,r.useMemo)(()=>{if(m||0===v.length)return!1;let e=v.filter(e=>"player"===e.type);return 0===e.length||e.every(e=>void 0!==e.initiative&&e.initiative>0||e.nat20)},[v,m]),{turnOrder:C,activeTurn:S,untrackedPlayers:P}=(0,r.useMemo)(()=>{if(m||0===v.length)return{turnOrder:[],activeTurn:null,untrackedPlayers:[]};let e=v.filter(e=>"player"===e.type),t=v.filter(e=>"monster"===e.type),a=e.filter(e=>(void 0===e.initiative||e.initiative<=0)&&!e.nat20),s=e.filter(e=>void 0!==e.initiative&&e.initiative>0||e.nat20),r=(e,t)=>(t.initiative||0)-(e.initiative||0),n=s.filter(e=>e.nat20).sort(r),i=s.filter(e=>!e.nat20),l=t.length>0?Math.max(...t.map(e=>e.initiative)):-1/0,o=i.filter(e=>(e.initiative||0)>l).sort(r),d=i.filter(e=>(e.initiative||0)<=l).sort(r),c=[...t].sort(r),u=t.filter(e=>"Paragon"===e.template||"Tyrant"===e.template).sort(r),f=[...n.map(e=>({...e,turnId:"".concat(e.id,"-start")})),...o.map(e=>({...e,turnId:e.id})),...c.map(e=>({...e,turnId:e.id})),...d.map(e=>({...e,turnId:e.id})),...n.map(e=>({...e,turnId:"".concat(e.id,"-end")})),...u.map(e=>({...e,turnId:"".concat(e.id,"-extra")}))],x=k?f[p]:null;return{turnOrder:f,activeTurn:x,untrackedPlayers:a}},[v,p,m,k]);(0,r.useEffect)(()=>{(async()=>{u(!0);let e=t.monsterGroups;if(t.encounterTableId){let s=await (0,n.Uh)(t.encounterTableId);if(!s||0===s.entries.length){b({variant:"destructive",title:"Error",description:"Could not find encounter table or it is empty."}),a();return}let r=s.entries.reduce((e,t)=>e+t.weight,0);if(r<=0){b({variant:"destructive",title:"Error",description:"Encounter table has no weight."}),a();return}let i=Math.random()*r,l=s.entries[0];for(let e of s.entries)if((i-=e.weight)<=0){l=e;break}let o=G(l.quantity||"1");e=[{monsterId:l.creatureId,quantity:o}]}let s=e.map(e=>e.monsterId),r=await (0,i.C8)(s),o=new Map(r.map(e=>[e.id,e])),d=r.flatMap(e=>e.deeds),m=new Map((await (0,l.pT)(d)).map(e=>[e.id,e])),p=[];(t.players||[]).forEach(e=>{p.push({id:e.id,type:"player",name:e.name,initiative:0,nat20:!1})}),(e||[]).forEach(e=>{let t=o.get(e.monsterId);if(!t)return;let a=t.deeds.map(e=>m.get(e)).filter(Boolean);"Underling"===t.template&&(a=a.filter(e=>"light"===e.tier));for(let s=0;s<e.quantity;s++){let r={id:crypto.randomUUID(),type:"monster",name:e.quantity>1?"".concat(t.name," ").concat(s+1):t.name,monsterId:t.id,level:t.level,role:t.role,template:t.template||"Normal",TR:t.TR,initiative:t.attributes.Initiative,maxHp:"Underling"===t.template?1:t.attributes.HP,currentHp:"Underling"===t.template?1:t.attributes.HP,attributes:t.attributes,deeds:a,abilities:t.abilities,description:t.description,tags:t.tags,states:[]};p.push(r)}}),c({1:p}),w(1,p),u(!1)})()},[t,w,a,b]);let A=()=>{if(k)if(p+1>=C.length){let e=x+1;if(!o[e]){let t=JSON.parse(JSON.stringify(v));t.forEach(e=>{"player"===e.type&&(e.initiative=0,e.nat20=!1)}),c(a=>({...a,[e]:t})),w(e,t)}h(e),f(0)}else f(e=>e+1)},M=()=>{0===p&&x>1?(h(x-1),f(0)):p>0&&f(e=>e-1)},R=(0,r.useMemo)(()=>y[x]||{roll:0,text:""},[y,x]),L=(0,r.useCallback)(e=>{c(t=>{if(!t[x])return t;let a=(t[x]||[]).map(t=>t.id===e.id?e:t),s={...t,[x]:a};if("player"===e.type)for(let a=x+1;a<=Math.max(...Object.keys(t).map(Number));a++)s[a]&&(s[a]=s[a].map(t=>t.id===e.id?{...t,initiative:e.initiative,nat20:e.nat20}:t));return s})},[x]);return m?(0,s.jsx)("div",{className:"flex h-screen w-full items-center justify-center",children:(0,s.jsx)(F.E,{className:"h-48 w-48"})}):j?(0,s.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,s.jsxs)("header",{className:"py-4 px-6 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(q.A,{className:"text-primary h-8 w-8"}),(0,s.jsx)("h1",{className:"text-xl md:text-3xl font-headline font-bold text-primary-foreground whitespace-nowrap",children:t.name})]}),(0,s.jsx)(d.$,{variant:"destructive",onClick:a,children:"End Encounter"})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,s.jsx)(I,{combatantsInTurnOrder:C,untrackedPlayers:P,activeTurnId:(null==S?void 0:S.turnId)||null,round:x,onNextTurn:A,onPrevTurn:M,onCombatantUpdate:L,perilRoll:R.roll,perilText:R.text,allPlayersReady:k,turnIndex:p,onAddPlayer:N}),S?(0,s.jsx)(Y,{combatant:S,onUpdate:L},S.turnId):(0,s.jsx)("div",{className:"p-8 text-center text-muted-foreground flex items-center justify-center h-full rounded-lg bg-card",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,s.jsx)("p",{children:'Set player initiatives and press "Next" to begin.'})]})})]})]}):(0,s.jsx)(H.GB,{children:(0,s.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,s.jsxs)("header",{className:"py-4 px-6 md:px-8 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(H.x2,{}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(q.A,{className:"text-primary h-8 w-8"}),(0,s.jsx)("h1",{className:"text-2xl md:text-3xl font-headline font-bold text-primary-foreground",children:t.name})]})]}),(0,s.jsx)(d.$,{variant:"destructive",onClick:a,children:"End Encounter"})]}),(0,s.jsxs)("div",{className:"flex flex-1 min-h-0",children:[(0,s.jsx)(H.Bx,{style:{"--sidebar-width":"300px"},children:m?(0,s.jsx)(F.E,{className:"h-full w-full"}):(0,s.jsx)(I,{combatantsInTurnOrder:C,untrackedPlayers:P,activeTurnId:(null==S?void 0:S.turnId)||null,round:x,onNextTurn:A,onPrevTurn:M,onCombatantUpdate:L,perilRoll:R.roll,perilText:R.text,allPlayersReady:k,turnIndex:p,onAddPlayer:N})}),(0,s.jsx)(H.sF,{className:"flex-1 overflow-y-auto bg-background/50",children:(0,s.jsx)("div",{className:"p-4 sm:p-6 md:p-8 h-full",children:S?(0,s.jsx)(Y,{combatant:S,onUpdate:L},S.turnId):(0,s.jsx)("div",{className:"text-center text-muted-foreground flex items-center justify-center h-full",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,s.jsx)("p",{children:'Set player initiatives and press "Next" to begin.'})]})})})})]})]})})}},3585:(e,t,a)=>{a.d(t,{MY:()=>r,R1:()=>l,Uh:()=>n,p6:()=>o,vg:()=>i});var s=a(2489);let r=async()=>{let e=(await (0,s.Lf)()).transaction(s.yX,"readonly").objectStore(s.yX).getAll();return new Promise((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})},n=async e=>{let t=(await (0,s.Lf)()).transaction(s.yX,"readonly").objectStore(s.yX).get(e);return new Promise((e,a)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})},i=async e=>{let t=(await (0,s.Lf)()).transaction(s.yX,"readwrite").objectStore(s.yX),a=(0,s.$C)(),r={...e,id:a},n=t.add(r);return new Promise((e,t)=>{n.onsuccess=()=>e(a),n.onerror=()=>t(n.error)})},l=async e=>{let t=(await (0,s.Lf)()).transaction(s.yX,"readwrite").objectStore(s.yX).put(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})},o=async e=>{let t=(await (0,s.Lf)()).transaction(s.yX,"readwrite").objectStore(s.yX).delete(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})}},3930:(e,t,a)=>{a.d(t,{W$:()=>i,kO:()=>l,pT:()=>d,rp:()=>n,wz:()=>o,xy:()=>r});var s=a(2489);let r=async()=>{let e=(await (0,s.Lf)()).transaction(s.qi,"readonly").objectStore(s.qi).getAll();return new Promise((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})},n=async e=>{let t=(await (0,s.Lf)()).transaction(s.qi,"readonly").objectStore(s.qi).get(e);return new Promise((e,a)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})},i=async e=>{let t=(await (0,s.Lf)()).transaction(s.qi,"readwrite").objectStore(s.qi),a=(0,s.$C)(),r={...e,id:a},n=t.add(r);return new Promise((e,t)=>{n.onsuccess=()=>e(a),n.onerror=()=>t(n.error)})},l=async e=>{let t=(await (0,s.Lf)()).transaction(s.qi,"readwrite").objectStore(s.qi).put(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})},o=async e=>{let t=(await (0,s.Lf)()).transaction(s.qi,"readwrite").objectStore(s.qi).delete(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})},d=async e=>{if(!e||0===e.length)return[];let t=(await (0,s.Lf)()).transaction(s.qi,"readonly").objectStore(s.qi),a=[],r=e.map(e=>new Promise((s,r)=>{let n=t.get(e);n.onsuccess=()=>{n.result&&a.push(n.result),s()},n.onerror=()=>r(n.error)}));return await Promise.all(r),a}},4165:(e,t,a)=>{a.d(t,{Cf:()=>u,Es:()=>f,L3:()=>x,c7:()=>p,lG:()=>o,rr:()=>h,zM:()=>d});var s=a(5155),r=a(2115),n=a(5821),i=a(5318),l=a(9434);let o=n.bL,d=n.l9,c=n.ZL;n.bm;let m=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(n.hJ,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...r})});m.displayName=n.hJ.displayName;let u=r.forwardRef((e,t)=>{let{className:a,children:r,...o}=e;return(0,s.jsxs)(c,{children:[(0,s.jsx)(m,{}),(0,s.jsxs)(n.UC,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...o,children:[r,(0,s.jsxs)(n.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,s.jsx)(i.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});u.displayName=n.UC.displayName;let p=e=>{let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...a})};p.displayName="DialogHeader";let f=e=>{let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...a})};f.displayName="DialogFooter";let x=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(n.hE,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight",a),...r})});x.displayName=n.hE.displayName;let h=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(n.VY,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",a),...r})});h.displayName=n.VY.displayName},6535:(e,t,a)=>{a.d(t,{C8:()=>i,OG:()=>r,PW:()=>d,RW:()=>l,ZK:()=>o,s2:()=>n});var s=a(2489);let r=async()=>{let e=(await (0,s.Lf)()).transaction(s.RN,"readonly").objectStore(s.RN).getAll();return new Promise((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})},n=async e=>{let t=(await (0,s.Lf)()).transaction(s.RN,"readonly").objectStore(s.RN).get(e);return new Promise((e,a)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})},i=async e=>{if(!e||0===e.length)return[];let t=(await (0,s.Lf)()).transaction(s.RN,"readonly").objectStore(s.RN),a=[],r=e.map(e=>new Promise((s,r)=>{let n=t.get(e);n.onsuccess=()=>{n.result&&a.push(n.result),s()},n.onerror=()=>r(n.error)}));return await Promise.all(r),a},l=async e=>{let t=(await (0,s.Lf)()).transaction(s.RN,"readwrite").objectStore(s.RN),a=(0,s.$C)(),r={...e,id:a},n=t.add(r);return new Promise((e,t)=>{n.onsuccess=()=>e(a),n.onerror=()=>t(n.error)})},o=async e=>{let t=(await (0,s.Lf)()).transaction(s.RN,"readwrite").objectStore(s.RN).put(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})},d=async e=>{let t=(await (0,s.Lf)()).transaction(s.RN,"readwrite").objectStore(s.RN).delete(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})}},7189:(e,t,a)=>{a.d(t,{Fs:()=>i,H$:()=>l,ZJ:()=>o,eS:()=>r,eq:()=>n});var s=a(2489);let r=async()=>{let e=(await (0,s.Lf)()).transaction(s.l_,"readonly").objectStore(s.l_).getAll();return new Promise((t,a)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>a(e.error)})},n=async e=>{let t=(await (0,s.Lf)()).transaction(s.l_,"readonly").objectStore(s.l_).get(e);return new Promise((e,a)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})},i=async e=>{let t=(await (0,s.Lf)()).transaction(s.l_,"readwrite").objectStore(s.l_),a=(0,s.$C)(),r={...e,id:a},n=t.add(r);return new Promise((e,t)=>{n.onsuccess=()=>e(a),n.onerror=()=>t(n.error)})},l=async e=>{let t=(await (0,s.Lf)()).transaction(s.l_,"readwrite").objectStore(s.l_).put(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})},o=async e=>{let t=(await (0,s.Lf)()).transaction(s.l_,"readwrite").objectStore(s.l_).delete(e);return new Promise((e,a)=>{t.onsuccess=()=>e(),t.onerror=()=>a(t.error)})}},7262:(e,t,a)=>{a.d(t,{S:()=>o});var s=a(5155),r=a(2115),n=a(6981),i=a(518),l=a(9434);let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,s.jsx)(n.bL,{ref:t,className:(0,l.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...r,children:(0,s.jsx)(n.C1,{className:(0,l.cn)("flex items-center justify-center text-current"),children:(0,s.jsx)(i.A,{className:"h-4 w-4"})})})});o.displayName=n.bL.displayName},8911:(e,t,a)=>{a.d(t,{P:()=>i});var s=a(5155),r=a(9434),n=a(5057);let i=e=>{let{deed:t,dmgReplacement:a}=e,i=e=>{if(e)return a?e.replace(/\\dd/g,a):e},l="".concat(t.deedType," ").concat(t.actionType," VS ").concat(t.versus).toUpperCase(),o="".concat(l," | ").concat(t.target);return(0,s.jsxs)("div",{className:(0,r.cn)("rounded-lg border bg-card-foreground/5 border-l-4 p-4 mb-4",{light:"border-sky-400",heavy:"border-amber-400",mighty:"border-fuchsia-400"}[t.tier]),children:[(0,s.jsxs)("div",{className:"flex justify-between items-baseline mb-3",children:[(0,s.jsx)("h4",{className:"text-xl font-bold",children:t.name}),(0,s.jsx)("div",{className:(0,r.cn)("text-xs font-bold uppercase px-2 py-0.5 rounded-full",{light:"text-sky-300 bg-sky-900/50",heavy:"text-amber-300 bg-amber-900/50",mighty:"text-fuchsia-300 bg-fuchsia-900/50"}[t.tier]),children:t.tier})]}),(0,s.jsx)("div",{className:"text-sm text-muted-foreground mb-3 border-b border-t border-border py-2",children:(0,s.jsx)("p",{className:"text-foreground/90",children:o})}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[t.effects.start&&(0,s.jsxs)("div",{children:[(0,s.jsx)(n.J,{className:"text-primary-foreground/90 font-semibold uppercase",children:"Start"}),(0,s.jsx)("p",{className:"text-foreground/90 mt-0.5 whitespace-pre-wrap pl-2 font-light",children:i(t.effects.start)})]}),t.effects.base&&(0,s.jsxs)("div",{children:[(0,s.jsx)(n.J,{className:"text-primary-foreground/90 font-semibold uppercase",children:"Base"}),(0,s.jsx)("p",{className:"text-foreground/90 mt-0.5 whitespace-pre-wrap pl-2 font-light",children:i(t.effects.base)})]}),t.effects.hit&&(0,s.jsxs)("div",{children:[(0,s.jsx)(n.J,{className:"text-primary-foreground font-semibold uppercase",children:"Hit"}),(0,s.jsx)("p",{className:"text-foreground/90 mt-0.5 whitespace-pre-wrap pl-2 font-light",children:i(t.effects.hit)})]}),t.effects.shadow&&(0,s.jsxs)("div",{children:[(0,s.jsx)(n.J,{className:"text-primary-foreground font-semibold uppercase",children:"Shadow"}),(0,s.jsx)("p",{className:"text-foreground/90 mt-0.5 whitespace-pre-wrap pl-2 font-light",children:i(t.effects.shadow)})]}),t.effects.end&&(0,s.jsxs)("div",{children:[(0,s.jsx)(n.J,{className:"text-primary-foreground/90 font-semibold uppercase",children:"End"}),(0,s.jsx)("p",{className:"text-foreground/90 mt-0.5 whitespace-pre-wrap pl-2 font-light",children:i(t.effects.end)})]})]})]})}}}]);