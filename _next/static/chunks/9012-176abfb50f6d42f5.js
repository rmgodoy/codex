"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9012],{99012:(e,s,t)=>{t.r(s),t.d(s,{default:()=>ew});var l=t(95155),n=t(12115),r=t(46855),a=t(20031),i=t(53648),o=t(62523),c=t(30285),d=t(66424),u=t(22346),h=t(87481),x=t(34301),m=t(75074),j=t(20203),g=t(73926),p=t(85057),f=t(59409),v=t(90648);function N(e){let{onSelectDungeon:s,onNewDungeon:t,selectedDungeonId:r,dataVersion:a,filters:N,setFilters:y,onClearFilters:b}=e,[w,C]=(0,n.useState)([]),[k,S]=(0,n.useState)(!0),{toast:R}=(0,h.dj)();(0,n.useEffect)(()=>{(async()=>{S(!0);try{C(await (0,i.J0)())}catch(e){R({variant:"destructive",title:"Error",description:"Could not fetch dungeons from database."})}finally{S(!1)}})()},[a,R]);let I=(0,n.useMemo)(()=>{let e=w.filter(e=>{let s=e.name.toLowerCase().includes(N.searchTerm.toLowerCase()),t=!0,l=N.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);return l.length>0&&(t=!!e.tags&&l.every(s=>e.tags.some(e=>e.toLowerCase().includes(s)))),s&&t}).sort((e,s)=>{if("threatRating"===N.sortBy){var t,l;let n=(null!=(t=e.threatRating)?t:0)-(null!=(l=s.threatRating)?l:0);if(0!==n)return n}return e.name.localeCompare(s.name)});return"desc"===N.sortOrder&&e.reverse(),e},[w,N]);return(0,l.jsxs)("div",{className:"flex flex-col h-full",children:[(0,l.jsxs)("div",{className:"p-4 space-y-4",children:[(0,l.jsxs)(c.$,{onClick:t,className:"w-full",children:[(0,l.jsx)(x.A,{})," New Dungeon"]}),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)(m.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,l.jsx)(o.p,{placeholder:"Search dungeons...",value:N.searchTerm,onChange:e=>y.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)(p.J,{children:"Filter"}),(0,l.jsx)(c.$,{variant:"ghost",size:"sm",onClick:b,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,l.jsx)(v.F,{value:N.tagFilter?N.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>y.setTagFilter(e.join(",")),placeholder:"Tags...",tagSource:"dungeon"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)(p.J,{children:"Sort by"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)(f.l6,{value:N.sortBy,onValueChange:e=>y.setSortBy(e),children:[(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"Sort by"})}),(0,l.jsxs)(f.gC,{children:[(0,l.jsx)(f.eb,{value:"name",children:"Name"}),(0,l.jsx)(f.eb,{value:"threatRating",children:"Threat Rating"})]})]}),(0,l.jsxs)(c.$,{variant:"ghost",size:"icon",onClick:()=>y.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===N.sortOrder?(0,l.jsx)(j.A,{className:"h-4 w-4"}):(0,l.jsx)(g.A,{className:"h-4 w-4"}),(0,l.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,l.jsx)(u.w,{}),(0,l.jsx)(d.F,{className:"flex-1",children:(0,l.jsx)("div",{className:"p-4",children:k?(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading dungeons..."}):I.length>0?(0,l.jsx)("ul",{className:"space-y-1",children:I.map(e=>(0,l.jsx)("li",{children:(0,l.jsxs)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(r===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,l.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.threatRating,")"]})]})},e.id))}):(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"No dungeons found."})})})]})}var y=t(62177),b=t(90221),w=t(55594);let C={I:{name:"Bleak",targetNumber:10,threatRating:"2d6 x 10",threatRange:"20 to 120"},II:{name:"Sinister",targetNumber:12,threatRating:"2d6 x 20",threatRange:"40 to 240"},III:{name:"Frightening",targetNumber:15,threatRating:"2d6 x 30",threatRange:"60 to 360"},IV:{name:"Harrowing",targetNumber:18,threatRating:"2d6 x 40",threatRange:"80 to 480"},V:{name:"Nightmarish",targetNumber:20,threatRating:"2d6 x 50",threatRange:"100 to 600"}},k={Tiny:{rooms:"2D4 (~5)",treasureRoll:"2D6 X HOSTILITY"},Small:{rooms:"4D4 (~10)",treasureRoll:"4D6 X HOSTILITY"},Medium:{rooms:"6D4 (~15)",treasureRoll:"6D6 X HOSTILITY"},Large:{rooms:"8D4 (~20)",treasureRoll:"8D6 X HOSTILITY"},Huge:{rooms:"10D4 (~25)",treasureRoll:"10D6 X HOSTILITY"}},S=Object.keys(C),R=Object.keys(k);var I=t(66695),z=t(88539),A=t(90010),T=t(17759),M=t(18046),D=t(12543),E=t(21816),$=t(18763),V=t(77223),B=t(25318),F=t(81203),L=t(53054),O=t(32137),X=t(67805),Z=t(68856),P=t(47906),J=t(54165),W=t(47262),H=t(26126);let Y=w.z.object({instanceId:w.z.string(),roomId:w.z.string(),position:w.z.object({x:w.z.number(),y:w.z.number()})}),q=w.z.object({from:w.z.string().min(1,"A 'from' room must be selected."),to:w.z.string().min(1,"A 'to' room must be selected.")}),_=w.z.object({name:w.z.string().min(1,"Dungeon name is required"),description:w.z.string().optional(),hostility:w.z.enum(S),size:w.z.enum(R),threatRating:w.z.coerce.number(),treasureValue:w.z.coerce.number(),tags:w.z.array(w.z.string()).optional(),rooms:w.z.array(Y),connections:w.z.array(q)}),U=e=>{let{onAddRooms:s,existingRoomIds:t}=e,[r,a]=(0,n.useState)(!1),[u,h]=(0,n.useState)([]),[x,m]=(0,n.useState)(new Set),[j,g]=(0,n.useState)("");(0,n.useEffect)(()=>{r&&(0,i.SP)().then(h)},[r]);let p=(0,n.useMemo)(()=>u.filter(e=>e.name.toLowerCase().includes(j.toLowerCase())&&!t.has(e.id)),[u,j,t]);return(0,l.jsxs)(J.lG,{open:r,onOpenChange:a,children:[(0,l.jsx)(J.zM,{asChild:!0,children:(0,l.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",children:[(0,l.jsx)(M.A,{className:"h-4 w-4 mr-2"}),"Add Room"]})}),(0,l.jsxs)(J.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,l.jsx)(J.c7,{children:(0,l.jsx)(J.L3,{children:"Select Rooms"})}),(0,l.jsx)(o.p,{placeholder:"Search rooms...",value:j,onChange:e=>g(e.target.value),className:"mb-4 shrink-0"}),(0,l.jsx)(d.F,{className:"flex-1 border rounded-md p-2",children:(0,l.jsx)("div",{className:"space-y-1",children:p.map(e=>(0,l.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,l.jsx)(W.S,{id:"room-".concat(e.id),onCheckedChange:()=>m(s=>{let t=new Set(s);return t.has(e.id)?t.delete(e.id):t.add(e.id),t}),checked:x.has(e.id)}),(0,l.jsx)("label",{htmlFor:"room-".concat(e.id),className:"flex-1",children:(0,l.jsx)("p",{className:"font-semibold",children:e.name})})]},e.id))})}),(0,l.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,l.jsx)(c.$,{variant:"ghost",onClick:()=>a(!1),children:"Cancel"}),(0,l.jsx)(c.$,{onClick:()=>{s(u.filter(e=>x.has(e.id))),a(!1),m(new Set)},disabled:0===x.size,children:"Add Selected"})]})]})]})},G={name:"",description:"",hostility:"I",size:"Tiny",threatRating:0,treasureValue:0,tags:[],rooms:[],connections:[]};function K(e){let{dungeonId:s,isCreatingNew:t,onSaveSuccess:r,onDeleteSuccess:a,onEditCancel:d,onRunDungeon:x,onBack:m,dataVersion:j}=e,{toast:g}=(0,h.dj)(),[p,N]=(0,n.useState)(t),[w,J]=(0,n.useState)(!t&&!!s),[W,Y]=(0,n.useState)(null),[q,K]=(0,n.useState)([]),Q=(0,n.useMemo)(()=>new Map(q.map(e=>[e.id,e])),[q]),ee=(0,P.a)(),es=(0,y.mN)({resolver:(0,b.u)(_),defaultValues:G}),{control:et,watch:el,setValue:en,getValues:er}=es,{fields:ea,append:ei,remove:eo}=(0,y.jz)({control:et,name:"rooms"}),{fields:ec,append:ed,remove:eu}=(0,y.jz)({control:et,name:"connections"}),eh=el("rooms");(0,n.useEffect)(()=>{en("treasureValue",eh.reduce((e,s)=>{let t=Q.get(s.roomId);return e+((null==t?void 0:t.totalTreasureValue)||0)},0))},[eh,Q,en]),(0,n.useEffect)(()=>{(0,i.SP)().then(K)},[]),(0,n.useEffect)(()=>{(async()=>{if(t){es.reset(G),Y(null),N(!0),J(!1);return}if(!s){N(!1),J(!1),Y(null);return}J(!0),N(!1);try{let e=await (0,i.RT)(s);e?(es.reset(e),Y(e)):Y(null)}catch(e){g({variant:"destructive",title:"Error",description:"Could not load dungeon data."})}finally{J(!1)}})()},[s,t,es,g,j]);let ex=()=>{t?d():W&&(es.reset(W),N(!1))},em=async e=>{try{var l;let n={...e,tags:e.tags||[]};(null==(l=e.tags)?void 0:l.length)&&await (0,i.JE)(e.tags,"dungeon");let a=s;t?(a=await (0,i.yV)(n),g({title:"Dungeon Created!"})):s&&(await (0,i.sO)({...n,id:s}),g({title:"Save Successful"})),a&&r(a),N(!1)}catch(e){g({variant:"destructive",title:"Save Failed"})}},ej=async()=>{if(s)try{await (0,i.OO)(s),g({title:"Dungeon Deleted"}),a()}catch(e){g({variant:"destructive",title:"Deletion Failed"})}},eg=(0,n.useMemo)(()=>new Set(ea.map(e=>e.roomId)),[ea]),ep=el("hostility"),ef=el("size");return w?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(I.Zp,{children:[(0,l.jsx)(I.aR,{children:(0,l.jsx)(Z.E,{className:"h-8 w-48"})}),(0,l.jsx)(I.Wu,{children:(0,l.jsx)(Z.E,{className:"h-40 w-full"})})]})}):s||t?!p&&W?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(I.Zp,{children:[(0,l.jsx)(I.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[ee&&m&&(0,l.jsx)(c.$,{variant:"ghost",size:"icon",onClick:m,className:"shrink-0 -ml-2 -mt-1",children:(0,l.jsx)(D.A,{className:"h-5 w-5"})}),(0,l.jsxs)("div",{children:[(0,l.jsx)(I.ZB,{className:"text-3xl font-bold",children:W.name}),(0,l.jsxs)(I.BT,{className:"flex flex-wrap gap-x-4",children:[(0,l.jsxs)("span",{children:["Hostility: ",C[W.hostility].name]}),(0,l.jsxs)("span",{children:["Size: ",W.size]}),(0,l.jsxs)("span",{children:["TR: ",W.threatRating]}),(0,l.jsxs)("span",{children:["Treasure: ",W.treasureValue]})]})]})]}),(0,l.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,l.jsxs)(c.$,{variant:"default",size:"sm",onClick:()=>x(W.id),children:[(0,l.jsx)(E.A,{className:"h-4 w-4 mr-2"}),"Run"]}),(0,l.jsxs)(c.$,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[(0,l.jsx)($.A,{className:"h-4 w-4 mr-2"}),"Edit"]})]})]})}),(0,l.jsxs)(I.Wu,{className:"space-y-6",children:[W.description&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Description"}),(0,l.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:W.description})]}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:["Rooms (",W.rooms.length,")"]}),(0,l.jsx)("ul",{className:"list-disc pl-5 space-y-1",children:W.rooms.map(e=>{var s;return(0,l.jsx)("li",{className:"text-accent",children:(null==(s=Q.get(e.roomId))?void 0:s.name)||"Unknown Room"},e.instanceId)})})]}),W.tags&&W.tags.length>0&&(0,l.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:W.tags.map(e=>(0,l.jsx)(H.E,{variant:"secondary",children:e},e))})})]}),(0,l.jsx)(I.wL,{children:(0,l.jsxs)(A.Lt,{children:[(0,l.jsx)(A.tv,{asChild:!0,children:(0,l.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(V.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(A.EO,{children:[(0,l.jsxs)(A.wd,{children:[(0,l.jsx)(A.r7,{children:"Are you sure?"}),(0,l.jsxs)(A.$v,{children:['This will permanently delete "',W.name,'".']})]}),(0,l.jsxs)(A.ck,{children:[(0,l.jsx)(A.Zr,{children:"Cancel"}),(0,l.jsx)(A.Rx,{onClick:ej,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(I.Zp,{children:(0,l.jsx)(T.lV,{...es,children:(0,l.jsxs)("form",{onSubmit:es.handleSubmit(em),className:"space-y-6",children:[(0,l.jsx)(I.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[ee&&m&&(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:ex,className:"shrink-0 -ml-2",children:(0,l.jsx)(D.A,{className:"h-5 w-5"})}),(0,l.jsx)(I.ZB,{children:t?"Create New Dungeon":"Editing: ".concat(es.getValues("name")||"...")})]}),!ee&&(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:ex,className:"text-muted-foreground hover:text-foreground",children:(0,l.jsx)(B.A,{className:"h-5 w-5"})})]})}),(0,l.jsxs)(I.Wu,{className:"space-y-6",children:[(0,l.jsx)(T.zB,{name:"name",control:et,render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsx)(T.lR,{children:"Dungeon Name"}),(0,l.jsx)(T.MJ,{children:(0,l.jsx)(o.p,{...s})}),(0,l.jsx)(T.C5,{})]})}}),(0,l.jsx)(T.zB,{name:"description",control:et,render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsx)(T.lR,{children:"Description"}),(0,l.jsx)(T.MJ,{children:(0,l.jsx)(z.T,{...s,rows:3})})]})}}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,l.jsx)(T.zB,{control:et,name:"hostility",render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsx)(T.lR,{children:"Hostility"}),(0,l.jsxs)(f.l6,{onValueChange:s.onChange,defaultValue:s.value,children:[(0,l.jsx)(T.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{})})}),(0,l.jsx)(f.gC,{children:S.map(e=>(0,l.jsxs)(f.eb,{value:e,children:[e,": ",C[e].name]},e))})]}),(0,l.jsx)(T.C5,{})]})}}),(0,l.jsx)(T.zB,{control:et,name:"size",render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsx)(T.lR,{children:"Size"}),(0,l.jsxs)(f.l6,{onValueChange:s.onChange,defaultValue:s.value,children:[(0,l.jsx)(T.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{})})}),(0,l.jsx)(f.gC,{children:R.map(e=>(0,l.jsx)(f.eb,{value:e,children:e},e))})]}),(0,l.jsx)(T.C5,{})]})}})]}),(0,l.jsxs)(I.Zp,{className:"p-4 bg-muted/50",children:[(0,l.jsx)(I.aR,{className:"p-0 pb-2",children:(0,l.jsxs)(I.ZB,{className:"text-base flex items-center gap-2",children:[(0,l.jsx)(F.A,{className:"h-5 w-5"})," Target Values"]})}),(0,l.jsxs)(I.Wu,{className:"p-0 text-sm text-muted-foreground grid grid-cols-2 md:grid-cols-3 gap-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"Rooms: "}),k[ef].rooms]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"Treasure: "}),k[ef].treasureRoll]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"TR Range: "}),C[ep].threatRange]})]})]}),(0,l.jsx)(T.zB,{name:"tags",control:et,render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsxs)(T.lR,{className:"flex items-center gap-2",children:[(0,l.jsx)(L.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,l.jsx)(T.MJ,{children:(0,l.jsx)(v.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"dungeon"})}),(0,l.jsx)(T.C5,{})]})}}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[(0,l.jsx)(O.A,{className:"h-5 w-5"}),"Rooms"]}),(0,l.jsx)(U,{onAddRooms:e=>{let s=ea.length;e.forEach((e,t)=>{let l=s+t,n=130*Math.floor(l/4),r=l%4*200+(Math.random()-.5)*40,a=n+(Math.random()-.5)*40;ei({instanceId:crypto.randomUUID(),roomId:e.id,position:{x:r,y:a}})})},existingRoomIds:eg})]}),(0,l.jsxs)("div",{className:"space-y-2 pr-2",children:[ea.map((e,s)=>{var t;return(0,l.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-card-foreground/5 rounded-md",children:[(0,l.jsx)("p",{className:"flex-1 font-semibold",children:(null==(t=Q.get(e.roomId))?void 0:t.name)||"Unknown Room"}),(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>eo(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,l.jsx)(V.A,{className:"h-4 w-4"})})]},e.id)}),0===ea.length&&(0,l.jsx)("p",{className:"text-muted-foreground text-center text-sm py-4",children:"No rooms added."})]}),(0,l.jsx)(T.zB,{control:et,name:"treasureValue",render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{className:"mt-2",children:[(0,l.jsx)(T.lR,{children:"Total Treasure Value"}),(0,l.jsx)(T.MJ,{children:(0,l.jsx)(o.p,{type:"number",...s,readOnly:!0,className:"w-24 bg-muted border-none"})})]})}})]}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[(0,l.jsx)(X.A,{className:"h-5 w-5"}),"Connections"]}),(0,l.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",onClick:()=>ed({from:"",to:""}),disabled:ea.length<2,children:[(0,l.jsx)(M.A,{className:"h-4 w-4 mr-2"}),"Add Connection"]})]}),(0,l.jsxs)("div",{className:"space-y-2 pr-2",children:[ec.map((e,s)=>(0,l.jsxs)("div",{className:"grid grid-cols-[1fr_auto_1fr_auto] items-start gap-2 p-2 bg-card-foreground/5 rounded-md",children:[(0,l.jsx)(T.zB,{control:et,name:"connections.".concat(s,".from"),render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsxs)(f.l6,{onValueChange:s.onChange,value:s.value||"",children:[(0,l.jsx)(T.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"From Room..."})})}),(0,l.jsx)(f.gC,{children:ea.map(e=>{var s;return(0,l.jsx)(f.eb,{value:e.instanceId,children:(null==(s=Q.get(e.roomId))?void 0:s.name)||"..."},e.instanceId)})})]}),(0,l.jsx)(T.C5,{})]})}}),(0,l.jsx)("span",{className:"pt-2",children:"->"}),(0,l.jsx)(T.zB,{control:et,name:"connections.".concat(s,".to"),render:e=>{let{field:s}=e;return(0,l.jsxs)(T.eI,{children:[(0,l.jsxs)(f.l6,{onValueChange:s.onChange,value:s.value||"",children:[(0,l.jsx)(T.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"To Room..."})})}),(0,l.jsx)(f.gC,{children:ea.map(e=>{var s;return(0,l.jsx)(f.eb,{value:e.instanceId,children:(null==(s=Q.get(e.roomId))?void 0:s.name)||"..."},e.instanceId)})})]}),(0,l.jsx)(T.C5,{})]})}}),(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>eu(s),className:"text-muted-foreground hover:text-destructive shrink-0 self-center",children:(0,l.jsx)(V.A,{className:"h-4 w-4"})})]},e.id)),0===ec.length&&(0,l.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No connections added."})]})]})]}),(0,l.jsxs)(I.wL,{className:"flex items-center gap-2",children:[!t&&(0,l.jsxs)(A.Lt,{children:[(0,l.jsx)(A.tv,{asChild:!0,children:(0,l.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(V.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(A.EO,{children:[(0,l.jsxs)(A.wd,{children:[(0,l.jsx)(A.r7,{children:"Are you sure?"}),(0,l.jsxs)(A.$v,{children:['This will permanently delete "',er("name"),'".']})]}),(0,l.jsxs)(A.ck,{children:[(0,l.jsx)(A.Zr,{children:"Cancel"}),(0,l.jsx)(A.Rx,{onClick:ej,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,l.jsx)("div",{className:"flex-grow"}),!ee&&(0,l.jsx)(c.$,{type:"button",variant:"outline",onClick:ex,children:"Cancel"}),(0,l.jsx)(c.$,{type:"submit",children:t?"Create Dungeon":"Save Changes"})]})]})})})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(I.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,l.jsx)(I.Wu,{className:"text-center pt-6",children:(0,l.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select a dungeon to view or create one."})})})})}var Q=t(74211),ee=t(93306),es=t(77581),et=t(57916);t(11687);var el=t(88251),en=t.n(el),er=t(73336),ea=t(8531),ei=t(86438),eo=t(67554),ec=t(73503),ed=t(98917),eu=t(22945);function eh(e,s){var t,l,n,r,a,i;let{width:o,height:c,positionAbsolute:d}=e,u=s.positionAbsolute,h=(null!=o?o:0)/2,x=(null!=c?c:0)/2,m=(null!=(t=null==d?void 0:d.x)?t:0)+h,j=(null!=(l=null==d?void 0:d.y)?l:0)+x,g=(null!=(n=null==u?void 0:u.x)?n:0)+(null!=(r=s.width)?r:0)/2,p=(null!=(a=null==u?void 0:u.y)?a:0)+(null!=(i=s.height)?i:0)/2,f=(g-m)/(2*h)-(p-j)/(2*x),v=(g-m)/(2*h)+(p-j)/(2*x),N=1/(Math.abs(f)+Math.abs(v)),y=N*f,b=N*v;return{x:h*(y+b)+m,y:x*(-y+b)+j}}function ex(e,s){var t,l,n,r;let a={...e.positionAbsolute,...e},i=Math.round(null!=(t=a.x)?t:0),o=Math.round(null!=(l=a.y)?l:0),c=Math.round(s.x),d=Math.round(s.y);return c<=i+1?"left":c>=i+(null!=(n=a.width)?n:0)-1?"right":d<=o+1?"top":d>=o+(null!=(r=a.height)?r:0)-1?"bottom":"top"}let em=e=>{let{fromNode:s,toX:t,toY:n}=e;if(!s)return null;let{x:r,y:a}=function(e,s){var t,l,n,r,a,i;let{width:o,height:c,positionAbsolute:d}=e,u=s.positionAbsolute,h=(null!=o?o:0)/2,x=(null!=c?c:0)/2,m=(null!=(t=null==d?void 0:d.x)?t:0)+h,j=(null!=(l=null==d?void 0:d.y)?l:0)+x,g=(null!=(n=null==u?void 0:u.x)?n:0)+(null!=(r=s.width)?r:0)/2,p=(null!=(a=null==u?void 0:u.y)?a:0)+(null!=(i=s.height)?i:0)/2,f=(g-m)/(2*h)-(p-j)/(2*x),v=(g-m)/(2*h)+(p-j)/(2*x),N=1/(Math.abs(f)+Math.abs(v)),y=N*f,b=N*v;return{x:h*(y+b)+m,y:x*(-y+b)+j}}(s,{id:"target-node",width:1,height:1,positionAbsolute:{x:t,y:n}}),[i]=(0,Q.Fp)({sourceX:r,sourceY:a,sourcePosition:"bottom",targetX:t,targetY:n,targetPosition:"top"});return(0,l.jsxs)("g",{children:[(0,l.jsx)("path",{fill:"none",stroke:"hsl(var(--primary))",strokeWidth:1.5,className:"animated",d:i}),(0,l.jsx)("circle",{cx:t,cy:n,fill:"#fff",r:3,stroke:"hsl(var(--primary))",strokeWidth:1.5})]})},ej={visibility:"hidden"},eg={floating:function(e){let{id:s,source:t,target:r,markerEnd:a,style:i}=e,o=(0,Q.Pj)((0,n.useCallback)(e=>e.nodeInternals.get(t),[t])),c=(0,Q.Pj)((0,n.useCallback)(e=>e.nodeInternals.get(r),[r]));if(!o||!c)return null;let d=eh(o,c),u=eh(c,o),h=ex(o,d),x=ex(c,u),[m]=(0,Q.Fp)({sourceX:d.x,sourceY:d.y,sourcePosition:h,targetX:u.x,targetY:u.y,targetPosition:x});return(0,l.jsx)(Q.tE,{id:s,path:m,markerEnd:a,style:i})}},ep={dungeonRoom:function(e){let{data:s}=e;return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(Q.h7,{type:"source",position:Q.yX.Top,style:ej}),(0,l.jsx)(Q.h7,{type:"source",position:Q.yX.Right,style:ej}),(0,l.jsx)(Q.h7,{type:"source",position:Q.yX.Bottom,style:ej}),(0,l.jsx)(Q.h7,{type:"source",position:Q.yX.Left,style:ej}),(0,l.jsx)(Q.h7,{type:"target",position:Q.yX.Top,style:ej}),(0,l.jsx)(Q.h7,{type:"target",position:Q.yX.Right,style:ej}),(0,l.jsx)(Q.h7,{type:"target",position:Q.yX.Bottom,style:ej}),(0,l.jsx)(Q.h7,{type:"target",position:Q.yX.Left,style:ej}),(0,l.jsx)("div",{className:"w-full h-full flex items-center justify-center text-center p-2",children:s.label})]})}},ef=new(en()),ev={"elk.algorithm":"force","elk.force.iterations":"1000","elk.force.alpha":"1","elk.force.gravity":"0.01","elk.spacing.nodeNode":"120"},eN=(e,s)=>{let t={id:"root",layoutOptions:ev,children:e.map(e=>{var s,t;return{id:e.id,width:(null==(s=e.style)?void 0:s.width)||150,height:(null==(t=e.style)?void 0:t.height)||80}}),edges:s.map(e=>({id:e.id,sources:[e.source],targets:[e.target]}))};return ef.layout(t).then(s=>e.map(e=>{var t;let l=null==(t=s.children)?void 0:t.find(s=>s.id===e.id);return(null==l?void 0:l.x)&&(null==l?void 0:l.y)&&(null==l?void 0:l.width)&&(null==l?void 0:l.height)&&(e.position={x:l.x,y:l.y}),e})).catch(s=>(console.error("ELK layout error:",s),e))};function ey(e){var s;let{dungeon:t,onEndDungeon:r}=e,[a,o]=(0,n.useState)(!0),[x,m]=(0,n.useState)(null),[j,g]=(0,n.useState)(null),[p,f]=(0,n.useState)(null),[v,N]=(0,n.useState)(null),[y,b]=(0,n.useState)(0),[w,C]=(0,n.useState)([0]),{toast:k}=(0,h.dj)(),[S,R,z]=(0,Q.ck)([]),[A,T,$]=(0,Q.fM)([]),{fitView:V}=(0,Q.VH)(),B=(0,n.useCallback)(()=>{eN(S,A).then(e=>{R(e),window.requestAnimationFrame(()=>{V({duration:800,padding:.1})})})},[S,A,R,V]),F=Math.floor(y/3)+1,L=null!=(s=w[y])?s:0,O=e=>{let s=Math.max(0,Math.min(10,L+e)),t=[...w];t[y]=s,C(t)},X=(0,n.useCallback)((e,s)=>{if(!s){f(null),N(null);return}f(s.id),N(null)},[f,N]);(0,n.useEffect)(()=>{if(p){let e=new Set([p]);t.connections.forEach(s=>{s.from===p&&e.add(s.to),s.to===p&&e.add(s.from)}),setTimeout(()=>{V({nodes:Array.from(e).map(e=>({id:e})),duration:600,padding:.2})},10)}},[p,t.connections,V]),(0,n.useEffect)(()=>{(async()=>{o(!0);let e=await (0,i.SP)(),s=new Map(e.map(e=>[e.id,e])),t=e.flatMap(e=>e.features.flatMap(e=>e.encounterIds)),l=await Promise.all(t.map(e=>(0,i.eq)(e).catch(()=>null)));e.flatMap(e=>e.features.flatMap(e=>e.treasureIds));let n=await (0,i.h4)();e.flatMap(e=>e.features.flatMap(e=>e.alchemicalItemIds));let r=await (0,i.vV)();g({rooms:s,encounters:new Map(l.filter(e=>null!==e).map(e=>[e.id,e])),treasures:new Map(n.map(e=>[e.id,e])),alchemicalItems:new Map(r.map(e=>[e.id,e]))}),o(!1)})()},[t]);let P=(0,n.useMemo)(()=>t&&j?t.rooms.map(e=>{let s=j.rooms.get(e.roomId);return{id:e.instanceId,position:{x:0,y:0},data:{label:(null==s?void 0:s.name)||"Loading..."},style:{background:"hsl(var(--card))",color:"hsl(var(--card-foreground))",border:"2px solid",borderColor:"hsl(var(--border))",width:150,height:80,borderRadius:"var(--radius)",boxShadow:"0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)"},type:"dungeonRoom"}}):[],[t,j]),J=(0,n.useMemo)(()=>t?t.connections.map(e=>({id:"edge-".concat(e.from,"-").concat(e.to),source:e.from,target:e.to,type:"floating",style:{strokeWidth:2,stroke:"hsl(var(--border))"}})):[],[t]);(0,n.useEffect)(()=>{P.length>0&&eN(P,J).then(e=>{R(e),T(J),setTimeout(()=>{V({duration:800,padding:.1})},100)})},[P,J,R,T,V]),(0,n.useEffect)(()=>{R(e=>e.map(e=>{let s=e.id===p;return{...e,style:{...e.style,background:s?"hsl(var(--primary))":"hsl(var(--card))",color:s?"hsl(var(--primary-foreground))":"hsl(var(--card-foreground))",borderColor:s?"hsl(var(--ring))":"hsl(var(--border))"}}})),T(e=>e.map(e=>{let s=p&&(e.source===p||e.target===p);return{...e,animated:s,style:{...e.style,strokeWidth:s?2.5:1.5,stroke:s?"hsl(var(--primary))":"hsl(var(--border))"}}}))},[p,R,T]);let W=(0,n.useMemo)(()=>{if(!p||!j)return null;let e=t.rooms.find(e=>e.instanceId===p);return e?j.rooms.get(e.roomId):null},[p,t,j]),H=(0,n.useMemo)(()=>v&&j&&j.encounters.get(v)||null,[v,j]),Y=async e=>{let s=null==j?void 0:j.encounters.get(e);s?m(s):k({variant:"destructive",title:"Error",description:"Could not find encounter data."})};return x?(0,l.jsx)(er.A,{encounter:x,onEndEncounter:()=>m(null)}):a?(0,l.jsx)("div",{className:"flex h-screen w-full items-center justify-center",children:(0,l.jsx)(Z.E,{className:"h-48 w-48"})}):(0,l.jsxs)("div",{className:"flex flex-col h-screen w-full bg-background/50",children:[(0,l.jsxs)("header",{className:"py-4 px-6 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,l.jsx)("h1",{className:"text-xl md:text-3xl font-bold text-primary-foreground",children:t.name}),(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,l.jsx)("div",{className:"text-xs text-muted-foreground",children:"Alert"}),(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>{let e=[...w];e[y]=0,C(e)},title:"Reset Alert",children:(0,l.jsx)(ea.A,{className:"h-3 w-3"})})]}),(0,l.jsxs)("div",{className:"text-lg font-bold flex items-center gap-1",children:[(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>O(-1),disabled:L<=0,children:(0,l.jsx)(ei.A,{className:"h-4 w-4"})}),L,(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>O(1),disabled:L>=10,children:(0,l.jsx)(M.A,{className:"h-4 w-4"})})]})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"text-xs text-muted-foreground",children:"Round / Action"}),(0,l.jsxs)("div",{className:"text-lg font-bold",children:[F," / ",y%3+1]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>{b(e=>Math.max(0,e-1))},disabled:0===y,children:"Prev Action"}),(0,l.jsx)(c.$,{variant:"default",size:"sm",onClick:()=>{b(e=>{let s=e+1;return C(e=>{var t;let l=[...e],n=null!=(t=e[e.length-1])?t:0;return s>=l.length&&(l[s]=n),l}),s})},children:"Next Action"})]}),(0,l.jsx)(c.$,{variant:"outline",size:"icon",onClick:B,title:"Re-Layout",children:(0,l.jsx)(eo.A,{className:"h-4 w-4"})}),(0,l.jsx)(c.$,{variant:"destructive",onClick:r,children:"End Dungeon"})]})]}),(0,l.jsxs)("div",{className:"flex flex-1 min-h-0",children:[(W||H)&&(0,l.jsxs)("div",{className:"w-[380px] border-r border-border bg-card p-4 flex flex-col",children:[H?(0,l.jsxs)(c.$,{variant:"ghost",className:"self-start mb-2 -ml-2",onClick:()=>N(null),children:[(0,l.jsx)(D.A,{className:"h-4 w-4 mr-2"})," Back to Room Details"]}):(0,l.jsxs)(c.$,{variant:"ghost",className:"self-start mb-2 -ml-2",onClick:()=>{f(null),N(null)},children:[(0,l.jsx)(D.A,{className:"h-4 w-4 mr-2"})," Back to Dungeon View"]}),(0,l.jsx)(d.F,{className:"flex-1",children:H?(0,l.jsxs)(I.Zp,{children:[(0,l.jsxs)(I.aR,{children:[(0,l.jsx)(I.ZB,{children:H.name}),(0,l.jsxs)(I.BT,{children:["TR: ",H.totalTR]})]}),(0,l.jsxs)(I.Wu,{children:[(0,l.jsxs)(c.$,{className:"w-full",onClick:()=>Y(H.id),children:[(0,l.jsx)(E.A,{className:"h-4 w-4 mr-2"}),"Run Encounter"]}),(0,l.jsx)("p",{className:"mt-4 text-sm whitespace-pre-wrap",children:H.sceneDescription})]})]}):W?(0,l.jsxs)(I.Zp,{children:[(0,l.jsxs)(I.aR,{children:[(0,l.jsx)(I.ZB,{children:W.name}),(0,l.jsx)(I.BT,{children:W.size})]}),(0,l.jsxs)(I.Wu,{className:"space-y-4",children:[(0,l.jsx)("p",{children:W.description}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h4",{className:"font-semibold mb-2",children:"Features"}),W.features.map(e=>(0,l.jsxs)("div",{className:"p-2 border-b",children:[(0,l.jsx)("p",{className:"font-bold",children:e.title}),(0,l.jsx)("p",{className:"text-sm text-muted-foreground",children:e.description}),e.encounterIds.map(e=>{var s;return(0,l.jsxs)(c.$,{variant:"link",className:"p-0 h-auto text-accent",onClick:()=>N(e),children:[(0,l.jsx)(ec.A,{className:"h-4 w-4 mr-1"}),null==j||null==(s=j.encounters.get(e))?void 0:s.name]},e)}),e.treasureIds.map(e=>{var s;return(0,l.jsxs)("p",{className:"text-sm flex items-center gap-1",children:[(0,l.jsx)(ed.A,{className:"h-4 w-4"}),null==j||null==(s=j.treasures.get(e))?void 0:s.name]},e)}),e.alchemicalItemIds.map(e=>{var s;return(0,l.jsxs)("p",{className:"text-sm flex items-center gap-1",children:[(0,l.jsx)(eu.A,{className:"h-4 w-4"}),null==j||null==(s=j.alchemicalItems.get(e))?void 0:s.name]},e)})]},e.id))]})]})]}):null})]}),(0,l.jsx)("div",{className:"flex-1 relative overflow-hidden bg-gradient-to-br from-background to-muted/20",children:(0,l.jsxs)(Q.Gc,{nodes:S,edges:A,onNodesChange:z,onEdgesChange:$,onNodeClick:X,onPaneClick:()=>X(null,null),fitView:!0,nodesDraggable:!0,nodeTypes:ep,edgeTypes:eg,connectionLineComponent:em,children:[(0,l.jsx)(ee.H,{}),(0,l.jsx)(es.o,{pannable:!0,zoomable:!0,nodeStrokeWidth:3,nodeColor:e=>{var s;return(null==(s=e.style)?void 0:s.background)||"#fff"}}),(0,l.jsx)(et.V,{variant:"dots",gap:16,size:1})]})})]})]})}function eb(e){return(0,l.jsx)(Q.Ln,{children:(0,l.jsx)(ey,{...e})})}function ew(){let[e,s]=(0,n.useState)("preparation"),[t,o]=(0,n.useState)(null),[c,d]=(0,n.useState)(null),[u,x]=(0,n.useState)(!1),[m,j]=(0,n.useState)(0),[g,p]=(0,n.useState)(""),[f,v]=(0,n.useState)(""),[y,b]=(0,n.useState)("name"),[w,C]=(0,n.useState)("asc"),[k,S]=(0,n.useState)(!1),R=(0,P.a)(),[I,z]=(0,n.useState)("list");(0,n.useEffect)(()=>{S(!0)},[]);let A={searchTerm:g,tagFilter:f,sortBy:y,sortOrder:w},T={setSearchTerm:p,setTagFilter:v,setSortBy:b,setSortOrder:C},M=()=>{p(""),v(""),b("name"),C("asc")},D=()=>j(e=>e+1),E=e=>{o(e),x(!1),R&&z("editor")},$=()=>{o(null),x(!0),R&&z("editor")},V=e=>{D(),o(e),x(!1),R&&z("editor")},B=()=>{D(),o(null),x(!1),R&&z("list")},F=()=>{u&&(x(!1),o(null),R&&z("list"))},{toast:L}=(0,h.dj)(),O=async e=>{try{let t=await (0,i.RT)(e);t?(d(t),s("live")):L({variant:"destructive",title:"Error",description:"Could not find dungeon to run."})}catch(e){L({variant:"destructive",title:"Error",description:"Failed to load dungeon data."})}};return"live"===e&&c?(0,l.jsx)(eb,{dungeon:c,onEndDungeon:()=>{d(null),s("preparation")}}):k?R?(0,l.jsx)(r.A,{children:(0,l.jsx)("div",{className:"h-full w-full",children:"list"===I?(0,l.jsx)(N,{onSelectDungeon:E,onNewDungeon:$,selectedDungeonId:t,dataVersion:m,filters:A,setFilters:T,onClearFilters:M}):(0,l.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,l.jsx)("div",{className:"p-4 sm:p-6",children:(0,l.jsx)(K,{dungeonId:t,isCreatingNew:u,onSaveSuccess:V,onDeleteSuccess:B,onEditCancel:F,onRunDungeon:O,onBack:()=>{z("list"),o(null),x(!1)},dataVersion:m},null!=t?t:u?"new":"placeholder")})})})}):(0,l.jsx)(a.SidebarProvider,{children:(0,l.jsx)(r.A,{children:(0,l.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,l.jsx)(a.Bx,{style:{"--sidebar-width":"380px"},children:(0,l.jsx)(N,{onSelectDungeon:E,onNewDungeon:$,selectedDungeonId:t,dataVersion:m,filters:A,setFilters:T,onClearFilters:M})}),(0,l.jsx)(a.sF,{className:"flex-1 overflow-y-auto",children:(0,l.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,l.jsx)(K,{dungeonId:t,isCreatingNew:u,onSaveSuccess:V,onDeleteSuccess:B,onEditCancel:F,onRunDungeon:O,dataVersion:m},null!=t?t:u?"new":"placeholder")})})]})})}):null}}}]);