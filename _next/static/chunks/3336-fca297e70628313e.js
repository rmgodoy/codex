"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3336],{8643:(e,t,a)=>{a.d(t,{Ke:()=>r,Nt:()=>i,R6:()=>n});var s=a(27242);let i=s.bL,n=s.R6,r=s.Ke},47262:(e,t,a)=>{a.d(t,{S:()=>d});var s=a(95155),i=a(12115),n=a(76981),r=a(10518),l=a(59434);let d=i.forwardRef((e,t)=>{let{className:a,...i}=e;return(0,s.jsx)(n.bL,{ref:t,className:(0,l.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...i,children:(0,s.jsx)(n.C1,{className:(0,l.cn)("flex items-center justify-center text-current"),children:(0,s.jsx)(r.A,{className:"h-4 w-4"})})})});d.displayName=n.bL.displayName},73336:(e,t,a)=>{a.d(t,{A:()=>F});var s=a(95155),i=a(12115),n=a(53648),r=a(66424),l=a(30285),d=a(77381),o=a(79556),c=a(13896),m=a(91721),u=a(73503),x=a(28274),p=a(62523),h=a(47262),f=a(85057),y=a(22346),j=a(54165),g=a(8643),b=a(59434);function v(e){let{combatantsInTurnOrder:t,defeatedCombatants:a,selectedCombatantId:n,onSelectCombatant:v,round:N,onNextRound:w,onPrevRound:k,onCombatantUpdate:C,onRevive:I,perilRoll:A,perilText:S,onAddPlayer:M}=e,[R,E]=(0,i.useState)({}),[H,B]=(0,i.useState)(""),[P,T]=(0,i.useState)(!1),U=(0,i.useMemo)(()=>t.filter(e=>"player"===e.type),[t]);(0,i.useEffect)(()=>{let e={};U.forEach(t=>{void 0!==t.initiative&&null!==t.initiative&&(e[t.id]=t.initiative>0?String(t.initiative):"")}),E(e)},[U,N]);let Y=(e,t)=>{E(a=>({...a,[e]:t}))},D=e=>{let t=U.find(t=>t.id===e);if(!t)return;let a=parseInt(R[e],10)||0;t&&(void 0===t.initiative||t.initiative!==a)&&C({...t,initiative:a})},F=(e,t)=>{C({...e,nat20:t})},$=()=>{M&&H.trim()&&(M(H.trim()),B(""),T(!1))};return(0,s.jsxs)("div",{className:"flex flex-col h-full p-4 bg-card",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Round"}),(0,s.jsx)("p",{className:"text-4xl font-bold",children:N})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(l.$,{onClick:k,variant:"outline",size:"icon",disabled:1===N,children:[(0,s.jsx)(d.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Previous Round"})]}),(0,s.jsxs)(l.$,{onClick:w,variant:"default",size:"icon",children:[(0,s.jsx)(o.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Next Round"})]})]}),(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"Peril"}),(0,s.jsx)("p",{className:"text-4xl font-bold",children:A})]})]}),(0,s.jsx)("p",{className:"text-center text-sm font-semibold text-muted-foreground -mt-2 mb-4",children:S}),(0,s.jsx)(y.w,{className:"my-2"}),(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"Initiative Order"}),M&&(0,s.jsxs)(j.lG,{open:P,onOpenChange:T,children:[(0,s.jsx)(j.zM,{asChild:!0,children:(0,s.jsxs)(l.$,{variant:"outline",size:"sm",children:[(0,s.jsx)(c.A,{className:"h-4 w-4 mr-2"})," Add Player"]})}),(0,s.jsxs)(j.Cf,{className:"sm:max-w-[425px]",children:[(0,s.jsx)(j.c7,{children:(0,s.jsx)(j.L3,{children:"Add New Player"})}),(0,s.jsx)("div",{className:"grid gap-4 py-4",children:(0,s.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,s.jsx)(f.J,{htmlFor:"name",className:"text-right",children:"Name"}),(0,s.jsx)(p.p,{id:"name",value:H,onChange:e=>B(e.target.value),className:"col-span-3",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),$())},autoFocus:!0})]})}),(0,s.jsx)(j.Es,{children:(0,s.jsx)(l.$,{onClick:$,children:"Add Player"})})]})]})]}),(0,s.jsx)(r.F,{className:"flex-1",children:t.length>0?(0,s.jsx)("ul",{className:"space-y-2 pr-4",children:t.map(e=>(0,s.jsx)("li",{children:(0,s.jsxs)("div",{onClick:()=>v(e.id),className:(0,b.cn)("w-full text-left p-3 rounded-lg border-l-4 transition-all cursor-pointer",n===e.id?"bg-primary/20 border-primary shadow-md":"bg-background border-transparent hover:bg-muted"),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:["player"===e.type?(0,s.jsx)(m.A,{className:"h-5 w-5 text-accent"}):(0,s.jsx)(u.A,{className:"h-5 w-5 text-accent"}),(0,s.jsx)("span",{className:"font-semibold",children:e.name})]}),"player"===e.type?(0,s.jsx)(p.p,{type:"number",value:R[e.id]||"",onChange:t=>Y(e.id,t.target.value),onBlur:()=>D(e.id),onClick:e=>e.stopPropagation(),className:"w-20 h-8",min:"0"}):(0,s.jsx)("span",{className:"font-bold text-lg",children:e.initiative})]}),"player"===e.type&&(0,s.jsxs)("div",{className:"flex items-center gap-2 mt-2 pl-8",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)(h.S,{id:"nat20-".concat(e.id),checked:e.nat20,onCheckedChange:t=>F(e,!!t)}),(0,s.jsx)(f.J,{htmlFor:"nat20-".concat(e.id),children:"Nat 20"})]})]})},e.turnId))}):(0,s.jsx)("p",{className:"text-muted-foreground text-center pt-4",children:"Waiting for players..."})}),a.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(y.w,{className:"my-2"}),(0,s.jsxs)(g.Nt,{children:[(0,s.jsx)(g.R6,{asChild:!0,children:(0,s.jsxs)(l.$,{variant:"ghost",className:"w-full justify-between",children:["Defeated (",a.length,")",(0,s.jsx)(o.A,{className:"h-4 w-4"})]})}),(0,s.jsx)(g.Ke,{children:(0,s.jsx)(r.F,{className:"flex-1",children:(0,s.jsx)("ul",{className:"space-y-2 pr-4 pt-2",children:a.map(e=>(0,s.jsx)("li",{className:"p-3 rounded-lg bg-destructive/10",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(u.A,{className:"h-5 w-5 text-destructive/80"}),(0,s.jsx)("span",{className:"font-semibold text-destructive/80 line-through",children:e.name})]}),(0,s.jsxs)(l.$,{size:"sm",variant:"outline",onClick:()=>I(e.id),children:[(0,s.jsx)(x.A,{className:"h-4 w-4 mr-2"})," Revive"]})]})},e.id))})})})]})]})]})}var N=a(66695),w=a(68098),k=a(21887),C=a(10518),I=a(77223),A=a(88911);let S=[{name:"Accurate",description:"You take an intensity bonus to accuracy checks. Cancels out inaccurate.",effects:[{attribute:"Accuracy",modifier:"bonus"}]},{name:"Inaccurate",description:"You take an intensity penalty to accuracy checks. Cancels out accurate.",effects:[{attribute:"Accuracy",modifier:"penalty"}]},{name:"Bleeding",description:"You suffer intensity damage when you move, jump, teleport, or are forced to move. You only take this damage once per instance of movement, even if you move multiple squares as part of that movement."},{name:"Burning",description:"You suffer (intensity)d6 damage at the start of your turn, up to a maximum of three dice. Then the intensity increases by +1."},{name:"Delirious",description:"At the start of your turn, roll (intensity)d6, up to a maximum of three dice. For each result, perform the listed action, spending the required action point: 1: fling something at the nearest creature (damage) 2: hurt yourself and suffer damage 3: stumble half your speed in a random direction 4: stare blankly and do nothing 5 or 6: no effect"},{name:"Fortified",description:"Damage you take from attacks is reduced by intensity. Cancels out frail."},{name:"Frail",description:"Damage you take from attacks is increased by intensity. Cancels out fortified."},{name:"Guarded",description:"You gain an intensity bonus to guard checks. Cancels out unguarded.",effects:[{attribute:"Guard",modifier:"bonus"}]},{name:"Unguarded",description:"You take an intensity penalty to guard checks. Cancels out guarded.",effects:[{attribute:"Guard",modifier:"penalty"}]},{name:"Hastened",description:"You gain an intensity bonus to initiative checks. Cancels out hindered.",effects:[{attribute:"Initiative",modifier:"bonus"}]},{name:"Hindered",description:"You take an intensity penalty to initiative checks. Cancels out hastened.",effects:[{attribute:"Initiative",modifier:"penalty"}]},{name:"Mending",description:"You regain intensity hit points at the start of your turn. Cancels out poisoned."},{name:"Poisoned",description:"You suffer intensity damage at the start of your turn. Cancels out mending."},{name:"Provoked",description:"You take an intensity penalty to attacks that do not include the provoking creature as a target. If a different creature confers this state on you, it becomes the provoking creature."},{name:"Sleeping",description:"You also gain toppled when you gain this condition. You take no turn, but you make one free prevail against this state at the end of each round. After waking, you cannot take a turn until the following round. This state ends immediately if you suffer damage."},{name:"Slow",description:"You take an intensity penalty to speed. Cancels out swift.",effects:[{attribute:"Speed",modifier:"penalty"}]},{name:"Swift",description:"You gain an intensity bonus to speed. Cancels out slow.",effects:[{attribute:"Speed",modifier:"bonus"}]},{name:"Toppled",description:"You have -2 accuracy and guard, and you move at half speed. You can end this state by spending an action to stand up. If this state has an intensity, you must prevail to stand up instead.",effects:[{attribute:"Accuracy",modifier:"fixed",value:-2},{attribute:"Guard",modifier:"fixed",value:-2},{attribute:"Speed",modifier:"halve"}]},{name:"Strong",description:"You gain an intensity bonus to damage rolls on attacks. Cancels out weak.",effects:[{attribute:"rollBonus",modifier:"bonus"}]},{name:"Weak",description:"You take an intensity penalty to damage rolls on attacks. Cancels out strong.",effects:[{attribute:"rollBonus",modifier:"penalty"}]},{name:"Weary",description:"You take an intensity penalty to resist checks. Cancels out willful.",effects:[{attribute:"Resist",modifier:"penalty"}]},{name:"Willful",description:"You take an intensity bonus to resist checks. Cancels out weary.",effects:[{attribute:"Resist",modifier:"bonus"}]}];var M=a(14636);let R=e=>{let{label:t,modified:a,original:i,isBonus:n}=e,r=a!==i,l="number"==typeof a&&"number"==typeof i?a-i:0,d="";return r&&(d=n&&l>0||!n&&l<0?"text-green-400":"text-red-400"),(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center p-2 rounded-lg bg-card-foreground/5 min-w-[80px]",children:[(0,s.jsx)(f.J,{className:"text-xs",children:t}),r?(0,s.jsxs)("p",{className:"text-lg font-bold",children:[(0,s.jsx)("span",{className:d,children:a}),(0,s.jsx)("span",{className:"text-muted-foreground text-xs ml-1 line-through",children:i})]}):(0,s.jsx)("p",{className:"text-lg font-bold",children:i})]})};function E(e){let{combatant:t,onUpdate:a}=e,[n,d]=(0,i.useState)(""),[o,c]=(0,i.useState)(""),[m,u]=(0,i.useState)(""),[x,h]=(0,i.useState)(!1),{modifiedAttributes:j,originalAttributes:g}=(0,i.useMemo)(()=>{if("player"===t.type||!t.states)return{modifiedAttributes:null,originalAttributes:null};let e={...t.attributes},a={...t.attributes};return t.states.forEach(e=>{e.effects&&e.effects.forEach(t=>{switch(t.modifier){case"bonus":case"penalty":{let s=e.intensity*("bonus"===t.modifier?1:-1);"number"==typeof a[t.attribute]&&(a[t.attribute]+=s);break}case"fixed":"number"==typeof a[t.attribute]&&(a[t.attribute]+=t.value);break;case"halve":"Speed"===t.attribute&&(a.Speed=Math.floor(a.Speed/2))}})}),{modifiedAttributes:a,originalAttributes:e}},[t]),v=(0,i.useMemo)(()=>S.filter(e=>e.name.toLowerCase().includes(m.toLowerCase())),[m]);if("player"===t.type)return(0,s.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,s.jsxs)(N.Zp,{children:[(0,s.jsxs)(N.aR,{children:[(0,s.jsx)(N.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),(0,s.jsx)(N.BT,{children:"Player Character"})]}),(0,s.jsx)(N.Wu,{children:(0,s.jsx)("p",{className:"text-muted-foreground text-center py-8",children:"Player turn. No stats to display."})})]})});let E=()=>{if(!n)return;let e=0;if(!isNaN(e=n.startsWith("+")||n.startsWith("-")?parseInt(n,10):parseInt(n,10)-t.currentHp)){let s=t.currentHp+e;"Underling"===t.template&&(s=Math.min(1,Math.max(0,s))),a({...t,currentHp:s})}d("")},H=e=>{let s=t.attributes.Initiative;e.forEach(e=>{"Hastened"===e.name?s+=e.intensity:"Hindered"===e.name&&(s-=e.intensity)}),a({...t,states:e,initiative:s})},B=(e,a,s)=>{H(t.states.map(t=>t.id===e?{...t,[a]:s}:t))},P=e=>{H(t.states.filter(t=>t.id!==e))},T=(e,a)=>{H(t.states.map(t=>t.id===e?{...t,...a}:t))};return(0,s.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,s.jsxs)(N.Zp,{children:[(0,s.jsxs)(N.aR,{children:[(0,s.jsx)("div",{className:"flex justify-between items-start",children:(0,s.jsxs)("div",{children:[(0,s.jsx)(N.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),"monster"===t.type&&(0,s.jsxs)(N.BT,{children:["Lvl ",t.level," ",t.template," ",t.role," • TR ",t.TR]})]})}),("Paragon"===t.template||"Tyrant"===t.template)&&(0,s.jsxs)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Extra Turn:"})," This creature takes an additional turn at the end of the round."]}),(0,s.jsx)("p",{children:"Immune to effects that delay its turn (loses an action point on its next turn instead)."})]}),"Tyrant"===t.template&&(0,s.jsx)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Unstoppable:"})," Can make a free prevail check against one state at the end of each round."]})})]}),(0,s.jsxs)(N.Wu,{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(f.J,{htmlFor:"hp",className:"flex items-center gap-2 text-lg shrink-0",children:[(0,s.jsx)(w.A,{className:"h-6 w-6 text-red-500"})," HP"]}),(0,s.jsx)(p.p,{id:"hp",type:"number",value:t.currentHp,onChange:e=>{let s=parseInt(e.target.value,10)||0;"Underling"===t.template&&(s=Math.min(1,Math.max(0,s))),a({...t,currentHp:s})},className:"w-24 text-lg font-bold"}),"monster"===t.type&&(0,s.jsxs)("span",{className:"text-muted-foreground text-lg",children:["/ ",t.maxHp]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[180px]",children:[(0,s.jsx)(p.p,{placeholder:"+5 or -10",value:n,onChange:e=>d(e.target.value),onKeyDown:e=>"Enter"===e.key&&E(),className:"flex-1"}),(0,s.jsx)(l.$,{onClick:E,size:"sm",children:"Apply"})]})]}),"monster"===t.type&&j&&g&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(y.w,{}),(0,s.jsx)("div",{className:"w-full overflow-x-auto pb-2",children:(0,s.jsxs)("div",{className:"flex flex-nowrap md:grid md:grid-cols-7 gap-2",children:[(0,s.jsx)(R,{label:"Speed",modified:j.Speed,original:g.Speed}),(0,s.jsx)(R,{label:"Accuracy",modified:j.Accuracy,original:g.Accuracy,isBonus:!0}),(0,s.jsx)(R,{label:"Guard",modified:j.Guard,original:g.Guard,isBonus:!0}),(0,s.jsx)(R,{label:"Resist",modified:j.Resist,original:g.Resist,isBonus:!0}),(0,s.jsx)(R,{label:"Roll Bonus",modified:j.rollBonus>0?"+".concat(j.rollBonus):j.rollBonus,original:g.rollBonus>0?"+".concat(g.rollBonus):g.rollBonus,isBonus:!0}),(0,s.jsx)(R,{label:"DMG",modified:t.attributes.DMG,original:t.attributes.DMG}),(0,s.jsx)(R,{label:"Initiative",modified:j.Initiative,original:g.Initiative,isBonus:!0})]})})]}),(0,s.jsx)(y.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"flex justify-between items-center mb-4",children:(0,s.jsx)("h3",{className:"text-xl font-semibold text-foreground",children:"States"})}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[(0,s.jsxs)(M.AM,{open:x,onOpenChange:h,children:[(0,s.jsx)(M.Wv,{asChild:!0,children:(0,s.jsxs)(l.$,{variant:"outline",role:"combobox","aria-expanded":x,className:"flex-1 min-w-[180px] justify-between",children:[o||"Select a common state...",(0,s.jsx)(k.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,s.jsxs)(M.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:[(0,s.jsx)("div",{className:"p-2 border-b",children:(0,s.jsx)(p.p,{placeholder:"Search states...",value:m,onChange:e=>u(e.target.value),className:"h-9",autoFocus:!0})}),(0,s.jsx)(r.F,{className:"h-[200px]",children:(0,s.jsx)("div",{className:"p-1",children:v.length>0?v.map(e=>(0,s.jsxs)(l.$,{variant:"ghost",className:(0,b.cn)("w-full justify-start font-normal h-auto py-2",o===e.name&&"bg-accent"),onClick:()=>{c(e.name),h(!1),u("")},children:[(0,s.jsx)(C.A,{className:(0,b.cn)("mr-2 h-4 w-4",o===e.name?"opacity-100":"opacity-0")}),e.name]},e.name)):(0,s.jsx)("p",{className:"text-center text-sm text-muted-foreground p-4",children:"No state found."})})})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(l.$,{onClick:()=>{let e=S.find(e=>e.name===o);if(!e)return;let a={id:crypto.randomUUID(),name:e.name,intensity:1,description:e.description,effects:e.effects};H([...t.states,a]),c("")},disabled:!o,children:[(0,s.jsx)("span",{className:"sm:hidden",children:"Add"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Add State"})]}),(0,s.jsx)(y.w,{orientation:"vertical",className:"h-6"}),(0,s.jsxs)(l.$,{variant:"outline",onClick:()=>{let e={id:crypto.randomUUID(),name:"New State",intensity:1};H([...t.states,e])},children:[(0,s.jsx)("span",{className:"sm:hidden",children:"Custom"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Add Custom"})]})]})]}),(0,s.jsx)("div",{className:"space-y-3",children:t.states.length>0?t.states.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-card-foreground/5 rounded-lg",children:[(0,s.jsx)(p.p,{value:e.name,onChange:t=>T(e.id,{name:t.target.value,effects:void 0,description:void 0}),className:"flex-1 font-semibold min-w-0",disabled:!!S.find(t=>t.name===e.name)}),(0,s.jsx)(f.J,{htmlFor:"intensity-".concat(e.id),className:"hidden sm:inline shrink-0",children:"Intensity"}),(0,s.jsx)(p.p,{id:"intensity-".concat(e.id),type:"number",min:"0",value:e.intensity,onChange:t=>B(e.id,"intensity",Math.max(0,parseInt(t.target.value,10)||0)),className:"w-20 shrink-0"}),(0,s.jsx)(l.$,{variant:"ghost",size:"icon",onClick:()=>P(e.id),className:"shrink-0",children:(0,s.jsx)(I.A,{className:"h-4 w-4 text-destructive"})})]},e.id)):(0,s.jsx)("p",{className:"text-muted-foreground text-center",children:"No active states."})})]}),"monster"===t.type&&t.abilities&&t.abilities.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(y.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-foreground my-4",children:"Abilities"}),(0,s.jsx)("div",{className:"space-y-2 text-foreground/90 whitespace-pre-wrap",children:t.abilities.map(e=>(0,s.jsxs)("p",{children:[(0,s.jsxs)("span",{className:"font-bold",children:[e.name,":"]})," ",e.description]},e.id))})]})]}),"monster"===t.type&&t.deeds.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(y.w,{}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-foreground mb-4",children:"Deeds"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.deeds.map((e,a)=>(0,s.jsx)(A.P,{deed:e,dmgReplacement:t.attributes.DMG},"".concat(e.id,"-").concat(a)))})]})]})]})]})})}var H=a(20031),B=a(21816),P=a(68856),T=a(47906),U=a(87481);let Y=e=>{if(!e)return 1;let t=e.toLowerCase().trim(),a=t.match(/(\d*)d(\d+)/);if(a){let e=a[1]?parseInt(a[1],10):1,t=parseInt(a[2],10);if(!isNaN(e)&&!isNaN(t)&&t>0){let a=0;for(let s=0;s<e;s++)a+=Math.floor(Math.random()*t)+1;return a}}let s=parseInt(t,10);return!isNaN(s)&&s>0?s:1},D=e=>{if(!e||0===e.length)return[];let t=e.filter(e=>"player"===e.type||"monster"===e.type&&e.currentHp>0),a=t.filter(e=>"player"===e.type),s=t.filter(e=>"monster"===e.type),i=(e,t)=>(t.initiative||0)-(e.initiative||0),n=a.filter(e=>e.nat20).sort(i),r=a.filter(e=>!e.nat20),l=s.length>0?Math.max(...s.map(e=>e.initiative)):-1/0,d=r.filter(e=>(e.initiative||0)>=l).sort(i),o=r.filter(e=>(e.initiative||0)<l).sort(i),c=[...s].sort(i),m=s.filter(e=>"Paragon"===e.template||"Tyrant"===e.template).sort(i);return[...n.map(e=>({...e,turnId:"".concat(e.id,"-start")})),...d.map(e=>({...e,turnId:e.id})),...c.map(e=>({...e,turnId:e.id})),...o.map(e=>({...e,turnId:e.id})),...n.map(e=>({...e,turnId:"".concat(e.id,"-end")})),...m.map(e=>({...e,turnId:"".concat(e.id,"-extra")}))]};function F(e){let{encounter:t,onEndEncounter:a}=e,[r,d]=(0,i.useState)({}),[o,c]=(0,i.useState)(!0),[m,u]=(0,i.useState)(1),[x,p]=(0,i.useState)(null),[h,f]=(0,i.useState)({}),y=(0,T.a)(),{toast:j}=(0,U.dj)(),g=(0,i.useMemo)(()=>r[m]||[],[r,m]),b=(0,i.useCallback)(e=>{e&&d(t=>{let a={id:crypto.randomUUID(),type:"player",name:e,initiative:0,nat20:!1},s={...t};for(let e in s[m]||(s[m]=[]),s)parseInt(e)>=m&&(s[e]=[...s[e],a]);return s})},[m]),N=(0,i.useCallback)((e,t)=>{f(a=>{if(a[e])return a;let s=Math.floor(6*Math.random())+1+(Math.floor(6*Math.random())+1),i="";i=t.some(e=>"monster"===e.type&&"Tyrant"===e.template)?s<=6?"1 Heavy, 1 Light deed":s<=9?"1 Mighty & 1 Light, or 2 Heavy deeds":"1 Mighty, 1 Heavy deed":s<=6?"1 Heavy deed":s<=9?"1 Heavy, 1 Mighty deed":"2 Heavy, 1 Mighty deed";let n={...a};return n[e]={roll:s,text:i},n})},[]),{activeCombatants:w,defeatedCombatants:k}=(0,i.useMemo)(()=>({activeCombatants:g.filter(e=>"player"===e.type||"monster"===e.type&&e.currentHp>0),defeatedCombatants:g.filter(e=>"monster"===e.type&&e.currentHp<=0)}),[g]),C=(0,i.useMemo)(()=>o||0===w.length?[]:D(w),[w,o]),I=(0,i.useMemo)(()=>x&&g.find(e=>e.id===x)||null,[x,g]);(0,i.useEffect)(()=>{(async()=>{c(!0);let e=t.monsterGroups;if(t.encounterTableId){let s=await (0,n.Uh)(t.encounterTableId);if(!s||0===s.entries.length){j({variant:"destructive",title:"Error",description:"Could not find encounter table or it is empty."}),a();return}let i=s.entries.reduce((e,t)=>e+t.weight,0);if(i<=0){j({variant:"destructive",title:"Error",description:"Encounter table has no weight."}),a();return}let r=Math.random()*i,l=s.entries[0];for(let e of s.entries)if((r-=e.weight)<=0){l=e;break}let d=Y(l.quantity||"1");e=[{monsterId:l.creatureId,quantity:d}]}let s=e.map(e=>e.monsterId),i=await (0,n.C8)(s),r=new Map(i.map(e=>[e.id,e])),l=i.flatMap(e=>e.deeds),o=new Map((await (0,n.pT)(l)).map(e=>[e.id,e])),m=[];(t.players||[]).forEach(e=>{m.push({id:e.id,type:"player",name:e.name,initiative:0,nat20:!1})}),(e||[]).forEach(e=>{let t=r.get(e.monsterId);if(!t)return;let a=t.deeds.map(e=>o.get(e)).filter(Boolean);"Underling"===t.template&&(a=a.filter(e=>"light"===e.tier));for(let s=0;s<e.quantity;s++){let i={id:crypto.randomUUID(),type:"monster",name:e.quantity>1?"".concat(t.name," ").concat(s+1):t.name,monsterId:t.id,template:t.template||"Normal",maxHp:"Underling"===t.template?1:t.attributes.HP,currentHp:"Underling"===t.template?1:t.attributes.HP,attributes:t.attributes,deeds:a,abilities:(t.abilities||[]).map(e=>({...e,id:e.id||crypto.randomUUID()})),description:t.description,tags:t.tags,states:[],level:t.level,role:t.role,TR:t.TR,initiative:t.attributes.Initiative};m.push(i)}}),d({1:m}),N(1,m),c(!1)})()},[t,N,a,j]);let A=()=>{let e=m+1;if(!r[e]){let t=JSON.parse(JSON.stringify(g));t.forEach(e=>{"player"===e.type&&(e.initiative=0,e.nat20=!1)}),d(a=>({...a,[e]:t})),N(e,t)}u(e)},S=()=>{m>1&&u(e=>e-1)},M=(0,i.useMemo)(()=>h[m]||{roll:0,text:""},[h,m]),R=(0,i.useCallback)(e=>{d(t=>{if(!t[m])return t;let a=(t[m]||[]).map(t=>t.id===e.id?e:t),s={...t,[m]:a};if("player"===e.type)for(let a=m+1;a<=Math.max(...Object.keys(t).map(Number));a++)s[a]&&(s[a]=s[a].map(t=>t.id===e.id?{...t,initiative:e.initiative,nat20:e.nat20}:t));return s})},[m]),F=(0,i.useCallback)(e=>{let t=g.find(t=>t.id===e);t&&"monster"===t.type&&R({...t,currentHp:1})},[g,R]);return o?(0,s.jsx)("div",{className:"flex h-screen w-full items-center justify-center",children:(0,s.jsx)(P.E,{className:"h-48 w-48"})}):y?(0,s.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,s.jsxs)("header",{className:"py-4 px-6 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(B.A,{className:"text-primary h-8 w-8"}),(0,s.jsx)("h1",{className:"text-xl md:text-3xl font-headline font-bold text-foreground whitespace-nowrap",children:t.name})]}),(0,s.jsx)(l.$,{variant:"destructive",onClick:a,children:"End Encounter"})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,s.jsx)(v,{combatantsInTurnOrder:C,defeatedCombatants:k,selectedCombatantId:x,onSelectCombatant:p,round:m,onNextRound:A,onPrevRound:S,onCombatantUpdate:R,onRevive:F,perilRoll:M.roll,perilText:M.text,onAddPlayer:b}),I?(0,s.jsx)(E,{combatant:I,onUpdate:R},I.id):(0,s.jsx)("div",{className:"p-8 text-center text-muted-foreground flex items-center justify-center h-full rounded-lg bg-card",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,s.jsx)("p",{children:"Select a combatant from the list to view their details."})]})})]})]}):(0,s.jsx)(H.SidebarProvider,{children:(0,s.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,s.jsxs)("header",{className:"py-4 px-6 md:px-8 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(H.x2,{}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(B.A,{className:"text-primary h-8 w-8"}),(0,s.jsx)("h1",{className:"text-2xl md:text-3xl font-headline font-bold text-foreground",children:t.name})]})]}),(0,s.jsx)(l.$,{variant:"destructive",onClick:a,children:"End Encounter"})]}),(0,s.jsxs)("div",{className:"flex flex-1 min-h-0",children:[(0,s.jsx)(H.Bx,{style:{"--sidebar-width":"300px"},children:o?(0,s.jsx)(P.E,{className:"h-full w-full"}):(0,s.jsx)(v,{combatantsInTurnOrder:C,defeatedCombatants:k,selectedCombatantId:x,onSelectCombatant:p,round:m,onNextRound:A,onPrevRound:S,onCombatantUpdate:R,onRevive:F,perilRoll:M.roll,perilText:M.text,onAddPlayer:b})}),(0,s.jsx)(H.sF,{className:"flex-1 overflow-y-auto bg-background/50",children:(0,s.jsx)("div",{className:"p-4 sm:p-6 md:p-8 h-full",children:I?(0,s.jsx)(E,{combatant:I,onUpdate:R},I.id):(0,s.jsx)("div",{className:"text-center text-muted-foreground flex items-center justify-center h-full",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,s.jsx)("p",{children:"Select a combatant from the list to view their details."})]})})})})]})]})})}}}]);