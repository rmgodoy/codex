(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[729],{3819:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>eu});var a=s(5155),n=s(2115),r=s(467),i=s(31),l=s(9746),d=s(2523),c=s(285),o=s(6424),m=s(2346),u=s(7481),x=s(4301),h=s(5074),p=s(3054),f=s(203),j=s(3926),g=s(5057),y=s(9409);function v(e){let{onSelectEncounter:t,onNewEncounter:s,selectedEncounterId:r,dataVersion:v,filters:b,setFilters:N,onClearFilters:w}=e,[C,k]=(0,n.useState)([]),[S,T]=(0,n.useState)([]),[R,I]=(0,n.useState)(!0),{toast:M}=(0,u.dj)(),{isMobile:A,setOpenMobile:E}=(0,i.cL)();(0,n.useEffect)(()=>{(async()=>{I(!0);try{let[e,t]=await Promise.all([(0,l.eS)(),(0,l.OG)()]);k(e),T(t)}catch(e){console.error("Error fetching encounters:",e),M({variant:"destructive",title:"Error",description:"Could not fetch encounters from database."})}finally{I(!1)}})()},[v,M]);let z=e=>{t(e),A&&E(!1)},B=(0,n.useMemo)(()=>{let e=new Map(S.map(e=>[e.id,e.TR])),t=C.map(t=>{var s;let a=null!=(s=t.totalTR)?s:(t.monsterGroups||[]).reduce((t,s)=>t+(e.get(s.monsterId)||0)*s.quantity,0);return{...t,totalTR:a}}).filter(e=>{let t=e.name.toLowerCase().includes(b.searchTerm.toLowerCase()),s=!0,a=b.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);a.length>0&&(s=!!e.tags&&a.every(t=>e.tags.some(e=>e.toLowerCase().includes(t))));let n=!0;return b.minTR&&!isNaN(parseInt(b.minTR))&&(n=n&&e.totalTR>=parseInt(b.minTR,10)),b.maxTR&&!isNaN(parseInt(b.maxTR))&&(n=n&&e.totalTR<=parseInt(b.maxTR,10)),t&&s&&n}).sort((e,t)=>{if("TR"===b.sortBy){var s,a;let n=(null!=(s=e.totalTR)?s:0)-(null!=(a=t.totalTR)?a:0);if(0!==n)return n}return e.name.localeCompare(t.name)});return"desc"===b.sortOrder&&t.reverse(),t},[C,S,b]);return(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"p-4 space-y-4",children:[(0,a.jsxs)(c.$,{onClick:()=>{s(),A&&E(!1)},className:"w-full",children:[(0,a.jsx)(x.A,{})," New Encounter"]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(h.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,a.jsx)(d.p,{placeholder:"Search encounters...",value:b.searchTerm,onChange:e=>N.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(g.J,{children:"Filter"}),(0,a.jsx)(c.$,{variant:"ghost",size:"sm",onClick:w,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(p.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,a.jsx)(d.p,{placeholder:"Tags (e.g. boss-fight)",value:b.tagFilter,onChange:e=>N.setTagFilter(e.target.value),className:"pl-9"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(d.p,{placeholder:"Min TR",type:"number",value:b.minTR,onChange:e=>N.setMinTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),(0,a.jsx)(d.p,{placeholder:"Max TR",type:"number",value:b.maxTR,onChange:e=>N.setMaxTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.J,{children:"Sort by"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(y.l6,{value:b.sortBy,onValueChange:e=>N.setSortBy(e),children:[(0,a.jsx)(y.bq,{children:(0,a.jsx)(y.yv,{placeholder:"Sort by"})}),(0,a.jsxs)(y.gC,{children:[(0,a.jsx)(y.eb,{value:"name",children:"Name"}),(0,a.jsx)(y.eb,{value:"TR",children:"TR"})]})]}),(0,a.jsxs)(c.$,{variant:"ghost",size:"icon",onClick:()=>N.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===b.sortOrder?(0,a.jsx)(f.A,{className:"h-4 w-4"}):(0,a.jsx)(j.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,a.jsx)(m.w,{}),(0,a.jsx)(o.F,{className:"flex-1",children:(0,a.jsx)("div",{className:"p-4",children:R?(0,a.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading encounters..."}):B.length>0?(0,a.jsx)("ul",{className:"space-y-1",children:B.map(e=>(0,a.jsx)("li",{children:(0,a.jsxs)("button",{onClick:()=>z(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(r===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,a.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.totalTR,")"]})]})},e.id))}):(0,a.jsx)("p",{className:"text-muted-foreground text-center",children:"No encounters found."})})})]})}var b=s(2177),N=s(221),w=s(5594),C=s(6695),k=s(8539),S=s(10),T=s(7759),R=s(3503),I=s(1816),M=s(8763),A=s(1721),E=s(7223),z=s(5318),B=s(3896),F=s(8856),G=s(4165),$=s(6126),P=s(648);let L=w.z.object({id:w.z.string(),name:w.z.string().min(1,"Player name is required")}),D=w.z.object({monsterId:w.z.string(),quantity:w.z.coerce.number().min(1,"Quantity must be at least 1")}),U=w.z.object({name:w.z.string().min(1,"Encounter name is required"),sceneDescription:w.z.string().optional(),gmNotes:w.z.string().optional(),players:w.z.array(L),monsterGroups:w.z.array(D),tags:w.z.array(w.z.string()).optional(),totalTR:w.z.number().optional()}),Y=e=>{let{onAddCreatures:t}=e,[s,r]=(0,n.useState)(!1),[i,m]=(0,n.useState)([]),[u,x]=(0,n.useState)(new Map),[h,p]=(0,n.useState)("");(0,n.useEffect)(()=>{s&&(0,l.OG)().then(m)},[s]);let f=(0,n.useMemo)(()=>i.filter(e=>e.name.toLowerCase().includes(h.toLowerCase())),[i,h]),j=(e,t)=>{t>=1?x(s=>{let a=new Map(s);return a.set(e,t),a}):x(t=>{let s=new Map(t);return s.delete(e),s})},g=async()=>{let e=Array.from(u.entries()).map(e=>{let[t,s]=e,a=i.find(e=>e.id===t);return{id:t,name:a.name,quantity:s}});e.length>0&&t(e),r(!1),x(new Map),p("")};return(0,a.jsxs)(G.lG,{open:s,onOpenChange:r,children:[(0,a.jsx)(G.zM,{asChild:!0,children:(0,a.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",children:[(0,a.jsx)(R.A,{className:"h-4 w-4 mr-2"})," Add Monster"]})}),(0,a.jsxs)(G.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,a.jsx)(G.c7,{children:(0,a.jsx)(G.L3,{children:"Select Monsters from Bestiary"})}),(0,a.jsx)(d.p,{placeholder:"Search monsters...",value:h,onChange:e=>p(e.target.value),className:"mb-4 shrink-0"}),(0,a.jsx)(o.F,{className:"flex-1 border rounded-md p-2",children:(0,a.jsx)("div",{className:"space-y-1",children:f.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,a.jsx)(d.p,{type:"number",min:"0",value:u.get(e.id)||0,onChange:t=>j(e.id,parseInt(t.target.value)||0),className:"w-20 h-8"}),(0,a.jsx)("label",{htmlFor:"creature-".concat(e.id),className:"flex-1",children:(0,a.jsxs)("p",{className:"font-semibold",children:[e.name," ",(0,a.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(Lvl ",e.level,")"]})]})})]},e.id))})}),(0,a.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,a.jsx)(c.$,{variant:"ghost",onClick:()=>r(!1),children:"Cancel"}),(0,a.jsx)(c.$,{onClick:g,disabled:0===u.size,children:"Add Selected"})]})]})]})},H={name:"",sceneDescription:"",gmNotes:"",players:[],monsterGroups:[],tags:[],totalTR:0};function O(e){let{encounterId:t,isCreatingNew:s,onEncounterSaveSuccess:r,onEncounterDeleteSuccess:i,onEditCancel:o,onRunEncounter:x,onFilterByClick:h}=e,{toast:f}=(0,u.dj)(),[j,y]=(0,n.useState)(s),[v,w]=(0,n.useState)(!s&&!!t),[G,L]=(0,n.useState)(null),[D,O]=(0,n.useState)({monsters:new Map}),J=(0,b.mN)({resolver:(0,N.u)(U),defaultValues:H}),{fields:q,append:Z,remove:W}=(0,b.jz)({control:J.control,name:"players"}),{fields:V,append:_,remove:K,update:Q}=(0,b.jz)({control:J.control,name:"monsterGroups"}),[X,ee]=(0,n.useState)([]);(0,n.useEffect)(()=>{(0,l.OG)().then(ee)},[]);let et=(0,n.useMemo)(()=>new Map(X.map(e=>[e.id,e])),[X]);(0,n.useEffect)(()=>{(async()=>{if(s){J.reset(H),L(null),y(!0),w(!1);return}if(!t){y(!1),w(!1),L(null);return}w(!0),y(!1);try{let e=await (0,l.eq)(t);if(e){let t={...e,tags:e.tags||[]};J.reset(t),L(e);let s=(e.monsterGroups||[]).map(e=>e.monsterId);if(s.length>0){let e=await (0,l.C8)(s),t=new Map(e.map(e=>[e.id,e]));O({monsters:t})}else O({monsters:new Map})}else L(null)}catch(e){f({variant:"destructive",title:"Error",description:"Could not load encounter data."})}finally{w(!1)}})()},[t,s,J,f]);let es=()=>{if(s)o();else if(G){let e={...G,tags:G.tags||[]};J.reset(e),y(!1)}},ea=async e=>{try{let a=await (0,l.C8)(e.monsterGroups.map(e=>e.monsterId)),n=new Map(a.map(e=>[e.id,e.TR])),i=e.monsterGroups.reduce((e,t)=>{let s=n.get(t.monsterId)||0;return e+s*t.quantity},0),d={...e,tags:e.tags||[],totalTR:i},c=e.tags||[];if(c.length>0&&await (0,l.JE)(c),s){let t=await (0,l.Fs)(d);f({title:"Encounter Created!",description:"".concat(e.name," has been saved.")}),r(t)}else t&&(await (0,l.H$)({...d,id:t}),f({title:"Save Successful",description:"".concat(e.name," has been updated.")}),r(t))}catch(e){f({variant:"destructive",title:"Save Failed",description:"Could not save changes."})}},en=async()=>{if(t)try{await (0,l.ZJ)(t),f({title:"Encounter Deleted",description:"The encounter has been removed."}),i()}catch(e){f({variant:"destructive",title:"Deletion Failed",description:"Could not delete the encounter."})}};return v?(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsxs)(C.Zp,{children:[(0,a.jsx)(C.aR,{children:(0,a.jsx)(F.E,{className:"h-8 w-48"})}),(0,a.jsx)(C.Wu,{children:(0,a.jsx)(F.E,{className:"h-40 w-full"})})]})}):t||s?!j&&G?(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsxs)(C.Zp,{children:[(0,a.jsxs)(C.aR,{className:"flex flex-row items-start justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(C.ZB,{className:"text-3xl font-bold",children:G.name}),(0,a.jsx)(C.BT,{children:(0,a.jsxs)("button",{onClick:e=>h({minTR:G.totalTR||0,maxTR:G.totalTR||0},e),className:"hover:underline p-0 bg-transparent text-inherit text-sm",children:[(0,a.jsx)("span",{className:"hidden sm:inline",children:"Total Threat Rating (TR): "}),(0,a.jsx)("span",{className:"inline sm:hidden",children:"TR: "}),G.totalTR||0]})})]}),(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,a.jsxs)(c.$,{variant:"default",size:"sm",onClick:()=>x(G.id),children:[(0,a.jsx)(I.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Run Encounter"}),(0,a.jsx)("span",{className:"inline sm:hidden",children:"Run"})]}),(0,a.jsxs)(c.$,{variant:"outline",size:"sm",onClick:()=>y(!0),children:[(0,a.jsx)(M.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Edit"})]})]})]}),(0,a.jsx)(C.Wu,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Scene"}),(0,a.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:G.sceneDescription||"No scene description."})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"GM Notes"}),(0,a.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:G.gmNotes||"No GM notes."})]}),(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Combatants"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("h4",{className:"font-semibold text-muted-foreground",children:["Players (",(G.players||[]).length,")"]}),(0,a.jsx)("ul",{className:"space-y-2 pl-4",children:(G.players||[]).map(e=>(0,a.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,a.jsx)(A.A,{className:"h-5 w-5 text-accent"}),(0,a.jsx)("span",{className:"font-semibold flex-1",children:e.name})]},e.id))}),(0,a.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),(0,a.jsx)("ul",{className:"space-y-2 pl-4",children:(G.monsterGroups||[]).map(e=>{let t=D.monsters.get(e.monsterId);return(0,a.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,a.jsx)(R.A,{className:"h-5 w-5 text-accent"}),(0,a.jsx)("span",{className:"font-semibold flex-1",children:(null==t?void 0:t.name)||"Unknown Monster"}),(0,a.jsxs)("span",{className:"text-sm text-muted-foreground",children:["x ",e.quantity]}),t&&(0,a.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Lvl ",t.level," ",t.role]})]},e.monsterId)})})]})]}),G.tags&&G.tags.length>0&&(0,a.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:G.tags.map(e=>(0,a.jsx)("button",{onClick:t=>h({tagFilter:e},t),className:"bg-transparent border-none p-0 m-0",children:(0,a.jsx)($.E,{variant:"secondary",className:"cursor-pointer hover:bg-secondary/80",children:e})},e))})})]})}),(0,a.jsx)(C.wL,{children:(0,a.jsxs)(S.Lt,{children:[(0,a.jsx)(S.tv,{asChild:!0,children:(0,a.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,a.jsx)(E.A,{className:"h-4 w-4"})})}),(0,a.jsxs)(S.EO,{children:[(0,a.jsxs)(S.wd,{children:[(0,a.jsx)(S.r7,{children:"Are you sure?"}),(0,a.jsxs)(S.$v,{children:['This will permanently delete "',G.name,'". This action cannot be undone.']})]}),(0,a.jsxs)(S.ck,{children:[(0,a.jsx)(S.Zr,{children:"Cancel"}),(0,a.jsx)(S.Rx,{onClick:en,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})}):(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsx)(C.Zp,{children:(0,a.jsx)(T.lV,{...J,children:(0,a.jsxs)("form",{onSubmit:J.handleSubmit(ea),className:"space-y-6",children:[(0,a.jsxs)(C.aR,{className:"flex flex-row justify-between items-start",children:[(0,a.jsx)("div",{children:(0,a.jsx)(C.ZB,{children:s?"Create a New Encounter":"Editing: ".concat(J.getValues("name")||"...")})}),(0,a.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:es,className:"text-muted-foreground hover:text-foreground",children:(0,a.jsx)(z.A,{className:"h-5 w-5"})})]}),(0,a.jsxs)(C.Wu,{className:"space-y-6",children:[(0,a.jsx)(T.zB,{name:"name",control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"Encounter Name"}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(d.p,{...t})}),(0,a.jsx)(T.C5,{})]})}}),(0,a.jsx)(T.zB,{name:"tags",control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsxs)(T.lR,{className:"flex items-center gap-2",children:[(0,a.jsx)(p.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(P.F,{value:t.value||[],onChange:t.onChange,placeholder:"Add tags..."})}),(0,a.jsx)(T.C5,{})]})}}),(0,a.jsx)(T.zB,{name:"sceneDescription",control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"Scene Description"}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(k.T,{...t,rows:4})})]})}}),(0,a.jsx)(T.zB,{name:"gmNotes",control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"GM Notes (Private)"}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(k.T,{...t,rows:4})})]})}}),(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-4",children:"Combatants"}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Players"}),(0,a.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",onClick:()=>{Z({id:crypto.randomUUID(),name:"Player ".concat(q.length+1)})},children:[(0,a.jsx)(B.A,{className:"h-4 w-4 mr-2"})," Add Player"]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[q.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center gap-2 p-2 border rounded-lg bg-card-foreground/5",children:[(0,a.jsx)(T.zB,{name:"players.".concat(t,".name"),control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{className:"flex-1",children:[(0,a.jsx)(T.MJ,{children:(0,a.jsx)(d.p,{...t})}),(0,a.jsx)(T.C5,{})]})}}),(0,a.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>W(t),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,a.jsx)(E.A,{className:"h-4 w-4"})})]},e.id)),0===q.length&&(0,a.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No players added."})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),(0,a.jsx)(Y,{onAddCreatures:e=>{e.forEach(e=>{let{id:t,quantity:s}=e,a=V.findIndex(e=>e.monsterId===t);if(a>-1){let e=V[a];Q(a,{...e,quantity:e.quantity+s})}else _({monsterId:t,quantity:s})})}})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[V.map((e,t)=>{let s=et.get(e.monsterId);return(0,a.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-card-foreground/5",children:[(0,a.jsx)("p",{className:"flex-1 font-semibold",children:(null==s?void 0:s.name)||"Unknown Monster"}),(0,a.jsx)(T.zB,{name:"monsterGroups.".concat(t,".quantity"),control:J.control,render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{className:"flex items-center gap-2",children:[(0,a.jsx)(g.J,{children:"Qty"}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(d.p,{type:"number",min:"1",...t,className:"w-20 h-8"})})]})}}),(0,a.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>K(t),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,a.jsx)(E.A,{className:"h-4 w-4"})})]},e.id)}),0===V.length&&(0,a.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No monsters added."})]})]})]})]}),(0,a.jsxs)(C.wL,{className:"flex items-center gap-2",children:[!s&&(0,a.jsxs)(S.Lt,{children:[(0,a.jsx)(S.tv,{asChild:!0,children:(0,a.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,a.jsx)(E.A,{className:"h-4 w-4"})})}),(0,a.jsxs)(S.EO,{children:[(0,a.jsxs)(S.wd,{children:[(0,a.jsx)(S.r7,{children:"Are you sure?"}),(0,a.jsxs)(S.$v,{children:['This will permanently delete "',J.getValues("name"),'".']})]}),(0,a.jsxs)(S.ck,{children:[(0,a.jsx)(S.Zr,{children:"Cancel"}),(0,a.jsx)(S.Rx,{onClick:en,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,a.jsx)("div",{className:"flex-grow"}),(0,a.jsx)(c.$,{type:"button",variant:"outline",onClick:es,children:"Cancel"}),(0,a.jsx)(c.$,{type:"submit",children:s?"Create Encounter":"Save Changes"})]})]})})})}):(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsx)(C.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,a.jsxs)(C.Wu,{className:"text-center pt-6",children:[(0,a.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select an encounter to view"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"or create a new one."})]})})})}var J=s(9556),q=s(7381),Z=s(1949),W=s(7262),V=s(8082),_=s(9434);let K=V.Kq,Q=V.bL,X=V.l9,ee=n.forwardRef((e,t)=>{let{className:s,sideOffset:n=4,...r}=e;return(0,a.jsx)(V.UC,{ref:t,sideOffset:n,className:(0,_.cn)("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...r})});function et(e){let{combatantsInTurnOrder:t,untrackedPlayers:s,activeTurnId:r,round:i,onNextTurn:l,onPrevTurn:u,onCombatantUpdate:x,perilRoll:h,perilText:p,allPlayersReady:f,turnIndex:j}=e,[y,v]=(0,n.useState)({}),b=(0,n.useMemo)(()=>[...s,...t.filter(e=>"player"===e.type)],[s,t]);(0,n.useEffect)(()=>{let e={};b.forEach(t=>{void 0!==t.initiative&&null!==t.initiative&&(e[t.id]=t.initiative>0?String(t.initiative):"")}),v(e)},[b,i]);let N=(e,t)=>{v(s=>({...s,[e]:t}))},w=e=>{let t=b.find(t=>t.id===e);if(!t)return;let s=parseInt(y[e],10)||0;t&&(void 0===t.initiative||t.initiative!==s)&&x({...t,initiative:s})},C=(e,t)=>{x({...e,nat20:t})};return(0,a.jsxs)("div",{className:"flex flex-col h-full p-4 bg-card",children:[(0,a.jsxs)("div",{className:"text-center mb-4",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Round"}),(0,a.jsx)("p",{className:"text-4xl font-bold",children:i})]}),(0,a.jsx)(m.w,{className:"my-2"}),(0,a.jsxs)("div",{className:"text-center mb-4",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Peril"}),(0,a.jsx)("p",{className:"text-4xl font-bold",children:h}),(0,a.jsx)("div",{className:"flex justify-center gap-6 mt-2 text-sm",children:(0,a.jsx)("p",{className:"font-bold text-lg",children:p})})]}),(0,a.jsx)(m.w,{className:"my-2"}),(0,a.jsx)(K,{delayDuration:100,children:(0,a.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,a.jsxs)(c.$,{onClick:u,variant:"outline",className:"w-full",disabled:0===j&&1===i,children:[(0,a.jsx)(q.A,{className:"h-4 w-4 mr-2"})," Prev"]}),(()=>{let e=!f,t=(0,a.jsxs)(c.$,{onClick:l,variant:"default",className:"w-full",disabled:e,children:["Next ",(0,a.jsx)(J.A,{className:"h-4 w-4 ml-2"})]});return e?(0,a.jsxs)(Q,{children:[(0,a.jsx)(X,{asChild:!0,children:(0,a.jsx)("div",{className:"w-full",children:t})}),(0,a.jsx)(ee,{children:(0,a.jsx)("p",{children:"Set initiative for all players to proceed."})})]}):t})()]})}),s.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2 text-destructive",children:"Set Initiative"}),(0,a.jsx)("ul",{className:"space-y-2 pr-4",children:s.map(e=>(0,a.jsxs)("li",{className:"p-3 rounded-lg border-l-4 border-destructive bg-destructive/10",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(Z.A,{className:"h-5 w-5 text-destructive"}),(0,a.jsx)("span",{className:"font-semibold",children:e.name})]}),(0,a.jsx)(d.p,{type:"number",value:y[e.id]||"",onChange:t=>N(e.id,t.target.value),onBlur:()=>w(e.id),className:"w-20 h-8",min:"0"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2 pl-8",children:[(0,a.jsx)(W.S,{id:"nat20-untracked-".concat(e.id),checked:e.nat20,onCheckedChange:t=>C(e,!!t)}),(0,a.jsx)(g.J,{htmlFor:"nat20-untracked-".concat(e.id),children:"Nat 20"})]})]},e.id))})]}),(0,a.jsx)(m.w,{className:"my-2"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2 text-primary-foreground",children:"Initiative Order"}),(0,a.jsx)(o.F,{className:"flex-1",children:t.length>0?(0,a.jsx)("ul",{className:"space-y-2 pr-4",children:t.map(e=>(0,a.jsxs)("li",{className:"p-3 rounded-lg border-l-4 transition-all ".concat(r&&e.turnId===r?"bg-primary/20 border-primary shadow-md":"bg-background border-transparent"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:["player"===e.type?(0,a.jsx)(A.A,{className:"h-5 w-5 text-accent"}):(0,a.jsx)(R.A,{className:"h-5 w-5 text-accent"}),(0,a.jsx)("span",{className:"font-semibold",children:e.name})]}),"player"===e.type?(0,a.jsx)(d.p,{type:"number",value:y[e.id]||"",onChange:t=>N(e.id,t.target.value),onBlur:()=>w(e.id),className:"w-20 h-8",min:"0"}):(0,a.jsx)("span",{className:"font-bold text-lg",children:e.initiative})]}),"player"===e.type&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2 pl-8",children:[(0,a.jsx)(W.S,{id:"nat20-".concat(e.id),checked:e.nat20,onCheckedChange:t=>C(e,!!t)}),(0,a.jsx)(g.J,{htmlFor:"nat20-".concat(e.id),children:"Nat 20"})]})]},e.turnId))}):(0,a.jsx)("p",{className:"text-muted-foreground text-center pt-4",children:"Waiting for players..."})})]})}ee.displayName=V.UC.displayName;var es=s(8098),ea=s(1887),en=s(518),er=s(8911);let ei=[{name:"Accurate",description:"You take an intensity bonus to accuracy checks. Cancels out inaccurate.",effects:[{attribute:"Accuracy",modifier:"bonus"}]},{name:"Inaccurate",description:"You take an intensity penalty to accuracy checks. Cancels out accurate.",effects:[{attribute:"Accuracy",modifier:"penalty"}]},{name:"Bleeding",description:"You suffer intensity damage when you move, jump, teleport, or are forced to move. You only take this damage once per instance of movement, even if you move multiple squares as part of that movement."},{name:"Burning",description:"You suffer (intensity)d6 damage at the start of your turn, up to a maximum of three dice. Then the intensity increases by +1."},{name:"Delirious",description:"At the start of your turn, roll (intensity)d6, up to a maximum of three dice. For each result, perform the listed action, spending the required action point: 1: fling something at the nearest creature (damage) 2: hurt yourself and suffer damage 3: stumble half your speed in a random direction 4: stare blankly and do nothing 5 or 6: no effect"},{name:"Fortified",description:"Damage you take from attacks is reduced by intensity. Cancels out frail."},{name:"Frail",description:"Damage you take from attacks is increased by intensity. Cancels out fortified."},{name:"Guarded",description:"You gain an intensity bonus to guard checks. Cancels out unguarded.",effects:[{attribute:"Guard",modifier:"bonus"}]},{name:"Unguarded",description:"You take an intensity penalty to guard checks. Cancels out guarded.",effects:[{attribute:"Guard",modifier:"penalty"}]},{name:"Hastened",description:"You gain an intensity bonus to initiative checks. Cancels out hindered.",effects:[{attribute:"Initiative",modifier:"bonus"}]},{name:"Hindered",description:"You take an intensity penalty to initiative checks. Cancels out hastened.",effects:[{attribute:"Initiative",modifier:"penalty"}]},{name:"Mending",description:"You regain intensity hit points at the start of your turn. Cancels out poisoned."},{name:"Poisoned",description:"You suffer intensity damage at the start of your turn. Cancels out mending."},{name:"Provoked",description:"You take an intensity penalty to attacks that do not include the provoking creature as a target. If a different creature confers this state on you, it becomes the provoking creature."},{name:"Sleeping",description:"You also gain toppled when you gain this condition. You take no turn, but you make one free prevail against this state at the end of each round. After waking, you cannot take a turn until the following round. This state ends immediately if you suffer damage."},{name:"Slow",description:"You take an intensity penalty to speed. Cancels out swift.",effects:[{attribute:"Speed",modifier:"penalty"}]},{name:"Swift",description:"You gain an intensity bonus to speed. Cancels out slow.",effects:[{attribute:"Speed",modifier:"bonus"}]},{name:"Toppled",description:"You have -2 accuracy and guard, and you move at half speed. You can end this state by spending an action to stand up. If this state has an intensity, you must prevail to stand up instead.",effects:[{attribute:"Accuracy",modifier:"fixed",value:-2},{attribute:"Guard",modifier:"fixed",value:-2},{attribute:"Speed",modifier:"halve"}]},{name:"Strong",description:"You gain an intensity bonus to damage rolls on attacks. Cancels out weak.",effects:[{attribute:"rollBonus",modifier:"bonus"}]},{name:"Weak",description:"You take an intensity penalty to damage rolls on attacks. Cancels out strong.",effects:[{attribute:"rollBonus",modifier:"penalty"}]},{name:"Weary",description:"You take an intensity penalty to resist checks. Cancels out willful.",effects:[{attribute:"Resist",modifier:"penalty"}]},{name:"Willful",description:"You take an intensity bonus to resist checks. Cancels out weary.",effects:[{attribute:"Resist",modifier:"bonus"}]}];var el=s(4636);let ed=e=>{let{label:t,modified:s,original:n,isBonus:r}=e,i=s!==n,l="number"==typeof s&&"number"==typeof n?s-n:0,d="";return i&&(d=r&&l>0||!r&&l<0?"text-green-400":"text-red-400"),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.J,{children:t}),i?(0,a.jsxs)("p",{className:"text-lg font-bold",children:[(0,a.jsx)("span",{className:d,children:s}),(0,a.jsx)("span",{className:"text-muted-foreground text-sm ml-2 line-through",children:n})]}):(0,a.jsx)("p",{className:"text-lg font-bold",children:n})]})};function ec(e){let{combatant:t,onUpdate:s}=e,[r,i]=(0,n.useState)(""),[l,u]=(0,n.useState)(""),[x,h]=(0,n.useState)(""),[p,f]=(0,n.useState)(!1),{modifiedAttributes:j,originalAttributes:y}=(0,n.useMemo)(()=>{if("player"===t.type||!t.states)return{modifiedAttributes:null,originalAttributes:null};let e={...t.attributes},s={...t.attributes};return t.states.forEach(e=>{e.effects&&e.effects.forEach(t=>{switch(t.modifier){case"bonus":case"penalty":{let a=e.intensity*("bonus"===t.modifier?1:-1);"number"==typeof s[t.attribute]&&(s[t.attribute]+=a);break}case"fixed":"number"==typeof s[t.attribute]&&(s[t.attribute]+=t.value);break;case"halve":"Speed"===t.attribute&&(s.Speed=Math.floor(s.Speed/2))}})}),{modifiedAttributes:s,originalAttributes:e}},[t]),v=(0,n.useMemo)(()=>ei.filter(e=>e.name.toLowerCase().includes(x.toLowerCase())),[x]);if("player"===t.type)return(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsxs)(C.Zp,{children:[(0,a.jsxs)(C.aR,{children:[(0,a.jsx)(C.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),(0,a.jsx)(C.BT,{children:"Player Character"})]}),(0,a.jsx)(C.Wu,{children:(0,a.jsx)("p",{className:"text-muted-foreground text-center py-8",children:"Player turn. No stats to display."})})]})});let b=()=>{if(!r)return;let e=0;if(!isNaN(e=r.startsWith("+")||r.startsWith("-")?parseInt(r,10):parseInt(r,10)-t.currentHp)){let a=t.currentHp+e;"Underling"===t.template&&(a=Math.min(1,Math.max(0,a))),s({...t,currentHp:a})}i("")},N=(e,a,n)=>{let r=t.states.map(t=>t.id===e?{...t,[a]:n}:t);s({...t,states:r})},w=e=>{s({...t,states:t.states.filter(t=>t.id!==e)})},k=(e,a)=>{let n=t.states.map(t=>t.id===e?{...t,...a}:t);s({...t,states:n})};return(0,a.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,a.jsxs)(C.Zp,{children:[(0,a.jsxs)(C.aR,{children:[(0,a.jsx)("div",{className:"flex justify-between items-start",children:(0,a.jsxs)("div",{children:[(0,a.jsx)(C.ZB,{className:"text-3xl sm:text-4xl font-bold",children:t.name}),"monster"===t.type&&(0,a.jsxs)(C.BT,{children:["Lvl ",t.level," ",t.template," ",t.role," â€¢ TR ",t.TR]})]})}),("Paragon"===t.template||"Tyrant"===t.template)&&(0,a.jsxs)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Extra Turn:"})," This creature takes an additional turn at the end of the round."]}),(0,a.jsx)("p",{children:"Immune to effects that delay its turn (loses an action point on its next turn instead)."})]}),"Tyrant"===t.template&&(0,a.jsx)("div",{className:"text-sm text-amber-300 bg-amber-900/50 p-2 rounded-md mt-2",children:(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Unstoppable:"})," Can make a free prevail check against one state at the end of each round."]})})]}),(0,a.jsxs)(C.Wu,{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(g.J,{htmlFor:"hp",className:"flex items-center gap-2 text-lg shrink-0",children:[(0,a.jsx)(es.A,{className:"h-6 w-6 text-red-500"})," HP"]}),(0,a.jsx)(d.p,{id:"hp",type:"number",value:t.currentHp,onChange:e=>{let a=parseInt(e.target.value,10)||0;"Underling"===t.template&&(a=Math.min(1,Math.max(0,a))),s({...t,currentHp:a})},className:"w-24 text-lg font-bold"}),"monster"===t.type&&(0,a.jsxs)("span",{className:"text-muted-foreground text-lg",children:["/ ",t.maxHp]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[180px]",children:[(0,a.jsx)(d.p,{placeholder:"+5 or -10",value:r,onChange:e=>i(e.target.value),onKeyDown:e=>"Enter"===e.key&&b(),className:"flex-1"}),(0,a.jsx)(c.$,{onClick:b,size:"sm",children:"Apply"})]})]}),"monster"===t.type&&j&&y&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-6 text-center my-6",children:[(0,a.jsx)(ed,{label:"Speed",modified:j.Speed,original:y.Speed}),(0,a.jsx)(ed,{label:"Accuracy",modified:j.Accuracy,original:y.Accuracy,isBonus:!0}),(0,a.jsx)(ed,{label:"Guard",modified:j.Guard,original:y.Guard,isBonus:!0}),(0,a.jsx)(ed,{label:"Resist",modified:j.Resist,original:y.Resist,isBonus:!0}),(0,a.jsx)(ed,{label:"Roll Bonus",modified:j.rollBonus>0?"+".concat(j.rollBonus):j.rollBonus,original:y.rollBonus>0?"+".concat(y.rollBonus):y.rollBonus,isBonus:!0}),(0,a.jsx)(ed,{label:"DMG",modified:t.attributes.DMG,original:t.attributes.DMG}),(0,a.jsx)(ed,{label:"Initiative",modified:j.Initiative,original:y.Initiative,isBonus:!0})]})]}),(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"flex justify-between items-center mb-4",children:(0,a.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground",children:"States"})}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[(0,a.jsxs)(el.AM,{open:p,onOpenChange:f,children:[(0,a.jsx)(el.Wv,{asChild:!0,children:(0,a.jsxs)(c.$,{variant:"outline",role:"combobox","aria-expanded":p,className:"flex-1 min-w-[180px] justify-between",children:[l||"Select a common state...",(0,a.jsx)(ea.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,a.jsxs)(el.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:[(0,a.jsx)("div",{className:"p-2 border-b",children:(0,a.jsx)(d.p,{placeholder:"Search states...",value:x,onChange:e=>h(e.target.value),className:"h-9",autoFocus:!0})}),(0,a.jsx)(o.F,{className:"h-[200px]",children:(0,a.jsx)("div",{className:"p-1",children:v.length>0?v.map(e=>(0,a.jsxs)(c.$,{variant:"ghost",className:(0,_.cn)("w-full justify-start font-normal h-auto py-2",l===e.name&&"bg-accent"),onClick:()=>{u(e.name),f(!1),h("")},children:[(0,a.jsx)(en.A,{className:(0,_.cn)("mr-2 h-4 w-4",l===e.name?"opacity-100":"opacity-0")}),e.name]},e.name)):(0,a.jsx)("p",{className:"text-center text-sm text-muted-foreground p-4",children:"No state found."})})})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(c.$,{onClick:()=>{let e=ei.find(e=>e.name===l);if(!e)return;let a={id:crypto.randomUUID(),name:e.name,intensity:1,description:e.description,effects:e.effects};s({...t,states:[...t.states,a]}),u("")},disabled:!l,children:[(0,a.jsx)("span",{className:"sm:hidden",children:"Add"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Add State"})]}),(0,a.jsx)(m.w,{orientation:"vertical",className:"h-6"}),(0,a.jsxs)(c.$,{variant:"outline",onClick:()=>{let e={id:crypto.randomUUID(),name:"New State",intensity:1};s({...t,states:[...t.states,e]})},children:[(0,a.jsx)("span",{className:"sm:hidden",children:"Custom"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Add Custom"})]})]})]}),(0,a.jsx)("div",{className:"space-y-3",children:t.states.length>0?t.states.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-card-foreground/5 rounded-lg",children:[(0,a.jsx)(d.p,{value:e.name,onChange:t=>k(e.id,{name:t.target.value,effects:void 0,description:void 0}),className:"flex-1 font-semibold min-w-0",disabled:!!ei.find(t=>t.name===e.name)}),(0,a.jsx)(g.J,{htmlFor:"intensity-".concat(e.id),className:"hidden sm:inline shrink-0",children:"Intensity"}),(0,a.jsx)(d.p,{id:"intensity-".concat(e.id),type:"number",min:"0",value:e.intensity,onChange:t=>N(e.id,"intensity",Math.max(0,parseInt(t.target.value,10)||0)),className:"w-20 shrink-0"}),(0,a.jsx)(c.$,{variant:"ghost",size:"icon",onClick:()=>w(e.id),className:"shrink-0",children:(0,a.jsx)(E.A,{className:"h-4 w-4 text-destructive"})})]},e.id)):(0,a.jsx)("p",{className:"text-muted-foreground text-center",children:"No active states."})})]}),"monster"===t.type&&t.abilities&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground my-4",children:"Abilities"}),(0,a.jsx)("p",{className:"text-foreground/90 whitespace-pre-wrap",children:t.abilities})]})]}),"monster"===t.type&&t.deeds.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.w,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-semibold text-primary-foreground mb-4",children:"Deeds"}),t.deeds.map((e,s)=>(0,a.jsx)(er.P,{deed:e,dmgReplacement:t.attributes.DMG},s))]})]})]})]})})}var eo=s(7906);function em(e){let{encounter:t,onEndEncounter:s}=e,[r,d]=(0,n.useState)({}),[o,m]=(0,n.useState)(!0),[u,x]=(0,n.useState)(0),[h,p]=(0,n.useState)(1),[f,j]=(0,n.useState)({}),g=(0,eo.a)(),y=(0,n.useMemo)(()=>r[h]||[],[r,h]),v=(0,n.useCallback)((e,t)=>{j(s=>{if(s[e])return s;let a=Math.floor(6*Math.random())+1+(Math.floor(6*Math.random())+1),n="";n=t.some(e=>"monster"===e.type&&"Tyrant"===e.template)?a<=6?"1 Heavy, 1 Light deed":a<=9?"1 Mighty & 1 Light, or 2 Heavy deeds":"1 Mighty, 1 Heavy deed":a<=6?"1 Heavy deed":a<=9?"1 Heavy, 1 Mighty deed":"2 Heavy, 1 Mighty deed";let r={...s};return r[e]={roll:a,text:n},r})},[]),b=(0,n.useMemo)(()=>{if(o||0===y.length)return!1;let e=y.filter(e=>"player"===e.type);return 0===e.length||e.every(e=>void 0!==e.initiative&&e.initiative>0||e.nat20)},[y,o]),{turnOrder:N,activeTurn:w,untrackedPlayers:C}=(0,n.useMemo)(()=>{if(o||0===y.length)return{turnOrder:[],activeTurn:null,untrackedPlayers:[]};let e=y.filter(e=>"player"===e.type),t=y.filter(e=>"monster"===e.type),s=e.filter(e=>(void 0===e.initiative||e.initiative<=0)&&!e.nat20),a=e.filter(e=>void 0!==e.initiative&&e.initiative>0||e.nat20),n=(e,t)=>(t.initiative||0)-(e.initiative||0),r=a.filter(e=>e.nat20).sort(n),i=a.filter(e=>!e.nat20),l=t.length>0?Math.max(...t.map(e=>e.initiative)):-1/0,d=i.filter(e=>(e.initiative||0)>l).sort(n),c=i.filter(e=>(e.initiative||0)<=l).sort(n),m=[...t].sort(n),x=t.filter(e=>"Paragon"===e.template||"Tyrant"===e.template).sort(n),h=[...r.map(e=>({...e,turnId:"".concat(e.id,"-start")})),...d.map(e=>({...e,turnId:e.id})),...m.map(e=>({...e,turnId:e.id})),...c.map(e=>({...e,turnId:e.id})),...r.map(e=>({...e,turnId:"".concat(e.id,"-end")})),...x.map(e=>({...e,turnId:"".concat(e.id,"-extra")}))],p=b?h[u]:null;return{turnOrder:h,activeTurn:p,untrackedPlayers:s}},[y,u,o,b]);(0,n.useEffect)(()=>{(async()=>{m(!0);let e=t.monsterGroups.map(e=>e.monsterId),s=await (0,l.C8)(e),a=new Map(s.map(e=>[e.id,e])),n=s.flatMap(e=>e.deeds),r=new Map((await (0,l.pT)(n)).map(e=>[e.id,e])),i=[];(t.players||[]).forEach(e=>{i.push({id:e.id,type:"player",name:e.name,initiative:0,nat20:!1})}),(t.monsterGroups||[]).forEach(e=>{let t=a.get(e.monsterId);if(!t)return;let s=t.deeds.map(e=>r.get(e)).filter(Boolean);"Underling"===t.template&&(s=s.filter(e=>"light"===e.tier));for(let a=0;a<e.quantity;a++){let n={id:crypto.randomUUID(),type:"monster",name:e.quantity>1?"".concat(t.name," ").concat(a+1):t.name,monsterId:t.id,level:t.level,role:t.role,template:t.template||"Normal",TR:t.TR,initiative:t.attributes.Initiative,maxHp:"Underling"===t.template?1:t.attributes.HP,currentHp:"Underling"===t.template?1:t.attributes.HP,attributes:t.attributes,deeds:s,abilities:t.abilities,description:t.description,tags:t.tags,states:[]};i.push(n)}}),d({1:i}),v(1,i),m(!1)})()},[t,v]);let k=()=>{if(b)if(u+1>=N.length){let e=h+1;if(!r[e]){let t=JSON.parse(JSON.stringify(y));t.forEach(e=>{"player"===e.type&&(e.initiative=0,e.nat20=!1)}),d(s=>({...s,[e]:t})),v(e,t)}p(e),x(0)}else x(e=>e+1)},S=()=>{0===u&&h>1?(p(h-1),x(0)):u>0&&x(e=>e-1)},T=(0,n.useMemo)(()=>f[h]||{roll:0,text:""},[f,h]),R=(0,n.useCallback)(e=>{d(t=>{if(!t[h])return t;let s=(t[h]||[]).map(t=>t.id===e.id?e:t),a={...t,[h]:s};if("player"===e.type)for(let s=h+1;s<=Math.max(...Object.keys(t).map(Number));s++)a[s]&&(a[s]=a[s].map(t=>t.id===e.id?{...t,initiative:e.initiative,nat20:e.nat20}:t));return a})},[h]);return o?(0,a.jsx)("div",{className:"flex h-screen w-full items-center justify-center",children:(0,a.jsx)(F.E,{className:"h-48 w-48"})}):g?(0,a.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,a.jsxs)("header",{className:"py-4 px-6 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(I.A,{className:"text-primary h-8 w-8"}),(0,a.jsx)("h1",{className:"text-xl md:text-3xl font-headline font-bold text-primary-foreground whitespace-nowrap",children:t.name})]}),(0,a.jsx)(c.$,{variant:"destructive",onClick:s,children:"End Encounter"})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,a.jsx)(et,{combatantsInTurnOrder:N,untrackedPlayers:C,activeTurnId:(null==w?void 0:w.turnId)||null,round:h,onNextTurn:k,onPrevTurn:S,onCombatantUpdate:R,perilRoll:T.roll,perilText:T.text,allPlayersReady:b,turnIndex:u}),w?(0,a.jsx)(ec,{combatant:w,onUpdate:R},w.turnId):(0,a.jsx)("div",{className:"p-8 text-center text-muted-foreground flex items-center justify-center h-full rounded-lg bg-card",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,a.jsx)("p",{children:'Set player initiatives and press "Next" to begin.'})]})})]})]}):(0,a.jsx)(i.GB,{children:(0,a.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,a.jsxs)("header",{className:"py-4 px-6 md:px-8 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(i.x2,{}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(I.A,{className:"text-primary h-8 w-8"}),(0,a.jsx)("h1",{className:"text-2xl md:text-3xl font-headline font-bold text-primary-foreground",children:t.name})]})]}),(0,a.jsx)(c.$,{variant:"destructive",onClick:s,children:"End Encounter"})]}),(0,a.jsxs)("div",{className:"flex flex-1 min-h-0",children:[(0,a.jsx)(i.Bx,{style:{"--sidebar-width":"300px"},children:o?(0,a.jsx)(F.E,{className:"h-full w-full"}):(0,a.jsx)(et,{combatantsInTurnOrder:N,untrackedPlayers:C,activeTurnId:(null==w?void 0:w.turnId)||null,round:h,onNextTurn:k,onPrevTurn:S,onCombatantUpdate:R,perilRoll:T.roll,perilText:T.text,allPlayersReady:b,turnIndex:u})}),(0,a.jsx)(i.sF,{className:"flex-1 overflow-y-auto bg-background/50",children:(0,a.jsx)("div",{className:"p-4 sm:p-6 md:p-8 h-full",children:w?(0,a.jsx)(ec,{combatant:w,onUpdate:R},w.turnId):(0,a.jsx)("div",{className:"text-center text-muted-foreground flex items-center justify-center h-full",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xl",children:"Encounter loaded."}),(0,a.jsx)("p",{children:'Set player initiatives and press "Next" to begin.'})]})})})})]})]})})}function eu(){let[e,t]=(0,n.useState)("preparation"),[s,d]=(0,n.useState)(null),[c,o]=(0,n.useState)(null),[m,x]=(0,n.useState)(!1),[h,p]=(0,n.useState)(0),[f,j]=(0,n.useState)(""),[g,y]=(0,n.useState)(""),[b,N]=(0,n.useState)(""),[w,C]=(0,n.useState)(""),[k,S]=(0,n.useState)("name"),[T,R]=(0,n.useState)("asc"),I=()=>p(e=>e+1),{toast:M}=(0,u.dj)(),A=async e=>{try{let s=await (0,l.eq)(e);s?(o(s),t("live")):M({variant:"destructive",title:"Error",description:"Could not find encounter to run."})}catch(e){M({variant:"destructive",title:"Error",description:"Failed to load encounter data."})}};return"live"===e&&c?(0,a.jsx)(em,{encounter:c,onEndEncounter:()=>{o(null),t("preparation")}}):(0,a.jsx)(i.GB,{children:(0,a.jsx)(r.A,{children:(0,a.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,a.jsx)(i.Bx,{style:{"--sidebar-width":"380px"},children:(0,a.jsx)(v,{onSelectEncounter:e=>{d(e),x(!1)},onNewEncounter:()=>{d(null),x(!0)},selectedEncounterId:s,dataVersion:h,filters:{searchTerm:f,tagFilter:g,minTR:b,maxTR:w,sortBy:k,sortOrder:T},setFilters:{setSearchTerm:j,setTagFilter:y,setMinTR:N,setMaxTR:C,setSortBy:S,setSortOrder:R},onClearFilters:()=>{j(""),y(""),N(""),C(""),S("name"),R("asc")}})}),(0,a.jsx)(i.sF,{className:"flex-1 overflow-y-auto",children:(0,a.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 h-full w-full",children:(0,a.jsx)(O,{encounterId:s,isCreatingNew:m,onEncounterSaveSuccess:e=>{I(),d(e),x(!1)},onEncounterDeleteSuccess:()=>{I(),d(null),x(!1)},onEditCancel:()=>{m&&(x(!1),d(null))},onRunEncounter:A,onFilterByClick:(e,t)=>{t.shiftKey?(void 0!==e.minTR&&N(String(e.minTR)),void 0!==e.maxTR&&C(String(e.maxTR)),e.tagFilter&&y(t=>t?t.split(",").map(e=>e.trim()).includes(e.tagFilter)?t:"".concat(t,", ").concat(e.tagFilter):e.tagFilter)):(N(void 0!==e.minTR?String(e.minTR):""),C(void 0!==e.maxTR?String(e.maxTR):""),y(e.tagFilter||""))}},null!=s?s:m?"new":"placeholder")})})]})})})}},4165:(e,t,s)=>{"use strict";s.d(t,{Cf:()=>u,L3:()=>h,c7:()=>x,lG:()=>d,rr:()=>p,zM:()=>c});var a=s(5155),n=s(2115),r=s(5821),i=s(5318),l=s(9434);let d=r.bL,c=r.l9,o=r.ZL;r.bm;let m=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.hJ,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...n})});m.displayName=r.hJ.displayName;let u=n.forwardRef((e,t)=>{let{className:s,children:n,...d}=e;return(0,a.jsxs)(o,{children:[(0,a.jsx)(m,{}),(0,a.jsxs)(r.UC,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...d,children:[n,(0,a.jsxs)(r.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(i.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});u.displayName=r.UC.displayName;let x=e=>{let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...s})};x.displayName="DialogHeader";let h=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.hE,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight",s),...n})});h.displayName=r.hE.displayName;let p=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.VY,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",s),...n})});p.displayName=r.VY.displayName},6612:(e,t,s)=>{Promise.resolve().then(s.bind(s,3819))},7262:(e,t,s)=>{"use strict";s.d(t,{S:()=>d});var a=s(5155),n=s(2115),r=s(6981),i=s(518),l=s(9434);let d=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.bL,{ref:t,className:(0,l.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...n,children:(0,a.jsx)(r.C1,{className:(0,l.cn)("flex items-center justify-center text-current"),children:(0,a.jsx)(i.A,{className:"h-4 w-4"})})})});d.displayName=r.bL.displayName}},e=>{var t=t=>e(e.s=t);e.O(0,[965,439,909,625,441,684,358],()=>t(6612)),_N_E=e.O()}]);