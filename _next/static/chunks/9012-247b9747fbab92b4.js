"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9012],{99012:(e,s,t)=>{t.r(s),t.d(s,{default:()=>eC});var l=t(95155),n=t(12115),r=t(46855),a=t(20031),i=t(53648),o=t(62523),c=t(30285),d=t(66424),u=t(22346),h=t(87481),x=t(34301),m=t(75074),j=t(20203),g=t(73926),p=t(85057),f=t(59409),v=t(90648);function N(e){let{onSelectDungeon:s,onNewDungeon:t,selectedDungeonId:r,dataVersion:a,filters:N,setFilters:y,onClearFilters:b}=e,[w,C]=(0,n.useState)([]),[k,S]=(0,n.useState)(!0),{toast:R}=(0,h.dj)();(0,n.useEffect)(()=>{(async()=>{S(!0);try{C(await (0,i.J0)())}catch(e){R({variant:"destructive",title:"Error",description:"Could not fetch dungeons from database."})}finally{S(!1)}})()},[a,R]);let I=(0,n.useMemo)(()=>{let e=w.filter(e=>{let s=e.name.toLowerCase().includes(N.searchTerm.toLowerCase()),t=!0,l=N.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);return l.length>0&&(t=!!e.tags&&l.every(s=>e.tags.some(e=>e.toLowerCase().includes(s)))),s&&t}).sort((e,s)=>{if("threatRating"===N.sortBy){var t,l;let n=(null!=(t=e.threatRating)?t:0)-(null!=(l=s.threatRating)?l:0);if(0!==n)return n}return e.name.localeCompare(s.name)});return"desc"===N.sortOrder&&e.reverse(),e},[w,N]);return(0,l.jsxs)("div",{className:"flex flex-col h-full",children:[(0,l.jsxs)("div",{className:"p-4 space-y-4",children:[(0,l.jsxs)(c.$,{onClick:t,className:"w-full",children:[(0,l.jsx)(x.A,{})," New Dungeon"]}),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)(m.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,l.jsx)(o.p,{placeholder:"Search dungeons...",value:N.searchTerm,onChange:e=>y.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)(p.J,{children:"Filter"}),(0,l.jsx)(c.$,{variant:"ghost",size:"sm",onClick:b,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,l.jsx)(v.F,{value:N.tagFilter?N.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>y.setTagFilter(e.join(",")),placeholder:"Tags...",tagSource:"dungeon"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)(p.J,{children:"Sort by"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)(f.l6,{value:N.sortBy,onValueChange:e=>y.setSortBy(e),children:[(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"Sort by"})}),(0,l.jsxs)(f.gC,{children:[(0,l.jsx)(f.eb,{value:"name",children:"Name"}),(0,l.jsx)(f.eb,{value:"threatRating",children:"Threat Rating"})]})]}),(0,l.jsxs)(c.$,{variant:"ghost",size:"icon",onClick:()=>y.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===N.sortOrder?(0,l.jsx)(j.A,{className:"h-4 w-4"}):(0,l.jsx)(g.A,{className:"h-4 w-4"}),(0,l.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,l.jsx)(u.w,{}),(0,l.jsx)(d.F,{className:"flex-1",children:(0,l.jsx)("div",{className:"p-4",children:k?(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading dungeons..."}):I.length>0?(0,l.jsx)("ul",{className:"space-y-1",children:I.map(e=>(0,l.jsx)("li",{children:(0,l.jsxs)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(r===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,l.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.threatRating,")"]})]})},e.id))}):(0,l.jsx)("p",{className:"text-muted-foreground text-center",children:"No dungeons found."})})})]})}var y=t(62177),b=t(90221),w=t(55594);let C={I:{name:"Bleak",targetNumber:10,threatRating:"2d6 x 10",threatRange:"20 to 120"},II:{name:"Sinister",targetNumber:12,threatRating:"2d6 x 20",threatRange:"40 to 240"},III:{name:"Frightening",targetNumber:15,threatRating:"2d6 x 30",threatRange:"60 to 360"},IV:{name:"Harrowing",targetNumber:18,threatRating:"2d6 x 40",threatRange:"80 to 480"},V:{name:"Nightmarish",targetNumber:20,threatRating:"2d6 x 50",threatRange:"100 to 600"}},k={Tiny:{rooms:"2D4 (~5)",treasureRoll:"2D6 X HOSTILITY"},Small:{rooms:"4D4 (~10)",treasureRoll:"4D6 X HOSTILITY"},Medium:{rooms:"6D4 (~15)",treasureRoll:"6D6 X HOSTILITY"},Large:{rooms:"8D4 (~20)",treasureRoll:"8D6 X HOSTILITY"},Huge:{rooms:"10D4 (~25)",treasureRoll:"10D6 X HOSTILITY"}},S=Object.keys(C),R=Object.keys(k);var I=t(38914),z=t(66695),A=t(88539),T=t(90010),M=t(17759),D=t(18046),E=t(12543),$=t(21816),V=t(18763),B=t(77223),F=t(25318),L=t(81203),O=t(53054),X=t(32137),Z=t(67805),P=t(68856),J=t(47906),W=t(54165),H=t(47262),q=t(26126);let Y=w.z.object({instanceId:w.z.string(),roomId:w.z.string(),position:w.z.object({x:w.z.number(),y:w.z.number()})}),_=w.z.object({from:w.z.string().min(1,"A 'from' room must be selected."),to:w.z.string().min(1,"A 'to' room must be selected.")}),U=w.z.object({name:w.z.string().min(1,"Dungeon name is required"),description:w.z.string().optional(),hostility:w.z.enum(S),size:w.z.enum(R),threatRating:w.z.coerce.number(),treasureValue:w.z.coerce.number(),tags:w.z.array(w.z.string()).optional(),rooms:w.z.array(Y),connections:w.z.array(_)}),G=e=>{let{onAddRooms:s,existingRoomIds:t}=e,[r,a]=(0,n.useState)(!1),[u,h]=(0,n.useState)([]),[x,m]=(0,n.useState)(new Set),[j,g]=(0,n.useState)("");(0,n.useEffect)(()=>{r&&(0,i.SP)().then(h)},[r]);let p=(0,n.useMemo)(()=>u.filter(e=>e.name.toLowerCase().includes(j.toLowerCase())&&!t.has(e.id)),[u,j,t]);return(0,l.jsxs)(W.lG,{open:r,onOpenChange:a,children:[(0,l.jsx)(W.zM,{asChild:!0,children:(0,l.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",children:[(0,l.jsx)(D.A,{className:"h-4 w-4 mr-2"}),"Add Room"]})}),(0,l.jsxs)(W.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,l.jsx)(W.c7,{children:(0,l.jsx)(W.L3,{children:"Select Rooms"})}),(0,l.jsx)(o.p,{placeholder:"Search rooms...",value:j,onChange:e=>g(e.target.value),className:"mb-4 shrink-0"}),(0,l.jsx)(d.F,{className:"flex-1 border rounded-md p-2",children:(0,l.jsx)("div",{className:"space-y-1",children:p.map(e=>(0,l.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,l.jsx)(H.S,{id:"room-".concat(e.id),onCheckedChange:()=>m(s=>{let t=new Set(s);return t.has(e.id)?t.delete(e.id):t.add(e.id),t}),checked:x.has(e.id)}),(0,l.jsx)("label",{htmlFor:"room-".concat(e.id),className:"flex-1",children:(0,l.jsx)("p",{className:"font-semibold",children:e.name})})]},e.id))})}),(0,l.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,l.jsx)(c.$,{variant:"ghost",onClick:()=>a(!1),children:"Cancel"}),(0,l.jsx)(c.$,{onClick:()=>{s(u.filter(e=>x.has(e.id))),a(!1),m(new Set)},disabled:0===x.size,children:"Add Selected"})]})]})]})},K={name:"",description:"",hostility:"I",size:"Tiny",threatRating:0,treasureValue:0,tags:[],rooms:[],connections:[]};function Q(e){let{dungeonId:s,isCreatingNew:t,onSaveSuccess:r,onDeleteSuccess:a,onEditCancel:d,onRunDungeon:x,onBack:m,dataVersion:j}=e,{toast:g}=(0,h.dj)(),[p,N]=(0,n.useState)(t),[w,W]=(0,n.useState)(!t&&!!s),[H,Y]=(0,n.useState)(null),[_,Q]=(0,n.useState)([]),ee=(0,n.useMemo)(()=>new Map(_.map(e=>[e.id,e])),[_]),es=(0,J.a)(),{worldSlug:et}=(0,I.q)(),el=(0,y.mN)({resolver:(0,b.u)(U),defaultValues:K}),{control:en,watch:er,setValue:ea,getValues:ei}=el,{fields:eo,append:ec,remove:ed}=(0,y.jz)({control:en,name:"rooms"}),{fields:eu,append:eh,remove:ex}=(0,y.jz)({control:en,name:"connections"}),em=er("rooms");(0,n.useEffect)(()=>{ea("treasureValue",em.reduce((e,s)=>{let t=ee.get(s.roomId);return e+((null==t?void 0:t.totalTreasureValue)||0)},0))},[em,ee,ea]),(0,n.useEffect)(()=>{(0,i.SP)().then(Q)},[]),(0,n.useEffect)(()=>{(async()=>{if(t){el.reset(K),Y(null),N(!0),W(!1);return}if(!s){N(!1),W(!1),Y(null);return}W(!0),N(!1);try{let e=await (0,i.RT)(s);e?(el.reset(e),Y(e)):Y(null)}catch(e){g({variant:"destructive",title:"Error",description:"Could not load dungeon data."})}finally{W(!1)}})()},[s,t,el,g,j]);let ej=()=>{t?d():H&&(el.reset(H),N(!1))},eg=async e=>{try{var l;let n={...e,tags:e.tags||[]};(null==(l=e.tags)?void 0:l.length)&&await (0,i.JE)(e.tags,"dungeon");let a=s;t?(a=await (0,i.yV)(n),g({title:"Dungeon Created!"})):s&&(await (0,i.sO)({...n,id:s}),g({title:"Save Successful"})),a&&r(a),N(!1)}catch(e){g({variant:"destructive",title:"Save Failed"})}},ep=async()=>{if(s)try{await (0,i.OO)(s),g({title:"Dungeon Deleted"}),a()}catch(e){g({variant:"destructive",title:"Deletion Failed"})}},ef=(0,n.useMemo)(()=>new Set(eo.map(e=>e.roomId)),[eo]),ev=er("hostility"),eN=er("size");return w?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(z.Zp,{children:[(0,l.jsx)(z.aR,{children:(0,l.jsx)(P.E,{className:"h-8 w-48"})}),(0,l.jsx)(z.Wu,{children:(0,l.jsx)(P.E,{className:"h-40 w-full"})})]})}):s||t?!p&&H?(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsxs)(z.Zp,{children:[(0,l.jsx)(z.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[es&&m&&(0,l.jsx)(c.$,{variant:"ghost",size:"icon",onClick:m,className:"shrink-0 -ml-2 -mt-1",children:(0,l.jsx)(E.A,{className:"h-5 w-5"})}),(0,l.jsxs)("div",{children:[(0,l.jsx)(z.ZB,{className:"text-3xl font-bold",children:H.name}),(0,l.jsxs)(z.BT,{className:"flex flex-wrap gap-x-4",children:[(0,l.jsxs)("span",{children:["Hostility: ",C[H.hostility].name]}),(0,l.jsxs)("span",{children:["Size: ",H.size]}),(0,l.jsxs)("span",{children:["TR: ",H.threatRating]}),(0,l.jsxs)("span",{children:["Treasure: ",H.treasureValue]})]})]})]}),(0,l.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,l.jsxs)(c.$,{variant:"default",size:"sm",onClick:()=>x(H.id),children:[(0,l.jsx)($.A,{className:"h-4 w-4 mr-2"}),"Run"]}),(0,l.jsxs)(c.$,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[(0,l.jsx)(V.A,{className:"h-4 w-4 mr-2"}),"Edit"]})]})]})}),(0,l.jsxs)(z.Wu,{className:"space-y-6",children:[H.description&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Description"}),(0,l.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:H.description})]}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:["Rooms (",H.rooms.length,")"]}),(0,l.jsx)("ul",{className:"list-disc pl-5 space-y-1",children:H.rooms.map(e=>{var s;return(0,l.jsx)("li",{children:(0,l.jsx)("a",{href:"#/".concat(et,"/rooms/").concat(e.roomId),className:"text-accent hover:underline",children:(null==(s=ee.get(e.roomId))?void 0:s.name)||"Unknown Room"})},e.instanceId)})})]}),H.tags&&H.tags.length>0&&(0,l.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,l.jsx)("div",{className:"flex flex-wrap gap-2",children:H.tags.map(e=>(0,l.jsx)(q.E,{variant:"secondary",children:e},e))})})]}),(0,l.jsx)(z.wL,{children:(0,l.jsxs)(T.Lt,{children:[(0,l.jsx)(T.tv,{asChild:!0,children:(0,l.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(B.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(T.EO,{children:[(0,l.jsxs)(T.wd,{children:[(0,l.jsx)(T.r7,{children:"Are you sure?"}),(0,l.jsxs)(T.$v,{children:['This will permanently delete "',H.name,'".']})]}),(0,l.jsxs)(T.ck,{children:[(0,l.jsx)(T.Zr,{children:"Cancel"}),(0,l.jsx)(T.Rx,{onClick:ep,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(z.Zp,{children:(0,l.jsx)(M.lV,{...el,children:(0,l.jsxs)("form",{onSubmit:el.handleSubmit(eg),className:"space-y-6",children:[(0,l.jsx)(z.aR,{children:(0,l.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[es&&m&&(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:ej,className:"shrink-0 -ml-2",children:(0,l.jsx)(E.A,{className:"h-5 w-5"})}),(0,l.jsx)(z.ZB,{children:t?"Create New Dungeon":"Editing: ".concat(el.getValues("name")||"...")})]}),!es&&(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:ej,className:"text-muted-foreground hover:text-foreground",children:(0,l.jsx)(F.A,{className:"h-5 w-5"})})]})}),(0,l.jsxs)(z.Wu,{className:"space-y-6",children:[(0,l.jsx)(M.zB,{name:"name",control:en,render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsx)(M.lR,{children:"Dungeon Name"}),(0,l.jsx)(M.MJ,{children:(0,l.jsx)(o.p,{...s})}),(0,l.jsx)(M.C5,{})]})}}),(0,l.jsx)(M.zB,{name:"description",control:en,render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsx)(M.lR,{children:"Description"}),(0,l.jsx)(M.MJ,{children:(0,l.jsx)(A.T,{...s,rows:3})})]})}}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,l.jsx)(M.zB,{control:en,name:"hostility",render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsx)(M.lR,{children:"Hostility"}),(0,l.jsxs)(f.l6,{onValueChange:s.onChange,defaultValue:s.value,children:[(0,l.jsx)(M.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{})})}),(0,l.jsx)(f.gC,{children:S.map(e=>(0,l.jsxs)(f.eb,{value:e,children:[e,": ",C[e].name]},e))})]}),(0,l.jsx)(M.C5,{})]})}}),(0,l.jsx)(M.zB,{control:en,name:"size",render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsx)(M.lR,{children:"Size"}),(0,l.jsxs)(f.l6,{onValueChange:s.onChange,defaultValue:s.value,children:[(0,l.jsx)(M.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{})})}),(0,l.jsx)(f.gC,{children:R.map(e=>(0,l.jsx)(f.eb,{value:e,children:e},e))})]}),(0,l.jsx)(M.C5,{})]})}})]}),(0,l.jsxs)(z.Zp,{className:"p-4 bg-muted/50",children:[(0,l.jsx)(z.aR,{className:"p-0 pb-2",children:(0,l.jsxs)(z.ZB,{className:"text-base flex items-center gap-2",children:[(0,l.jsx)(L.A,{className:"h-5 w-5"})," Target Values"]})}),(0,l.jsxs)(z.Wu,{className:"p-0 text-sm text-muted-foreground grid grid-cols-2 md:grid-cols-3 gap-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"Rooms: "}),k[eN].rooms]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"Treasure: "}),k[eN].treasureRoll]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-semibold text-foreground",children:"TR Range: "}),C[ev].threatRange]})]})]}),(0,l.jsx)(M.zB,{name:"tags",control:en,render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsxs)(M.lR,{className:"flex items-center gap-2",children:[(0,l.jsx)(O.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,l.jsx)(M.MJ,{children:(0,l.jsx)(v.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"dungeon"})}),(0,l.jsx)(M.C5,{})]})}}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[(0,l.jsx)(X.A,{className:"h-5 w-5"}),"Rooms"]}),(0,l.jsx)(G,{onAddRooms:e=>{let s=eo.length;e.forEach((e,t)=>{let l=s+t,n=130*Math.floor(l/4),r=l%4*200+(Math.random()-.5)*40,a=n+(Math.random()-.5)*40;ec({instanceId:crypto.randomUUID(),roomId:e.id,position:{x:r,y:a}})})},existingRoomIds:ef})]}),(0,l.jsxs)("div",{className:"space-y-2 pr-2",children:[eo.map((e,s)=>{var t;return(0,l.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-card-foreground/5 rounded-md",children:[(0,l.jsx)("p",{className:"flex-1 font-semibold",children:(null==(t=ee.get(e.roomId))?void 0:t.name)||"Unknown Room"}),(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>ed(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,l.jsx)(B.A,{className:"h-4 w-4"})})]},e.id)}),0===eo.length&&(0,l.jsx)("p",{className:"text-muted-foreground text-center text-sm py-4",children:"No rooms added."})]}),(0,l.jsx)(M.zB,{control:en,name:"treasureValue",render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{className:"mt-2",children:[(0,l.jsx)(M.lR,{children:"Total Treasure Value"}),(0,l.jsx)(M.MJ,{children:(0,l.jsx)(o.p,{type:"number",...s,readOnly:!0,className:"w-24 bg-muted border-none"})})]})}})]}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsxs)("h3",{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[(0,l.jsx)(Z.A,{className:"h-5 w-5"}),"Connections"]}),(0,l.jsxs)(c.$,{type:"button",size:"sm",variant:"outline",onClick:()=>eh({from:"",to:""}),disabled:eo.length<2,children:[(0,l.jsx)(D.A,{className:"h-4 w-4 mr-2"}),"Add Connection"]})]}),(0,l.jsxs)("div",{className:"space-y-2 pr-2",children:[eu.map((e,s)=>(0,l.jsxs)("div",{className:"grid grid-cols-[1fr_auto_1fr_auto] items-start gap-2 p-2 bg-card-foreground/5 rounded-md",children:[(0,l.jsx)(M.zB,{control:en,name:"connections.".concat(s,".from"),render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsxs)(f.l6,{onValueChange:s.onChange,value:s.value||"",children:[(0,l.jsx)(M.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"From Room..."})})}),(0,l.jsx)(f.gC,{children:eo.map(e=>{var s;return(0,l.jsx)(f.eb,{value:e.instanceId,children:(null==(s=ee.get(e.roomId))?void 0:s.name)||"..."},e.instanceId)})})]}),(0,l.jsx)(M.C5,{})]})}}),(0,l.jsx)("span",{className:"pt-2",children:"->"}),(0,l.jsx)(M.zB,{control:en,name:"connections.".concat(s,".to"),render:e=>{let{field:s}=e;return(0,l.jsxs)(M.eI,{children:[(0,l.jsxs)(f.l6,{onValueChange:s.onChange,value:s.value||"",children:[(0,l.jsx)(M.MJ,{children:(0,l.jsx)(f.bq,{children:(0,l.jsx)(f.yv,{placeholder:"To Room..."})})}),(0,l.jsx)(f.gC,{children:eo.map(e=>{var s;return(0,l.jsx)(f.eb,{value:e.instanceId,children:(null==(s=ee.get(e.roomId))?void 0:s.name)||"..."},e.instanceId)})})]}),(0,l.jsx)(M.C5,{})]})}}),(0,l.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>ex(s),className:"text-muted-foreground hover:text-destructive shrink-0 self-center",children:(0,l.jsx)(B.A,{className:"h-4 w-4"})})]},e.id)),0===eu.length&&(0,l.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No connections added."})]})]})]}),(0,l.jsxs)(z.wL,{className:"flex items-center gap-2",children:[!t&&(0,l.jsxs)(T.Lt,{children:[(0,l.jsx)(T.tv,{asChild:!0,children:(0,l.jsx)(c.$,{type:"button",variant:"destructive",size:"sm",children:(0,l.jsx)(B.A,{className:"h-4 w-4"})})}),(0,l.jsxs)(T.EO,{children:[(0,l.jsxs)(T.wd,{children:[(0,l.jsx)(T.r7,{children:"Are you sure?"}),(0,l.jsxs)(T.$v,{children:['This will permanently delete "',ei("name"),'".']})]}),(0,l.jsxs)(T.ck,{children:[(0,l.jsx)(T.Zr,{children:"Cancel"}),(0,l.jsx)(T.Rx,{onClick:ep,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,l.jsx)("div",{className:"flex-grow"}),!es&&(0,l.jsx)(c.$,{type:"button",variant:"outline",onClick:ej,children:"Cancel"}),(0,l.jsx)(c.$,{type:"submit",children:t?"Create Dungeon":"Save Changes"})]})]})})})}):(0,l.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,l.jsx)(z.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,l.jsx)(z.Wu,{className:"text-center pt-6",children:(0,l.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select a dungeon to view or create one."})})})})}var ee=t(74211),es=t(93306),et=t(77581),el=t(57916);t(11687);var en=t(88251),er=t.n(en),ea=t(73336),ei=t(8531),eo=t(86438),ec=t(67554),ed=t(73503),eu=t(98917),eh=t(22945);function ex(e,s){var t,l,n,r,a,i;let{width:o,height:c,positionAbsolute:d}=e,u=s.positionAbsolute,h=(null!=o?o:0)/2,x=(null!=c?c:0)/2,m=(null!=(t=null==d?void 0:d.x)?t:0)+h,j=(null!=(l=null==d?void 0:d.y)?l:0)+x,g=(null!=(n=null==u?void 0:u.x)?n:0)+(null!=(r=s.width)?r:0)/2,p=(null!=(a=null==u?void 0:u.y)?a:0)+(null!=(i=s.height)?i:0)/2,f=(g-m)/(2*h)-(p-j)/(2*x),v=(g-m)/(2*h)+(p-j)/(2*x),N=1/(Math.abs(f)+Math.abs(v)),y=N*f,b=N*v;return{x:h*(y+b)+m,y:x*(-y+b)+j}}function em(e,s){var t,l,n,r;let a={...e.positionAbsolute,...e},i=Math.round(null!=(t=a.x)?t:0),o=Math.round(null!=(l=a.y)?l:0),c=Math.round(s.x),d=Math.round(s.y);return c<=i+1?"left":c>=i+(null!=(n=a.width)?n:0)-1?"right":d<=o+1?"top":d>=o+(null!=(r=a.height)?r:0)-1?"bottom":"top"}let ej=e=>{let{fromNode:s,toX:t,toY:n}=e;if(!s)return null;let{x:r,y:a}=function(e,s){var t,l,n,r,a,i;let{width:o,height:c,positionAbsolute:d}=e,u=s.positionAbsolute,h=(null!=o?o:0)/2,x=(null!=c?c:0)/2,m=(null!=(t=null==d?void 0:d.x)?t:0)+h,j=(null!=(l=null==d?void 0:d.y)?l:0)+x,g=(null!=(n=null==u?void 0:u.x)?n:0)+(null!=(r=s.width)?r:0)/2,p=(null!=(a=null==u?void 0:u.y)?a:0)+(null!=(i=s.height)?i:0)/2,f=(g-m)/(2*h)-(p-j)/(2*x),v=(g-m)/(2*h)+(p-j)/(2*x),N=1/(Math.abs(f)+Math.abs(v)),y=N*f,b=N*v;return{x:h*(y+b)+m,y:x*(-y+b)+j}}(s,{id:"target-node",width:1,height:1,positionAbsolute:{x:t,y:n}}),[i]=(0,ee.Fp)({sourceX:r,sourceY:a,sourcePosition:"bottom",targetX:t,targetY:n,targetPosition:"top"});return(0,l.jsxs)("g",{children:[(0,l.jsx)("path",{fill:"none",stroke:"hsl(var(--primary))",strokeWidth:1.5,className:"animated",d:i}),(0,l.jsx)("circle",{cx:t,cy:n,fill:"#fff",r:3,stroke:"hsl(var(--primary))",strokeWidth:1.5})]})},eg={visibility:"hidden"},ep={floating:function(e){let{id:s,source:t,target:r,markerEnd:a,style:i}=e,o=(0,ee.Pj)((0,n.useCallback)(e=>e.nodeInternals.get(t),[t])),c=(0,ee.Pj)((0,n.useCallback)(e=>e.nodeInternals.get(r),[r]));if(!o||!c)return null;let d=ex(o,c),u=ex(c,o),h=em(o,d),x=em(c,u),[m]=(0,ee.Fp)({sourceX:d.x,sourceY:d.y,sourcePosition:h,targetX:u.x,targetY:u.y,targetPosition:x});return(0,l.jsx)(ee.tE,{id:s,path:m,markerEnd:a,style:i})}},ef={dungeonRoom:function(e){let{data:s}=e;return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(ee.h7,{type:"source",position:ee.yX.Top,style:eg}),(0,l.jsx)(ee.h7,{type:"source",position:ee.yX.Right,style:eg}),(0,l.jsx)(ee.h7,{type:"source",position:ee.yX.Bottom,style:eg}),(0,l.jsx)(ee.h7,{type:"source",position:ee.yX.Left,style:eg}),(0,l.jsx)(ee.h7,{type:"target",position:ee.yX.Top,style:eg}),(0,l.jsx)(ee.h7,{type:"target",position:ee.yX.Right,style:eg}),(0,l.jsx)(ee.h7,{type:"target",position:ee.yX.Bottom,style:eg}),(0,l.jsx)(ee.h7,{type:"target",position:ee.yX.Left,style:eg}),(0,l.jsx)("div",{className:"w-full h-full flex items-center justify-center text-center p-2",children:s.label})]})}},ev=new(er()),eN={"elk.algorithm":"force","elk.force.iterations":"1000","elk.force.alpha":"1","elk.force.gravity":"0.01","elk.spacing.nodeNode":"120"},ey=(e,s)=>{let t={id:"root",layoutOptions:eN,children:e.map(e=>{var s,t;return{id:e.id,width:(null==(s=e.style)?void 0:s.width)||150,height:(null==(t=e.style)?void 0:t.height)||80}}),edges:s.map(e=>({id:e.id,sources:[e.source],targets:[e.target]}))};return ev.layout(t).then(s=>e.map(e=>{var t;let l=null==(t=s.children)?void 0:t.find(s=>s.id===e.id);return(null==l?void 0:l.x)&&(null==l?void 0:l.y)&&(null==l?void 0:l.width)&&(null==l?void 0:l.height)&&(e.position={x:l.x,y:l.y}),e})).catch(s=>(console.error("ELK layout error:",s),e))};function eb(e){var s;let{dungeon:t,onEndDungeon:r}=e,[a,o]=(0,n.useState)(!0),[x,m]=(0,n.useState)(null),[j,g]=(0,n.useState)(null),[p,f]=(0,n.useState)(null),[v,N]=(0,n.useState)(null),[y,b]=(0,n.useState)(0),[w,C]=(0,n.useState)([0]),{toast:k}=(0,h.dj)(),[S,R,I]=(0,ee.ck)([]),[A,T,M]=(0,ee.fM)([]),{fitView:V}=(0,ee.VH)(),B=(0,n.useCallback)(()=>{ey(S,A).then(e=>{R(e),window.requestAnimationFrame(()=>{V({duration:800,padding:.1})})})},[S,A,R,V]),F=Math.floor(y/3)+1,L=null!=(s=w[y])?s:0,O=e=>{let s=Math.max(0,Math.min(10,L+e)),t=[...w];t[y]=s,C(t)},X=(0,n.useCallback)((e,s)=>{if(!s){f(null),N(null);return}f(s.id),N(null)},[f,N]);(0,n.useEffect)(()=>{if(p){let e=new Set([p]);t.connections.forEach(s=>{s.from===p&&e.add(s.to),s.to===p&&e.add(s.from)}),setTimeout(()=>{V({nodes:Array.from(e).map(e=>({id:e})),duration:600,padding:.2})},10)}},[p,t.connections,V]),(0,n.useEffect)(()=>{(async()=>{o(!0);let e=await (0,i.SP)(),s=new Map(e.map(e=>[e.id,e])),t=e.flatMap(e=>e.features.flatMap(e=>e.encounterIds)),l=await Promise.all(t.map(e=>(0,i.eq)(e).catch(()=>null)));e.flatMap(e=>e.features.flatMap(e=>e.treasureIds));let n=await (0,i.h4)();e.flatMap(e=>e.features.flatMap(e=>e.alchemicalItemIds));let r=await (0,i.vV)();g({rooms:s,encounters:new Map(l.filter(e=>null!==e).map(e=>[e.id,e])),treasures:new Map(n.map(e=>[e.id,e])),alchemicalItems:new Map(r.map(e=>[e.id,e]))}),o(!1)})()},[t]);let Z=(0,n.useMemo)(()=>t&&j?t.rooms.map(e=>{let s=j.rooms.get(e.roomId);return{id:e.instanceId,position:{x:0,y:0},data:{label:(null==s?void 0:s.name)||"Loading..."},style:{background:"hsl(var(--card))",color:"hsl(var(--card-foreground))",border:"2px solid",borderColor:"hsl(var(--border))",width:150,height:80,borderRadius:"var(--radius)",boxShadow:"0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)"},type:"dungeonRoom"}}):[],[t,j]),J=(0,n.useMemo)(()=>t?t.connections.map(e=>({id:"edge-".concat(e.from,"-").concat(e.to),source:e.from,target:e.to,type:"floating",style:{strokeWidth:2,stroke:"hsl(var(--border))"}})):[],[t]);(0,n.useEffect)(()=>{Z.length>0&&ey(Z,J).then(e=>{R(e),T(J),setTimeout(()=>{V({duration:800,padding:.1})},100)})},[Z,J,R,T,V]),(0,n.useEffect)(()=>{R(e=>e.map(e=>{let s=e.id===p;return{...e,style:{...e.style,background:s?"hsl(var(--primary))":"hsl(var(--card))",color:s?"hsl(var(--primary-foreground))":"hsl(var(--card-foreground))",borderColor:s?"hsl(var(--ring))":"hsl(var(--border))"}}})),T(e=>e.map(e=>{let s=p&&(e.source===p||e.target===p);return{...e,animated:s,style:{...e.style,strokeWidth:s?2.5:1.5,stroke:s?"hsl(var(--primary))":"hsl(var(--border))"}}}))},[p,R,T]);let W=(0,n.useMemo)(()=>{if(!p||!j)return null;let e=t.rooms.find(e=>e.instanceId===p);return e?j.rooms.get(e.roomId):null},[p,t,j]),H=(0,n.useMemo)(()=>v&&j&&j.encounters.get(v)||null,[v,j]),q=async e=>{let s=null==j?void 0:j.encounters.get(e);s?m(s):k({variant:"destructive",title:"Error",description:"Could not find encounter data."})};return x?(0,l.jsx)(ea.A,{encounter:x,onEndEncounter:()=>m(null)}):a?(0,l.jsx)("div",{className:"flex h-screen w-full items-center justify-center",children:(0,l.jsx)(P.E,{className:"h-48 w-48"})}):(0,l.jsxs)("div",{className:"flex flex-col h-screen w-full bg-background/50",children:[(0,l.jsxs)("header",{className:"py-4 px-6 border-b border-border flex items-center justify-between shrink-0 bg-background/80 backdrop-blur-sm sticky top-0 z-20",children:[(0,l.jsx)("h1",{className:"text-xl md:text-3xl font-bold text-primary-foreground",children:t.name}),(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,l.jsx)("div",{className:"text-xs text-muted-foreground",children:"Alert"}),(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>{let e=[...w];e[y]=0,C(e)},title:"Reset Alert",children:(0,l.jsx)(ei.A,{className:"h-3 w-3"})})]}),(0,l.jsxs)("div",{className:"text-lg font-bold flex items-center gap-1",children:[(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>O(-1),disabled:L<=0,children:(0,l.jsx)(eo.A,{className:"h-4 w-4"})}),L,(0,l.jsx)(c.$,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>O(1),disabled:L>=10,children:(0,l.jsx)(D.A,{className:"h-4 w-4"})})]})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"text-xs text-muted-foreground",children:"Round / Action"}),(0,l.jsxs)("div",{className:"text-lg font-bold",children:[F," / ",y%3+1]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>{b(e=>Math.max(0,e-1))},disabled:0===y,children:"Prev Action"}),(0,l.jsx)(c.$,{variant:"default",size:"sm",onClick:()=>{b(e=>{let s=e+1;return C(e=>{var t;let l=[...e],n=null!=(t=e[e.length-1])?t:0;return s>=l.length&&(l[s]=n),l}),s})},children:"Next Action"})]}),(0,l.jsx)(c.$,{variant:"outline",size:"icon",onClick:B,title:"Re-Layout",children:(0,l.jsx)(ec.A,{className:"h-4 w-4"})}),(0,l.jsx)(c.$,{variant:"destructive",onClick:r,children:"End Dungeon"})]})]}),(0,l.jsxs)("div",{className:"flex flex-1 min-h-0",children:[(W||H)&&(0,l.jsxs)("div",{className:"w-[380px] border-r border-border bg-card p-4 flex flex-col",children:[H?(0,l.jsxs)(c.$,{variant:"ghost",className:"self-start mb-2 -ml-2",onClick:()=>N(null),children:[(0,l.jsx)(E.A,{className:"h-4 w-4 mr-2"})," Back to Room Details"]}):(0,l.jsxs)(c.$,{variant:"ghost",className:"self-start mb-2 -ml-2",onClick:()=>{f(null),N(null)},children:[(0,l.jsx)(E.A,{className:"h-4 w-4 mr-2"})," Back to Dungeon View"]}),(0,l.jsx)(d.F,{className:"flex-1",children:H?(0,l.jsxs)(z.Zp,{children:[(0,l.jsxs)(z.aR,{children:[(0,l.jsx)(z.ZB,{children:H.name}),(0,l.jsxs)(z.BT,{children:["TR: ",H.totalTR]})]}),(0,l.jsxs)(z.Wu,{children:[(0,l.jsxs)(c.$,{className:"w-full",onClick:()=>q(H.id),children:[(0,l.jsx)($.A,{className:"h-4 w-4 mr-2"}),"Run Encounter"]}),(0,l.jsx)("p",{className:"mt-4 text-sm whitespace-pre-wrap",children:H.sceneDescription})]})]}):W?(0,l.jsxs)(z.Zp,{children:[(0,l.jsxs)(z.aR,{children:[(0,l.jsx)(z.ZB,{children:W.name}),(0,l.jsx)(z.BT,{children:W.size})]}),(0,l.jsxs)(z.Wu,{className:"space-y-4",children:[(0,l.jsx)("p",{children:W.description}),(0,l.jsx)(u.w,{}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h4",{className:"font-semibold mb-2",children:"Features"}),W.features.map(e=>(0,l.jsxs)("div",{className:"p-2 border-b",children:[(0,l.jsx)("p",{className:"font-bold",children:e.title}),(0,l.jsx)("p",{className:"text-sm text-muted-foreground",children:e.description}),e.encounterIds.map(e=>{var s;return(0,l.jsxs)(c.$,{variant:"link",className:"p-0 h-auto text-accent",onClick:()=>N(e),children:[(0,l.jsx)(ed.A,{className:"h-4 w-4 mr-1"}),null==j||null==(s=j.encounters.get(e))?void 0:s.name]},e)}),e.treasureIds.map(e=>{var s;return(0,l.jsxs)("p",{className:"text-sm flex items-center gap-1",children:[(0,l.jsx)(eu.A,{className:"h-4 w-4"}),null==j||null==(s=j.treasures.get(e))?void 0:s.name]},e)}),e.alchemicalItemIds.map(e=>{var s;return(0,l.jsxs)("p",{className:"text-sm flex items-center gap-1",children:[(0,l.jsx)(eh.A,{className:"h-4 w-4"}),null==j||null==(s=j.alchemicalItems.get(e))?void 0:s.name]},e)})]},e.id))]})]})]}):null})]}),(0,l.jsx)("div",{className:"flex-1 relative overflow-hidden bg-gradient-to-br from-background to-muted/20",children:(0,l.jsxs)(ee.Gc,{nodes:S,edges:A,onNodesChange:I,onEdgesChange:M,onNodeClick:X,onPaneClick:()=>X(null,null),fitView:!0,nodesDraggable:!0,nodeTypes:ef,edgeTypes:ep,connectionLineComponent:ej,children:[(0,l.jsx)(es.H,{}),(0,l.jsx)(et.o,{pannable:!0,zoomable:!0,nodeStrokeWidth:3,nodeColor:e=>{var s;return(null==(s=e.style)?void 0:s.background)||"#fff"}}),(0,l.jsx)(el.V,{variant:"dots",gap:16,size:1})]})})]})]})}function ew(e){return(0,l.jsx)(ee.Ln,{children:(0,l.jsx)(eb,{...e})})}function eC(e){let{selectedId:s}=e,[t,o]=(0,n.useState)("preparation"),[c,d]=(0,n.useState)(s||null),[u,x]=(0,n.useState)(null),[m,j]=(0,n.useState)(!1),[g,p]=(0,n.useState)(0),[f,v]=(0,n.useState)(""),[y,b]=(0,n.useState)(""),[w,C]=(0,n.useState)("name"),[k,S]=(0,n.useState)("asc"),[R,I]=(0,n.useState)(!1),z=(0,J.a)(),[A,T]=(0,n.useState)("list");(0,n.useEffect)(()=>{I(!0),s&&(d(s),z&&T("editor"))},[s,z]);let M={searchTerm:f,tagFilter:y,sortBy:w,sortOrder:k},D={setSearchTerm:v,setTagFilter:b,setSortBy:C,setSortOrder:S},E=()=>{v(""),b(""),C("name"),S("asc")},$=()=>p(e=>e+1),V=e=>{d(e),j(!1),z&&T("editor")},B=()=>{d(null),j(!0),z&&T("editor")},F=e=>{$(),d(e),j(!1),z&&T("editor")},L=()=>{$(),d(null),j(!1),z&&T("list")},O=()=>{m&&(j(!1),d(null),z&&T("list"))},{toast:X}=(0,h.dj)(),Z=async e=>{try{let s=await (0,i.RT)(e);s?(x(s),o("live")):X({variant:"destructive",title:"Error",description:"Could not find dungeon to run."})}catch(e){X({variant:"destructive",title:"Error",description:"Failed to load dungeon data."})}};return"live"===t&&u?(0,l.jsx)(ew,{dungeon:u,onEndDungeon:()=>{x(null),o("preparation")}}):R?z?(0,l.jsx)(r.A,{children:(0,l.jsx)("div",{className:"h-full w-full",children:"list"===A?(0,l.jsx)(N,{onSelectDungeon:V,onNewDungeon:B,selectedDungeonId:c,dataVersion:g,filters:M,setFilters:D,onClearFilters:E}):(0,l.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,l.jsx)("div",{className:"p-4 sm:p-6",children:(0,l.jsx)(Q,{dungeonId:c,isCreatingNew:m,onSaveSuccess:F,onDeleteSuccess:L,onEditCancel:O,onRunDungeon:Z,onBack:()=>{T("list"),d(null),j(!1)},dataVersion:g},null!=c?c:m?"new":"placeholder")})})})}):(0,l.jsx)(a.SidebarProvider,{children:(0,l.jsx)(r.A,{children:(0,l.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,l.jsx)(a.Bx,{style:{"--sidebar-width":"380px"},children:(0,l.jsx)(N,{onSelectDungeon:V,onNewDungeon:B,selectedDungeonId:c,dataVersion:g,filters:M,setFilters:D,onClearFilters:E})}),(0,l.jsx)(a.sF,{className:"flex-1 overflow-y-auto",children:(0,l.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,l.jsx)(Q,{dungeonId:c,isCreatingNew:m,onSaveSuccess:F,onDeleteSuccess:L,onEditCancel:O,onRunDungeon:Z,dataVersion:g},null!=c?c:m?"new":"placeholder")})})]})})}):null}}}]);