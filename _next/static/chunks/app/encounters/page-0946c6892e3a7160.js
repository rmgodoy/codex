(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[729],{4580:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>X});var n=t(95155),l=t(12115),a=t(62709),r=t(20031),i=t(87189),c=t(3585),o=t(62523),d=t(30285),u=t(66424),x=t(22346),m=t(87481),h=t(34301),p=t(75074),j=t(20203),g=t(73926),v=t(85057),f=t(59409),y=t(90648);function N(e){let{onSelectEncounter:s,onNewEncounter:t,selectedEncounterId:a,dataVersion:r,filters:N,setFilters:b,onClearFilters:w}=e,[T,C]=(0,l.useState)([]),[k,R]=(0,l.useState)([]),[S,A]=(0,l.useState)(!0),{toast:M}=(0,m.dj)();(0,l.useEffect)(()=>{(async()=>{A(!0);try{let[e,s]=await Promise.all([(0,i.eS)(),(0,c.MY)()]);C(e),R(s)}catch(e){console.error("Error fetching encounters:",e),M({variant:"destructive",title:"Error",description:"Could not fetch encounters from database."})}finally{A(!1)}})()},[r,M]);let E=(0,l.useMemo)(()=>{let e=T.map(e=>{if(e.encounterTableId){let s=k.find(s=>s.id===e.encounterTableId);return{...e,totalTR:(null==s?void 0:s.totalTR)||e.totalTR||0}}return{...e,totalTR:e.totalTR||0}}).filter(e=>{let s=e.name.toLowerCase().includes(N.searchTerm.toLowerCase()),t=!0,n=N.tagFilter.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);n.length>0&&(t=!!e.tags&&n.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))));let l=!0;return N.minTR&&!isNaN(parseInt(N.minTR))&&(l=l&&e.totalTR>=parseInt(N.minTR,10)),N.maxTR&&!isNaN(parseInt(N.maxTR))&&(l=l&&e.totalTR<=parseInt(N.maxTR,10)),s&&t&&l}).sort((e,s)=>{if("TR"===N.sortBy){var t,n;let l=(null!=(t=e.totalTR)?t:0)-(null!=(n=s.totalTR)?n:0);if(0!==l)return l}return e.name.localeCompare(s.name)});return"desc"===N.sortOrder&&e.reverse(),e},[T,k,N]);return(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsxs)("div",{className:"p-4 space-y-4",children:[(0,n.jsxs)(d.$,{onClick:t,className:"w-full",children:[(0,n.jsx)(h.A,{})," New Encounter"]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(p.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,n.jsx)(o.p,{placeholder:"Search encounters...",value:N.searchTerm,onChange:e=>b.setSearchTerm(e.target.value),className:"pl-9"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)(v.J,{children:"Filter"}),(0,n.jsx)(d.$,{variant:"ghost",size:"sm",onClick:w,className:"text-xs h-auto p-1",children:"Clear"})]}),(0,n.jsx)(y.F,{value:N.tagFilter?N.tagFilter.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>b.setTagFilter(e.join(",")),placeholder:"Tags (e.g. boss-fight)",tagSource:"encounter"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(o.p,{placeholder:"Min TR",type:"number",value:N.minTR,onChange:e=>b.setMinTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),(0,n.jsx)(o.p,{placeholder:"Max TR",type:"number",value:N.maxTR,onChange:e=>b.setMaxTR(e.target.value),className:"[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)(v.J,{children:"Sort by"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)(f.l6,{value:N.sortBy,onValueChange:e=>b.setSortBy(e),children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Sort by"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"name",children:"Name"}),(0,n.jsx)(f.eb,{value:"TR",children:"TR"})]})]}),(0,n.jsxs)(d.$,{variant:"ghost",size:"icon",onClick:()=>b.setSortOrder(e=>"asc"===e?"desc":"asc"),children:["asc"===N.sortOrder?(0,n.jsx)(j.A,{className:"h-4 w-4"}):(0,n.jsx)(g.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Toggle sort order"})]})]})]})]}),(0,n.jsx)(x.w,{}),(0,n.jsx)(u.F,{className:"flex-1",children:(0,n.jsx)("div",{className:"p-4",children:S?(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"Loading encounters..."}):E.length>0?(0,n.jsx)("ul",{className:"space-y-1",children:E.map(e=>(0,n.jsx)("li",{children:(0,n.jsxs)("button",{onClick:()=>s(e.id),className:"w-full text-left p-2 rounded-md transition-colors ".concat(a===e.id?"bg-primary text-primary-foreground":"hover:bg-accent/50"),children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs opacity-70",children:["(TR ",e.totalTR,")"]})]})},e.id))}):(0,n.jsx)("p",{className:"text-muted-foreground text-center",children:"No encounters found."})})})]})}var b=t(62177),w=t(90221),T=t(55594),C=t(6535),k=t(44218),R=t(76762),S=t(66695),A=t(88539),M=t(90010),E=t(17759),I=t(73503),z=t(12543),F=t(21816),B=t(18763),q=t(91721),L=t(77223),$=t(25318),V=t(53054),G=t(13896),J=t(68856),O=t(54165),D=t(26126),P=t(47906);let Z=T.z.object({id:T.z.string(),name:T.z.string().min(1,"Player name is required")}),U=T.z.object({monsterId:T.z.string(),quantity:T.z.coerce.number().min(1,"Quantity must be at least 1")}),H=T.z.object({name:T.z.string().min(1,"Encounter name is required"),sceneDescription:T.z.string().optional(),gmNotes:T.z.string().optional(),players:T.z.array(Z),monsterGroups:T.z.array(U),tags:T.z.array(T.z.string()).optional(),totalTR:T.z.coerce.number().optional(),encounterTableId:T.z.string().optional()}),_=["Normal","Underling","Paragon","Tyrant"],W=e=>{let{onAddCreatures:s}=e,[t,a]=(0,l.useState)(!1),[r,i]=(0,l.useState)([]),[c,x]=(0,l.useState)(new Map),[m,h]=(0,l.useState)(""),[p,j]=(0,l.useState)(""),[g,v]=(0,l.useState)(""),[N,b]=(0,l.useState)(""),[w,T]=(0,l.useState)(""),[k,S]=(0,l.useState)("all"),[A,M]=(0,l.useState)("all"),[E,z]=(0,l.useState)("");(0,l.useEffect)(()=>{t&&(0,C.OG)().then(i)},[t]);let F=(0,l.useMemo)(()=>r.filter(e=>{let s=e.name.toLowerCase().includes(m.toLowerCase()),t="all"===k||e.role===k,n="all"===A||e.template===A,l=!0;p&&!isNaN(parseInt(p))&&(l=l&&e.TR>=parseInt(p,10)),g&&!isNaN(parseInt(g))&&(l=l&&e.TR<=parseInt(g,10));let a=!0;N&&!isNaN(parseInt(N))&&(a=a&&e.level>=parseInt(N,10)),w&&!isNaN(parseInt(w))&&(a=a&&e.level<=parseInt(w,10));let r=!0;if(E){let s=E.toLowerCase().split(",").map(e=>e.trim()).filter(Boolean);s.length>0&&(r=!!e.tags&&e.tags.length>0&&s.every(s=>e.tags.some(e=>e.toLowerCase().includes(s))))}return s&&t&&n&&l&&a&&r}),[r,m,p,g,N,w,k,A,E]),B=(e,s)=>{s>=1?x(t=>{let n=new Map(t);return n.set(e,s),n}):x(s=>{let t=new Map(s);return t.delete(e),t})},q=async()=>{let e=Array.from(c.entries()).map(e=>{let[s,t]=e,n=r.find(e=>e.id===s);return{id:s,name:n.name,quantity:t}});e.length>0&&s(e),a(!1),x(new Map),h(""),b(""),T(""),j(""),v(""),S("all"),M("all"),z("")};return(0,n.jsxs)(O.lG,{open:t,onOpenChange:a,children:[(0,n.jsx)(O.zM,{asChild:!0,children:(0,n.jsxs)(d.$,{type:"button",size:"sm",variant:"outline",children:[(0,n.jsx)(I.A,{className:"h-4 w-4 mr-2"})," Add Monster"]})}),(0,n.jsxs)(O.Cf,{className:"max-w-lg h-[70vh] flex flex-col",children:[(0,n.jsx)(O.c7,{children:(0,n.jsx)(O.L3,{children:"Select Monsters from Bestiary"})}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(o.p,{placeholder:"Search monsters...",value:m,onChange:e=>h(e.target.value),className:"shrink-0"}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsxs)(f.l6,{value:k,onValueChange:S,children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Filter by role"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"all",children:"All Roles"}),R.gg.map(e=>(0,n.jsx)(f.eb,{value:e,children:e},e))]})]}),(0,n.jsxs)(f.l6,{value:A,onValueChange:M,children:[(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Filter by template"})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"all",children:"All Templates"}),_.map(e=>(0,n.jsx)(f.eb,{value:e,children:e},e))]})]})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(o.p,{placeholder:"Min Lvl",type:"number",value:N,onChange:e=>b(e.target.value)}),(0,n.jsx)(o.p,{placeholder:"Max Lvl",type:"number",value:w,onChange:e=>T(e.target.value)})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,n.jsx)(o.p,{placeholder:"Min TR",type:"number",value:p,onChange:e=>j(e.target.value)}),(0,n.jsx)(o.p,{placeholder:"Max TR",type:"number",value:g,onChange:e=>v(e.target.value)})]}),(0,n.jsx)(y.F,{value:E?E.split(",").map(e=>e.trim()).filter(Boolean):[],onChange:e=>z(e.join(",")),placeholder:"Filter by tags...",tagSource:"creature"})]}),(0,n.jsx)(u.F,{className:"flex-1 border rounded-md p-2 mt-2",children:(0,n.jsx)("div",{className:"space-y-1",children:F.length>0?F.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-md",children:[(0,n.jsx)(o.p,{type:"number",min:"0",value:c.get(e.id)||0,onChange:s=>B(e.id,parseInt(s.target.value)||0),className:"w-20 h-8"}),(0,n.jsx)("label",{htmlFor:"creature-".concat(e.id),className:"flex-1",children:(0,n.jsxs)("p",{className:"font-semibold",children:[e.name," ",(0,n.jsxs)("span",{className:"text-xs text-muted-foreground",children:["(Lvl ",e.level,", TR ",e.TR,")"]})]})})]},e.id)):(0,n.jsx)("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No monsters found."})})}),(0,n.jsxs)("div",{className:"flex justify-end gap-2 pt-4 shrink-0",children:[(0,n.jsx)(d.$,{variant:"ghost",onClick:()=>a(!1),children:"Cancel"}),(0,n.jsx)(d.$,{onClick:q,disabled:0===c.size,children:"Add Selected"})]})]})]})},Y={name:"",sceneDescription:"",gmNotes:"",players:[],monsterGroups:[],tags:[],totalTR:0,encounterTableId:"none"};function Q(e){let{encounterId:s,isCreatingNew:t,onEncounterSaveSuccess:a,onEncounterDeleteSuccess:r,onEditCancel:u,onRunEncounter:h,onFilterByClick:p,onBack:j,dataVersion:g}=e,{toast:N}=(0,m.dj)(),[T,R]=(0,l.useState)(t),[O,Z]=(0,l.useState)(!t&&!!s),[U,_]=(0,l.useState)(null),Q=(0,P.a)(),[K,X]=(0,l.useState)({monsters:new Map}),[ee,es]=(0,l.useState)([]),[et,en]=(0,l.useState)([]),el=(0,b.mN)({resolver:(0,w.u)(H),defaultValues:Y}),{fields:ea,append:er,remove:ei}=(0,b.jz)({control:el.control,name:"players"}),{fields:ec,append:eo,remove:ed,update:eu,replace:ex}=(0,b.jz)({control:el.control,name:"monsterGroups"}),em=(0,l.useMemo)(()=>new Map(ee.map(e=>[e.id,e.TR])),[ee]),eh=el.watch("encounterTableId"),ep=JSON.stringify(el.watch("monsterGroups"));(0,l.useEffect)(()=>{if(eh&&"none"!==eh){let e=et.find(e=>e.id===eh);e&&e.totalTR!==el.getValues("totalTR")&&el.setValue("totalTR",e.totalTR),el.getValues("monsterGroups").length>0&&ex([])}else{let e=JSON.parse(ep).reduce((e,s)=>e+(em.get(s.monsterId)||0)*s.quantity,0);e!==el.getValues("totalTR")&&el.setValue("totalTR",e)}},[ep,eh,et,em,el,ex]);let ej=(0,l.useCallback)(async()=>{if(t){el.reset(Y),_(null),R(!0),Z(!1),en(await (0,c.MY)());return}if(!s){R(!1),Z(!1),_(null);return}Z(!0),R(!1);try{let[e,t,n]=await Promise.all([(0,i.eq)(s),(0,c.MY)(),(0,C.OG)()]);if(en(t),es(n),e){let s,l=e.totalTR||0;e.encounterTableId&&(s=t.find(s=>s.id===e.encounterTableId))&&(l=s.totalTR);let a={...e,totalTR:l};_(a);let r={...e,tags:e.tags||[],encounterTableId:e.encounterTableId||"none",totalTR:l};el.reset(r);let i=(e.monsterGroups||[]).map(e=>e.monsterId),c=n.filter(e=>i.includes(e.id)),o=new Map(c.map(e=>[e.id,e]));X({monsters:o,table:s})}else _(null)}catch(e){N({variant:"destructive",title:"Error",description:"Could not load encounter data."})}finally{Z(!1)}},[s,t,el,N]);(0,l.useEffect)(()=>(ej(),window.addEventListener("focus",ej),()=>window.removeEventListener("focus",ej)),[ej,g]);let eg=(0,l.useMemo)(()=>new Map(ee.map(e=>[e.id,e])),[ee]),ev=()=>{if(t)u();else if(U){let e={...U,tags:U.tags||[],encounterTableId:U.encounterTableId||"none"};el.reset(e),R(!1)}},ef=async e=>{try{let n,l="none"===e.encounterTableId?void 0:e.encounterTableId,r={...e,tags:e.tags||[],totalTR:e.totalTR,encounterTableId:l,monsterGroups:l?[]:e.monsterGroups},c=e.tags||[];if(c.length>0&&await (0,k.JE)(c,"encounter"),t)n=await (0,i.Fs)(r),N({title:"Encounter Created!",description:"".concat(e.name," has been saved.")});else{if(!s)return;n=s,await (0,i.H$)({...r,id:s}),N({title:"Save Successful",description:"".concat(e.name," has been updated.")})}a(n),R(!1)}catch(e){N({variant:"destructive",title:"Save Failed",description:"Could not save changes."})}},ey=async()=>{if(s)try{await (0,i.ZJ)(s),N({title:"Encounter Deleted",description:"The encounter has been removed."}),r()}catch(e){N({variant:"destructive",title:"Deletion Failed",description:"Could not delete the encounter."})}};if(O)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(S.Zp,{children:[(0,n.jsx)(S.aR,{children:(0,n.jsx)(J.E,{className:"h-8 w-48"})}),(0,n.jsx)(S.Wu,{children:(0,n.jsx)(J.E,{className:"h-40 w-full"})})]})});if(!s&&!t)return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(S.Zp,{className:"h-full flex items-center justify-center min-h-[300px]",children:(0,n.jsxs)(S.Wu,{className:"text-center pt-6",children:[(0,n.jsx)("p",{className:"text-xl text-muted-foreground",children:"Select an encounter to view"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"or create a new one."})]})})});if(!T&&U){var eN;return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsxs)(S.Zp,{children:[(0,n.jsx)(S.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row items-start justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[Q&&j&&(0,n.jsx)(d.$,{variant:"ghost",size:"icon",onClick:j,className:"shrink-0 -ml-2 -mt-1",children:(0,n.jsx)(z.A,{className:"h-5 w-5"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(S.ZB,{className:"text-3xl font-bold",children:U.name}),(0,n.jsx)(S.BT,{children:(0,n.jsxs)("button",{onClick:e=>p({minTR:U.totalTR||0,maxTR:U.totalTR||0},e),className:"hover:underline p-0 bg-transparent text-inherit text-sm",children:[(0,n.jsx)("span",{className:"hidden sm:inline",children:"Total Threat Rating (TR): "}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"TR: "}),U.totalTR||0]})})]})]}),(0,n.jsxs)("div",{className:"flex flex-wrap justify-end gap-2",children:[(0,n.jsxs)(d.$,{variant:"default",size:"sm",onClick:()=>h(U.id),children:[(0,n.jsx)(F.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Run Encounter"}),(0,n.jsx)("span",{className:"inline sm:hidden",children:"Run"})]}),(0,n.jsxs)(d.$,{variant:"outline",size:"sm",onClick:()=>R(!0),children:[(0,n.jsx)(B.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"hidden sm:inline",children:"Edit"})]})]})]})}),(0,n.jsx)(S.Wu,{children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Scene"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:U.sceneDescription||"No scene description."})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"GM Notes"}),(0,n.jsx)("p",{className:"text-foreground/80 whitespace-pre-wrap",children:U.gmNotes||"No GM notes."})]}),(0,n.jsx)(x.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-2",children:"Combatants"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("h4",{className:"font-semibold text-muted-foreground",children:["Players (",(U.players||[]).length,")"]}),(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(U.players||[]).map(e=>(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)(q.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("span",{className:"font-semibold flex-1",children:e.name})]},e.id))}),(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),U.encounterTableId?(0,n.jsxs)("div",{className:"p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsxs)("p",{className:"font-semibold",children:["From Encounter Table: ",(0,n.jsx)("span",{className:"text-accent",children:(null==(eN=K.table)?void 0:eN.name)||"..."})]}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Monsters will be rolled at the start of combat."})]}):(0,n.jsx)("ul",{className:"space-y-2 pl-4",children:(U.monsterGroups||[]).map(e=>{let s=K.monsters.get(e.monsterId);return(0,n.jsxs)("li",{className:"flex items-center gap-4 p-2 bg-card-foreground/5 rounded-md",children:[(0,n.jsx)(I.A,{className:"h-5 w-5 text-accent"}),(0,n.jsx)("span",{className:"font-semibold flex-1",children:(null==s?void 0:s.name)||"Unknown Monster"}),(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["x ",e.quantity]}),s&&(0,n.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Lvl ",s.level," ",s.role]})]},e.monsterId)})})]})]}),U.tags&&U.tags.length>0&&(0,n.jsx)("div",{className:"mt-4 pt-3 border-t border-border/50",children:(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:U.tags.map(e=>(0,n.jsx)("button",{onClick:s=>p({tagFilter:e},s),className:"bg-transparent border-none p-0 m-0",children:(0,n.jsx)(D.E,{variant:"secondary",className:"cursor-pointer hover:bg-secondary/80",children:e})},e))})})]})}),(0,n.jsx)(S.wL,{children:(0,n.jsxs)(M.Lt,{children:[(0,n.jsx)(M.tv,{asChild:!0,children:(0,n.jsx)(d.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(M.EO,{children:[(0,n.jsxs)(M.wd,{children:[(0,n.jsx)(M.r7,{children:"Are you sure?"}),(0,n.jsxs)(M.$v,{children:['This will permanently delete "',U.name,'". This action cannot be undone.']})]}),(0,n.jsxs)(M.ck,{children:[(0,n.jsx)(M.Zr,{children:"Cancel"}),(0,n.jsx)(M.Rx,{onClick:ey,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]})})]})})}return(0,n.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,n.jsx)(S.Zp,{children:(0,n.jsx)(E.lV,{...el,children:(0,n.jsxs)("form",{onSubmit:el.handleSubmit(ef),className:"space-y-6",children:[(0,n.jsx)(S.aR,{children:(0,n.jsxs)("div",{className:"flex flex-row justify-between items-start",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[Q&&j&&(0,n.jsx)(d.$,{type:"button",variant:"ghost",size:"icon",onClick:u,className:"shrink-0 -ml-2",children:(0,n.jsx)(z.A,{className:"h-5 w-5"})}),(0,n.jsx)("div",{children:(0,n.jsx)(S.ZB,{children:t?Q?"New Encounter":"Create a New Encounter":"Editing: ".concat(el.getValues("name")||"...")})})]}),!Q&&(0,n.jsx)(d.$,{type:"button",variant:"ghost",size:"icon",onClick:ev,className:"text-muted-foreground hover:text-foreground",children:(0,n.jsx)($.A,{className:"h-5 w-5"})})]})}),(0,n.jsxs)(S.Wu,{className:"space-y-6",children:[(0,n.jsx)(E.zB,{name:"name",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Encounter Name"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(o.p,{...s})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(E.zB,{name:"tags",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsxs)(E.lR,{className:"flex items-center gap-2",children:[(0,n.jsx)(V.A,{className:"h-4 w-4 text-accent"}),"Tags"]}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(y.F,{value:s.value||[],onChange:s.onChange,placeholder:"Add tags...",tagSource:"encounter"})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(E.zB,{name:"sceneDescription",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Scene Description"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(A.T,{...s,rows:4})})]})}}),(0,n.jsx)(E.zB,{name:"gmNotes",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"GM Notes (Private)"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(A.T,{...s,rows:4})})]})}}),(0,n.jsx)(x.w,{}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary-foreground mb-4",children:"Combatants"}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Players"}),(0,n.jsxs)(d.$,{type:"button",size:"sm",variant:"outline",onClick:()=>{er({id:crypto.randomUUID(),name:"Player ".concat(ea.length+1)})},children:[(0,n.jsx)(G.A,{className:"h-4 w-4 mr-2"})," Add Player"]})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[ea.map((e,s)=>(0,n.jsxs)("div",{className:"flex items-center gap-2 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)(E.zB,{name:"players.".concat(s,".name"),control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex-1",children:[(0,n.jsx)(E.MJ,{children:(0,n.jsx)(o.p,{...s})}),(0,n.jsx)(E.C5,{})]})}}),(0,n.jsx)(d.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>ei(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})]},e.id)),0===ea.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No players added."})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"font-semibold text-muted-foreground",children:"Monsters"}),(0,n.jsx)(E.zB,{name:"totalTR",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(E.lR,{children:"Total TR:"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(o.p,{type:"number",...s,readOnly:!0,className:"w-20 bg-muted border-none"})})]})}})]}),(0,n.jsx)(E.zB,{name:"encounterTableId",control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{children:[(0,n.jsx)(E.lR,{children:"Encounter Table (Optional)"}),(0,n.jsxs)(f.l6,{onValueChange:e=>s.onChange(e),value:s.value||"none",children:[(0,n.jsx)(E.MJ,{children:(0,n.jsx)(f.bq,{children:(0,n.jsx)(f.yv,{placeholder:"Select a table to roll from"})})}),(0,n.jsxs)(f.gC,{children:[(0,n.jsx)(f.eb,{value:"none",children:"None (Manual Selection)"}),et.map(e=>(0,n.jsx)(f.eb,{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)(E.C5,{})]})}}),(!eh||"none"===eh)&&(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("div",{className:"flex justify-end items-center mb-2",children:(0,n.jsx)(W,{onAddCreatures:e=>{e.forEach(e=>{let{id:s,quantity:t}=e,n=ec.findIndex(e=>e.monsterId===s);if(n>-1){let e=ec[n];eu(n,{...e,quantity:e.quantity+t})}else eo({monsterId:s,quantity:t})})}})}),(0,n.jsxs)("div",{className:"space-y-2",children:[ec.map((e,s)=>{let t=eg.get(e.monsterId);return(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-card-foreground/5",children:[(0,n.jsx)("p",{className:"flex-1 font-semibold",children:(null==t?void 0:t.name)||"Unknown Monster"}),(0,n.jsx)(E.zB,{name:"monsterGroups.".concat(s,".quantity"),control:el.control,render:e=>{let{field:s}=e;return(0,n.jsxs)(E.eI,{className:"flex items-center gap-2",children:[(0,n.jsx)(v.J,{children:"Qty"}),(0,n.jsx)(E.MJ,{children:(0,n.jsx)(o.p,{type:"number",min:"1",...s,className:"w-20 h-8"})})]})}}),(0,n.jsx)(d.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>ed(s),className:"text-muted-foreground hover:text-destructive shrink-0",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})]},e.id)}),0===ec.length&&(0,n.jsx)("p",{className:"text-muted-foreground text-center text-sm py-2",children:"No monsters added."})]})]})]})]})]}),(0,n.jsxs)(S.wL,{className:"flex items-center gap-2",children:[!t&&(0,n.jsxs)(M.Lt,{children:[(0,n.jsx)(M.tv,{asChild:!0,children:(0,n.jsx)(d.$,{type:"button",variant:"destructive",size:"sm",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(M.EO,{children:[(0,n.jsxs)(M.wd,{children:[(0,n.jsx)(M.r7,{children:"Are you sure?"}),(0,n.jsxs)(M.$v,{children:['This will permanently delete "',el.getValues("name"),'".']})]}),(0,n.jsxs)(M.ck,{children:[(0,n.jsx)(M.Zr,{children:"Cancel"}),(0,n.jsx)(M.Rx,{onClick:ey,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})]}),(0,n.jsx)("div",{className:"flex-grow"}),!Q&&(0,n.jsx)(d.$,{type:"button",variant:"outline",onClick:ev,children:"Cancel"}),(0,n.jsx)(d.$,{type:"submit",children:t?"Create Encounter":"Save Changes"})]})]})})})})}var K=t(73336);function X(){let[e,s]=(0,l.useState)("preparation"),[t,c]=(0,l.useState)(null),[o,d]=(0,l.useState)(null),[u,x]=(0,l.useState)(!1),[h,p]=(0,l.useState)(0),[j,g]=(0,l.useState)(""),[v,f]=(0,l.useState)(""),[y,b]=(0,l.useState)(""),[w,T]=(0,l.useState)(""),[C,k]=(0,l.useState)("name"),[R,S]=(0,l.useState)("asc"),[A,M]=(0,l.useState)(!1),E=(0,P.a)(),[I,z]=(0,l.useState)("list");(0,l.useEffect)(()=>{M(!0)},[]);let F={searchTerm:j,tagFilter:v,minTR:y,maxTR:w,sortBy:C,sortOrder:R},B={setSearchTerm:g,setTagFilter:f,setMinTR:b,setMaxTR:T,setSortBy:k,setSortOrder:S},q=(e,s)=>{s.shiftKey?(void 0!==e.minTR&&b(String(e.minTR)),void 0!==e.maxTR&&T(String(e.maxTR)),e.tagFilter&&f(s=>s?s.split(",").map(e=>e.trim()).includes(e.tagFilter)?s:"".concat(s,", ").concat(e.tagFilter):e.tagFilter)):(b(void 0!==e.minTR?String(e.minTR):""),T(void 0!==e.maxTR?String(e.maxTR):""),f(e.tagFilter||""))},L=()=>{g(""),f(""),b(""),T(""),k("name"),S("asc")},$=()=>p(e=>e+1),V=e=>{c(e),x(!1),E&&z("editor")},G=()=>{c(null),x(!0),E&&z("editor")},J=e=>{$(),c(e),x(!1),E&&z("editor")},O=()=>{$(),c(null),x(!1),E&&z("list")},D=()=>{u&&(x(!1),c(null),E&&z("list"))},{toast:Z}=(0,m.dj)(),U=async e=>{try{let t=await (0,i.eq)(e);t?(d(t),s("live")):Z({variant:"destructive",title:"Error",description:"Could not find encounter to run."})}catch(e){Z({variant:"destructive",title:"Error",description:"Failed to load encounter data."})}};return"live"===e&&o?(0,n.jsx)(K.A,{encounter:o,onEndEncounter:()=>{d(null),s("preparation")}}):A?E?(0,n.jsx)(a.A,{showSidebarTrigger:!1,children:(0,n.jsx)("div",{className:"h-full w-full",children:"list"===I?(0,n.jsx)(N,{onSelectEncounter:V,onNewEncounter:G,selectedEncounterId:t,dataVersion:h,filters:F,setFilters:B,onClearFilters:L}):(0,n.jsx)("div",{className:"h-full w-full overflow-y-auto",children:(0,n.jsx)("div",{className:"p-4 sm:p-6",children:(0,n.jsx)(Q,{encounterId:t,isCreatingNew:u,onEncounterSaveSuccess:J,onEncounterDeleteSuccess:O,onEditCancel:D,onRunEncounter:U,onFilterByClick:q,onBack:()=>{z("list"),c(null),x(!1)},dataVersion:h},null!=t?t:u?"new":"placeholder")})})})}):(0,n.jsx)(r.GB,{children:(0,n.jsx)(a.A,{children:(0,n.jsxs)("div",{className:"flex w-full h-full overflow-hidden",children:[(0,n.jsx)(r.Bx,{style:{"--sidebar-width":"380px"},children:(0,n.jsx)(N,{onSelectEncounter:V,onNewEncounter:G,selectedEncounterId:t,dataVersion:h,filters:F,setFilters:B,onClearFilters:L})}),(0,n.jsx)(r.sF,{className:"flex-1 overflow-y-auto",children:(0,n.jsx)("div",{className:"bg-background/50 p-4 sm:p-6 md:p-8 w-full",children:(0,n.jsx)(Q,{encounterId:t,isCreatingNew:u,onEncounterSaveSuccess:J,onEncounterDeleteSuccess:O,onEditCancel:D,onRunEncounter:U,onFilterByClick:q,dataVersion:h},null!=t?t:u?"new":"placeholder")})})]})})}):null}},12543:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},13896:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]])},20203:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]])},21816:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("Swords",[["polyline",{points:"14.5 17.5 3 6 3 3 6 3 17.5 14.5",key:"1hfsw2"}],["line",{x1:"13",x2:"19",y1:"19",y2:"13",key:"1vrmhu"}],["line",{x1:"16",x2:"20",y1:"16",y2:"20",key:"1bron3"}],["line",{x1:"19",x2:"21",y1:"21",y2:"19",key:"13pww6"}],["polyline",{points:"14.5 6.5 18 3 21 3 21 6 17.5 9.5",key:"hbey2j"}],["line",{x1:"5",x2:"9",y1:"14",y2:"18",key:"1hf58s"}],["line",{x1:"7",x2:"4",y1:"17",y2:"20",key:"pidxm4"}],["line",{x1:"3",x2:"5",y1:"19",y2:"21",key:"1pehsh"}]])},31949:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},34301:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]])},53054:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]])},56612:(e,s,t)=>{Promise.resolve().then(t.bind(t,4580))},68098:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]])},73503:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]])},73926:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]])},75074:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])},91721:(e,s,t)=>{"use strict";t.d(s,{A:()=>n});let n=(0,t(40157).A)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])}},e=>{var s=s=>e(e.s=s);e.O(0,[222,194,160,49,841,347,516,806,762,441,684,358],()=>s(56612)),_N_E=e.O()}]);